import{r as j,c as V,p as L,s as J,o as w,w as F,f as d,l as I,e as k,h as X,k as A,t as T,F as D,i as z,n as P,C as B,K as M}from"./vendor-DIThaKhE.js";import{_ as Y}from"./BaseModal-CYDQdZr3.js";import{c as x,u as K}from"./index-FleWdOur.js";const N={stations:{key:"stations",name:"Stations",description:"All station information",adminOnly:!1},platforms:{key:"platforms",name:"Platforms",description:"Platform configurations and metadata",adminOnly:!1},instruments:{key:"instruments",name:"Instruments",description:"Instrument specifications and status",adminOnly:!1},rois:{key:"rois",name:"ROIs",description:"Region of Interest definitions",adminOnly:!1},full:{key:"full",name:"Full Export",description:"Complete data export (all entities)",adminOnly:!0}},O={csv:{key:"csv",name:"CSV",mimeType:"text/csv",extension:".csv"},json:{key:"json",name:"JSON",mimeType:"application/json",extension:".json"}};function W(){const y=j(!1),v=j(null);function f(m,a,n=null){var u;const c=new Date().toISOString().split("T")[0],l=n?`_${n}`:"",s=((u=O[a])==null?void 0:u.extension)||".txt";return`sites_spectral${l}_${m}_${c}${s}`}function h(m,a=null){if(!m||m.length===0)return"";const n=a||Object.keys(m[0]);let c=n.join(",")+`
`;return m.forEach(l=>{const s=n.map(u=>{const _=l[u];if(_==null)return"";const o=String(_);return o.includes(",")||o.includes('"')||o.includes(`
`)?'"'+o.replace(/"/g,'""')+'"':o});c+=s.join(",")+`
`}),c}function b(m){return JSON.stringify(m,null,2)}function g(m,a,n){const c=new Blob([m],{type:n}),l=URL.createObjectURL(c),s=document.createElement("a");s.href=l,s.download=a,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(l)}async function S(m={}){var c;const{format:a="csv",stationId:n=null}=m;y.value=!0,v.value=null;try{const l=n?`/stations/${n}`:"/stations",s=await x.get(l);if(!s.success)throw new Error(s.error||"Failed to fetch stations");const u=n?[s.data]:s.data||[],_=n?(c=u[0])==null?void 0:c.acronym:"all",o=a==="json"?b(u):h(u.map(t=>({id:t.id,acronym:t.acronym,display_name:t.display_name,normalized_name:t.normalized_name,status:t.status,country:t.country,latitude:t.latitude,longitude:t.longitude,elevation_m:t.elevation_m,description:t.description,platform_count:t.platform_count,instrument_count:t.instrument_count,created_at:t.created_at,updated_at:t.updated_at}))),e=f("stations",a,_),i=O[a].mimeType;return g(o,e,i),!0}catch(l){return v.value=l.message,!1}finally{y.value=!1}}async function E(m={}){const{format:a="csv",stationId:n=null,stationAcronym:c=null}=m;y.value=!0,v.value=null;try{let l="/platforms";n&&(l=`/stations/${n}/platforms`);const s=await x.get(l);if(!s.success)throw new Error(s.error||"Failed to fetch platforms");const u=s.data||[],_=c||(n?"station":"all"),o=a==="json"?b(u):h(u.map(t=>({id:t.id,normalized_name:t.normalized_name,display_name:t.display_name,platform_type:t.platform_type,ecosystem_code:t.ecosystem_code,mount_type_code:t.mount_type_code||t.location_code,status:t.status,latitude:t.latitude,longitude:t.longitude,platform_height_m:t.platform_height_m,station_id:t.station_id,station_acronym:t.station_acronym,instrument_count:t.instrument_count,deployment_date:t.deployment_date,description:t.description,created_at:t.created_at,updated_at:t.updated_at}))),e=f("platforms",a,_),i=O[a].mimeType;return g(o,e,i),!0}catch(l){return v.value=l.message,!1}finally{y.value=!1}}async function R(m={}){const{format:a="csv",platformId:n=null,stationId:c=null,stationAcronym:l=null}=m;y.value=!0,v.value=null;try{let s="/instruments";n?s=`/platforms/${n}/instruments`:c&&(s=`/stations/${c}/instruments`);const u=await x.get(s);if(!u.success)throw new Error(u.error||"Failed to fetch instruments");const _=u.data||[],o=l||(n?"platform":c?"station":"all"),e=_.map(r=>{const U=typeof r.specifications=="string"?JSON.parse(r.specifications||"{}"):r.specifications||{};return{id:r.id,normalized_name:r.normalized_name,display_name:r.display_name,instrument_type:r.instrument_type,status:r.status,measurement_status:r.measurement_status,platform_id:r.platform_id,platform_name:r.platform_name,station_acronym:r.station_acronym,deployment_date:r.deployment_date,calibration_date:r.calibration_date,roi_count:r.roi_count,description:r.description,...U,created_at:r.created_at,updated_at:r.updated_at}}),i=a==="json"?b(_):h(e),t=f("instruments",a,o),p=O[a].mimeType;return g(i,t,p),!0}catch(s){return v.value=s.message,!1}finally{y.value=!1}}async function $(m={}){var l;const{format:a="csv",instrumentId:n=null,stationAcronym:c=null}=m;y.value=!0,v.value=null;try{let s={};n&&(s.instrument=n),c&&(s.station=c);const u=await x.get("/rois",s);if(!u.success)throw new Error(u.error||"Failed to fetch ROIs");const _=((l=u.data)==null?void 0:l.rois)||[],o=c||(n?"instrument":"all"),e=a==="json"?b(_):h(_.map(p=>{var r;return{id:p.id,roi_name:p.roi_name,instrument_id:p.instrument_id,instrument_name:p.instrument_name,station_acronym:p.station_acronym,description:p.description,color_r:p.color_r,color_g:p.color_g,color_b:p.color_b,alpha:p.alpha,thickness:p.thickness,auto_generated:p.auto_generated,point_count:((r=p.points)==null?void 0:r.length)||0,generated_date:p.generated_date,source_image:p.source_image,created_at:p.created_at}})),i=f("rois",a,o),t=O[a].mimeType;return g(e,i,t),!0}catch(s){return v.value=s.message,!1}finally{y.value=!1}}async function C(m={}){var c;const{format:a="json",stationAcronym:n=null}=m;y.value=!0,v.value=null;try{if(n){const p=`/api/export/station/${n}`,r=document.createElement("a");return r.href=p,r.download=`${n}_full_export_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(r),r.click(),document.body.removeChild(r),!0}const[l,s,u,_]=await Promise.all([x.get("/stations"),x.get("/platforms"),x.get("/instruments"),x.get("/rois")]),o={export_date:new Date().toISOString(),version:"10.0.0-alpha.15",stations:l.data||[],platforms:s.data||[],instruments:u.data||[],rois:((c=_.data)==null?void 0:c.rois)||[]},e=a==="json"?b(o):h([{type:"stations",count:o.stations.length},{type:"platforms",count:o.platforms.length},{type:"instruments",count:o.instruments.length},{type:"rois",count:o.rois.length}]),i=f("full",a,"all"),t=O[a].mimeType;return g(e,i,t),!0}catch(l){return v.value=l.message,!1}finally{y.value=!1}}return{loading:y,error:v,EXPORT_TYPES:N,EXPORT_FORMATS:O,exportStations:S,exportPlatforms:E,exportInstruments:R,exportROIs:$,exportFull:C,generateFilename:f,toCSV:h,toJSON:b,downloadFile:g}}const q={class:"space-y-6"},G={class:"alert alert-info py-2"},H={class:"text-sm"},Q={class:"form-control"},Z={class:"grid grid-cols-2 gap-2"},tt=["value"],et={class:"font-medium"},nt={class:"text-xs text-base-content/60"},st={key:0,class:"badge badge-xs badge-warning mt-1"},at={class:"form-control"},ot={class:"flex gap-4"},rt=["value"],lt={class:"font-medium"},it={key:0,class:"alert alert-error"},ct=["disabled"],ut=["disabled"],dt={key:0,class:"loading loading-spinner loading-sm"},mt={key:1,xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},yt={__name:"ExportModal",props:{modelValue:{type:Boolean,default:!1},defaultType:{type:String,default:"instruments"},scope:{type:Object,default:()=>({})}},emits:["update:modelValue","exported"],setup(y,{emit:v}){const f=y,h=v,b=K(),{loading:g,error:S,exportStations:E,exportPlatforms:R,exportInstruments:$,exportROIs:C,exportFull:m}=W(),a=j(f.defaultType),n=j("csv"),c=V(()=>{var e,i;return((e=b.user)==null?void 0:e.role)==="admin"||((i=b.user)==null?void 0:i.username)==="spectral-admin"}),l=V(()=>Object.values(N).filter(o=>!(o.adminOnly&&!c.value))),s=V(()=>f.scope.stationAcronym?`Station: ${f.scope.stationAcronym}`:f.scope.platformId?`Platform ID: ${f.scope.platformId}`:f.scope.instrumentId?`Instrument ID: ${f.scope.instrumentId}`:c.value?"All data (admin access)":"Your accessible data");L(()=>f.modelValue,o=>{o&&(a.value=f.defaultType,n.value="csv")});function u(){h("update:modelValue",!1)}async function _(){const o={format:n.value,...f.scope};let e=!1;switch(a.value){case"stations":e=await E(o);break;case"platforms":e=await R(o);break;case"instruments":e=await $(o);break;case"rois":e=await C(o);break;case"full":e=await m(o);break}e&&(h("exported",{type:a.value,format:n.value}),u())}return(o,e)=>(w(),J(Y,{"model-value":y.modelValue,title:"Export Data",size:"md","onUpdate:modelValue":e[2]||(e[2]=i=>o.$emit("update:modelValue",i))},{default:F(()=>[d("div",q,[d("div",G,[e[3]||(e[3]=d("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-5 w-5",fill:"none",viewBox:"0 0 24 24"},[d("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),d("span",H,T(s.value),1)]),d("div",Q,[e[4]||(e[4]=d("label",{class:"label"},[d("span",{class:"label-text font-medium"},"What to export")],-1)),d("div",Z,[(w(!0),k(D,null,z(l.value,i=>(w(),k("label",{key:i.key,class:P(["cursor-pointer rounded-lg border-2 p-3 transition-all",a.value===i.key?"border-primary bg-primary/10":"border-base-300 hover:border-primary/50"])},[B(d("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>a.value=t),type:"radio",value:i.key,class:"hidden"},null,8,tt),[[M,a.value]]),d("div",et,T(i.name),1),d("div",nt,T(i.description),1),i.adminOnly?(w(),k("span",st," Admin only ")):A("",!0)],2))),128))])]),d("div",at,[e[5]||(e[5]=d("label",{class:"label"},[d("span",{class:"label-text font-medium"},"Format")],-1)),d("div",ot,[(w(!0),k(D,null,z(Object.values(I(O)),i=>(w(),k("label",{key:i.key,class:P(["cursor-pointer flex items-center gap-2 px-4 py-2 rounded-lg border-2 transition-all",n.value===i.key?"border-primary bg-primary/10":"border-base-300 hover:border-primary/50"])},[B(d("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>n.value=t),type:"radio",value:i.key,class:"radio radio-primary radio-sm"},null,8,rt),[[M,n.value]]),d("span",lt,T(i.name),1)],2))),128))])]),I(S)?(w(),k("div",it,[e[6]||(e[6]=d("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[d("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),d("span",null,T(I(S)),1)])):A("",!0)])]),actions:F(()=>[d("button",{type:"button",class:"btn btn-ghost",disabled:I(g),onClick:u}," Cancel ",8,ct),d("button",{type:"button",class:"btn btn-primary",disabled:I(g),onClick:_},[I(g)?(w(),k("span",dt)):(w(),k("svg",mt,[...e[7]||(e[7]=[d("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"},null,-1)])])),e[8]||(e[8]=X(" Export ",-1))],8,ut)]),_:1},8,["model-value"]))}};export{yt as _};
