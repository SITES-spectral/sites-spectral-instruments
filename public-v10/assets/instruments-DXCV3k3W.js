import{_ as L}from"./BaseModal-C2sPkbo_.js";import{c as b,e as p,o as c,f as a,k as j,h as P,t as V,n as $,F as S,i as O,p as U,r as k,E as z,B as T,K as X,J as M,g as R,l as G,C as D,A as Y,w as H,d as J}from"./vendor-oiqY8oHn.js";import{I as B,a as Q,h as W}from"./platforms-B4nEbBu-.js";import{c as q}from"./index-CwZwIHTT.js";const Z=["value"],K={key:1,class:"form-control"},_={class:"label"},ee={class:"label-text font-medium"},te={key:0,class:"text-error"},le=["value","placeholder","required","disabled","pattern"],ae=["value","placeholder","required","disabled","min","max","step"],ne=["value","required","disabled"],se={value:""},ue=["value"],ie=["value","required","disabled"],re=["value","placeholder","required","disabled","rows"],oe={key:5,class:"label"},de={class:"label-text-alt text-base-content/60"},A={__name:"DynamicField",props:{modelValue:{type:[String,Number,Boolean,null],default:null},fieldKey:{type:String,required:!0},config:{type:Object,required:!0},disabled:{type:Boolean,default:!1},size:{type:String,default:"md",validator:e=>["sm","md","lg"].includes(e)}},emits:["update:modelValue"],setup(e,{emit:y}){const s=e,i=y,g=b(()=>`w-full ${{sm:"input-sm",md:"",lg:"input-lg"}[s.size]}`);function h(v){let o=v.target.value;s.config.type==="number"&&o!==""&&(o=Number(o)),i("update:modelValue",o)}const I=b(()=>s.config.options?s.config.options.map(v=>{var o;if(typeof v=="string"){const r=((o=s.config.optionLabels)==null?void 0:o[v])||v;return{value:v,label:r}}return v}):[]);return b(()=>!!s.config.dependsOn&&!!s.config.optionsByParent),(v,o)=>e.config.type==="hidden"?(c(),p("input",{key:0,type:"hidden",value:e.modelValue??e.config.defaultValue},null,8,Z)):(c(),p("div",K,[a("label",_,[a("span",ee,[P(V(e.config.label)+" ",1),e.config.required?(c(),p("span",te,"*")):j("",!0)])]),e.config.type==="text"||e.config.type==="string"?(c(),p("input",{key:0,type:"text",value:e.modelValue,onInput:h,class:$(["input input-bordered",g.value]),placeholder:e.config.placeholder||"",required:e.config.required,disabled:e.disabled,pattern:e.config.pattern},null,42,le)):e.config.type==="number"?(c(),p("input",{key:1,type:"number",value:e.modelValue,onInput:h,class:$(["input input-bordered",g.value]),placeholder:e.config.placeholder||"",required:e.config.required,disabled:e.disabled,min:e.config.min,max:e.config.max,step:e.config.step||"any"},null,42,ae)):e.config.type==="select"?(c(),p("select",{key:2,value:e.modelValue,onChange:h,class:$(["select select-bordered",g.value]),required:e.config.required,disabled:e.disabled},[a("option",se,V(e.config.placeholder||"Select..."),1),(c(!0),p(S,null,O(I.value,r=>(c(),p("option",{key:r.value,value:r.value},V(r.label),9,ue))),128))],42,ne)):e.config.type==="date"?(c(),p("input",{key:3,type:"date",value:e.modelValue,onInput:h,class:$(["input input-bordered",g.value]),required:e.config.required,disabled:e.disabled},null,42,ie)):e.config.type==="textarea"?(c(),p("textarea",{key:4,value:e.modelValue,onInput:h,class:$(["textarea textarea-bordered",g.value]),placeholder:e.config.placeholder||"",required:e.config.required,disabled:e.disabled,rows:e.config.rows||3},null,42,re)):j("",!0),e.config.helpText?(c(),p("label",oe,[a("span",de,V(e.config.helpText),1)])):j("",!0)]))}},ce={__name:"DynamicFieldGroup",props:{modelValue:{type:Object,default:()=>({})},schema:{type:Object,required:!0},columns:{type:Number,default:2},size:{type:String,default:"sm"},disabled:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(e,{emit:y}){const s=e,i=y,g=b(()=>Object.entries(s.schema).filter(([,r])=>r.type!=="hidden")),h=b(()=>Object.entries(s.schema).filter(([,r])=>r.type==="hidden")),I=b(()=>{const r={1:"grid-cols-1",2:"grid-cols-1 md:grid-cols-2",3:"grid-cols-1 md:grid-cols-2 lg:grid-cols-3",4:"grid-cols-1 md:grid-cols-2 lg:grid-cols-4"};return r[s.columns]||r[2]});function v(r,m){i("update:modelValue",{...s.modelValue,[r]:m})}function o(r,m){const f=s.modelValue[r];return f??m.defaultValue??null}return(r,m)=>(c(),p("div",null,[(c(!0),p(S,null,O(h.value,([f,x])=>(c(),U(A,{key:f,"field-key":f,config:x,"model-value":o(f,x),"onUpdate:modelValue":w=>v(f,w)},null,8,["field-key","config","model-value","onUpdate:modelValue"]))),128)),a("div",{class:$(["grid gap-4",I.value])},[(c(!0),p(S,null,O(g.value,([f,x])=>(c(),U(A,{key:f,"field-key":f,config:x,"model-value":o(f,x),size:e.size,disabled:e.disabled,"onUpdate:modelValue":w=>v(f,w)},null,8,["field-key","config","model-value","size","disabled","onUpdate:modelValue"]))),128))],2)]))}},me={key:0,class:"form-control"},fe={class:"grid grid-cols-2 md:grid-cols-3 gap-2"},pe=["value"],ve={class:"form-control"},be={class:"bg-base-200 px-4 py-3 rounded-lg font-mono"},ye={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},ge={class:"form-control"},he=["value"],xe={class:"form-control"},Ve=["value"],Ie={key:1,class:"form-control"},ke={class:"label"},we={class:"label-text font-medium"},$e={class:"bg-base-200 p-4 rounded-lg"},qe={key:2,class:"alert"},Se={class:"collapse collapse-arrow bg-base-200"},Oe={class:"collapse-content space-y-4"},Ne={class:"form-control"},Te={class:"form-control"},je={class:"flex justify-end gap-2 pt-4"},Fe=["disabled"],Be=["disabled"],Ce={key:0,class:"loading loading-spinner loading-sm"},Ue={__name:"InstrumentForm",props:{instrument:{type:Object,default:null},platformId:{type:Number,required:!0},platformName:{type:String,required:!0},platformType:{type:String,default:"fixed"},loading:{type:Boolean,default:!1}},emits:["submit","cancel"],setup(e,{emit:y}){const s=e,i=y,g=b(()=>Object.entries(B).filter(([l,t])=>t.platformCompatibility?t.platformCompatibility.includes(s.platformType):!0).map(([l,t])=>({value:l,label:t.name,code:t.code,icon:t.icon}))),h=["Active","Inactive","Maintenance","Decommissioned"],I=["active","paused","stopped","error"],v=b(()=>!!s.instrument),o=k("phenocam"),r=k({}),m=k({display_name:"",description:"",status:"Active",measurement_status:"active"}),f=b(()=>Q(o.value)),x=b(()=>{const l=f.value;if(!(l!=null&&l.fields))return{};const t={};return Object.entries(l.fields).forEach(([u,n])=>{t[u]={type:n.type||"text",label:n.label,required:n.required||!1,placeholder:n.placeholder,options:n.options,min:n.min,max:n.max,step:n.step,unit:n.unit,defaultValue:n.defaultValue}}),t}),w=b(()=>{const l=W(o.value)||"XXX";return`${s.platformName}_${l}##`});z(()=>s.instrument,l=>{if(l){const t=Object.keys(B).find(u=>B[u].name===l.instrument_type||u===l.instrument_type.toLowerCase().replace(/\s+/g,""))||"phenocam";o.value=t,m.value={display_name:l.display_name||"",description:l.description||"",status:l.status||"Active",measurement_status:l.measurement_status||"active"},r.value=l.specifications||{}}},{immediate:!0}),z(o,(l,t)=>{if(l!==t&&!v.value){const u=B[l],n={};u!=null&&u.fields&&Object.entries(u.fields).forEach(([N,E])=>{E.defaultValue!==void 0&&(n[N]=E.defaultValue)}),r.value=n}});const F=b(()=>{if(!o.value)return!1;const l=f.value;if(!(l!=null&&l.fields))return!0;for(const[t,u]of Object.entries(l.fields))if(u.required){const n=r.value[t];if(n==null||n==="")return!1}return!0});function C(){if(!F.value)return;const l=f.value,t={platform_id:s.platformId,instrument_type:(l==null?void 0:l.name)||o.value,display_name:m.value.display_name||void 0,description:m.value.description||void 0,status:m.value.status,measurement_status:m.value.measurement_status,specifications:{...r.value}};Object.keys(t).forEach(u=>{(t[u]===void 0||t[u]==="")&&delete t[u]}),Object.keys(t.specifications).forEach(u=>{(t.specifications[u]===void 0||t.specifications[u]==="")&&delete t.specifications[u]}),i("submit",t)}function d(){i("cancel")}return(l,t)=>{var u;return c(),p("form",{onSubmit:Y(C,["prevent"]),class:"space-y-6"},[v.value?j("",!0):(c(),p("div",me,[t[6]||(t[6]=a("label",{class:"label"},[a("span",{class:"label-text font-medium"},"Instrument Type *")],-1)),a("div",fe,[(c(!0),p(S,null,O(g.value,n=>(c(),p("label",{key:n.value,class:$(["flex items-center gap-2 px-3 py-2 rounded-lg border cursor-pointer transition-colors text-sm",o.value===n.value?"border-primary bg-primary/10":"border-base-300 hover:border-primary/50"])},[T(a("input",{type:"radio","onUpdate:modelValue":t[0]||(t[0]=N=>o.value=N),value:n.value,class:"radio radio-primary radio-sm"},null,8,pe),[[X,o.value]]),a("span",null,V(n.icon),1),a("span",null,V(n.label),1)],2))),128))])])),a("div",ve,[t[7]||(t[7]=a("label",{class:"label"},[a("span",{class:"label-text font-medium"},"Instrument Name Preview")],-1)),a("div",be,V(w.value),1),t[8]||(t[8]=a("label",{class:"label"},[a("span",{class:"label-text-alt text-base-content/60"}," Auto-generated based on platform and instrument type ")],-1))]),a("div",ye,[a("div",ge,[t[9]||(t[9]=a("label",{class:"label"},[a("span",{class:"label-text font-medium"},"Status")],-1)),T(a("select",{"onUpdate:modelValue":t[1]||(t[1]=n=>m.value.status=n),class:"select select-bordered w-full"},[(c(),p(S,null,O(h,n=>a("option",{key:n,value:n},V(n),9,he)),64))],512),[[M,m.value.status]])]),a("div",xe,[t[10]||(t[10]=a("label",{class:"label"},[a("span",{class:"label-text font-medium"},"Measurement Status")],-1)),T(a("select",{"onUpdate:modelValue":t[2]||(t[2]=n=>m.value.measurement_status=n),class:"select select-bordered w-full"},[(c(),p(S,null,O(I,n=>a("option",{key:n,value:n},V(n),9,Ve)),64))],512),[[M,m.value.measurement_status]])])]),Object.keys(x.value).length>0?(c(),p("div",Ie,[a("label",ke,[a("span",we,V(((u=f.value)==null?void 0:u.name)||"Instrument")+" Specifications ",1)]),a("div",$e,[R(G(ce),{modelValue:r.value,"onUpdate:modelValue":t[3]||(t[3]=n=>r.value=n),schema:x.value,columns:2,size:"sm"},null,8,["modelValue","schema"])])])):(c(),p("div",qe,[...t[11]||(t[11]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),a("span",null,"No additional specifications required for this instrument type.",-1)])])),a("div",Se,[t[14]||(t[14]=a("input",{type:"checkbox"},null,-1)),t[15]||(t[15]=a("div",{class:"collapse-title font-medium"}," Optional Fields ",-1)),a("div",Oe,[a("div",Ne,[t[12]||(t[12]=a("label",{class:"label"},[a("span",{class:"label-text"},"Display Name")],-1)),T(a("input",{"onUpdate:modelValue":t[4]||(t[4]=n=>m.value.display_name=n),type:"text",class:"input input-bordered",placeholder:"Human-readable name"},null,512),[[D,m.value.display_name]])]),a("div",Te,[t[13]||(t[13]=a("label",{class:"label"},[a("span",{class:"label-text"},"Description")],-1)),T(a("textarea",{"onUpdate:modelValue":t[5]||(t[5]=n=>m.value.description=n),class:"textarea textarea-bordered",rows:"2",placeholder:"Instrument description..."},null,512),[[D,m.value.description]])])])]),a("div",je,[a("button",{type:"button",class:"btn btn-ghost",onClick:d,disabled:e.loading}," Cancel ",8,Fe),a("button",{type:"submit",class:"btn btn-primary",disabled:!F.value||e.loading},[e.loading?(c(),p("span",Ce)):j("",!0),P(" "+V(v.value?"Update Instrument":"Create Instrument"),1)],8,Be)])],32)}}},Ae={__name:"InstrumentFormModal",props:{modelValue:{type:Boolean,default:!1},instrument:{type:Object,default:null},platformId:{type:Number,required:!0},platformName:{type:String,required:!0},platformType:{type:String,default:"fixed"}},emits:["update:modelValue","submit","cancel"],setup(e,{emit:y}){const s=e,i=y,g=k(!1),h=b(()=>!!s.instrument),I=b(()=>h.value?"Edit Instrument":"Create Instrument");async function v(m){g.value=!0;try{i("submit",m)}finally{g.value=!1}}function o(){i("update:modelValue",!1),i("cancel")}function r(){i("update:modelValue",!1)}return(m,f)=>(c(),U(L,{"model-value":e.modelValue,title:I.value,size:"lg","onUpdate:modelValue":f[0]||(f[0]=x=>m.$emit("update:modelValue",x)),onClose:r},{default:H(()=>[R(Ue,{instrument:e.instrument,"platform-id":e.platformId,"platform-name":e.platformName,"platform-type":e.platformType,loading:g.value,onSubmit:v,onCancel:o},null,8,["instrument","platform-id","platform-name","platform-type","loading"])]),_:1},8,["model-value","title"]))}},Pe=J("instruments",()=>{const e=k([]),y=k(null),s=k(!1),i=k(null),g=b(()=>e.value.length),h=b(()=>{const d={};return e.value.forEach(l=>{const t=l.instrument_type||"Unknown";d[t]||(d[t]=[]),d[t].push(l)}),d}),I=b(()=>e.value.filter(d=>d.status==="Active")),v=b(()=>e.value.filter(d=>d.measurement_status==="Operational"));async function o(d){s.value=!0,i.value=null;try{const l=await q.get(`/platforms/${d}/instruments`);l.success?e.value=l.data||[]:i.value=l.error||"Failed to fetch instruments"}catch(l){i.value=l.message}finally{s.value=!1}}async function r(d){s.value=!0,i.value=null;try{const l=await q.get(`/stations/${d}/instruments`);l.success?e.value=l.data||[]:i.value=l.error||"Failed to fetch instruments"}catch(l){i.value=l.message}finally{s.value=!1}}async function m(d){s.value=!0,i.value=null;try{const l=await q.get(`/instruments/${d}`);return l.success?(y.value=l.data,l.data):(i.value=l.error||"Instrument not found",null)}catch(l){return i.value=l.message,null}finally{s.value=!1}}async function f(d){s.value=!0,i.value=null;try{const l=await q.post("/instruments",d);return l.success?(e.value.push(l.data),l.data):(i.value=l.error||"Failed to create instrument",null)}catch(l){return i.value=l.message,null}finally{s.value=!1}}async function x(d,l){var t;s.value=!0,i.value=null;try{const u=await q.put(`/instruments/${d}`,l);if(u.success){const n=e.value.findIndex(N=>N.id===d);return n!==-1&&(e.value[n]=u.data),((t=y.value)==null?void 0:t.id)===d&&(y.value=u.data),u.data}else return i.value=u.error||"Failed to update instrument",null}catch(u){return i.value=u.message,null}finally{s.value=!1}}async function w(d){var l;s.value=!0,i.value=null;try{const t=await q.delete(`/instruments/${d}`);return t.success?(e.value=e.value.filter(u=>u.id!==d),((l=y.value)==null?void 0:l.id)===d&&(y.value=null),!0):(i.value=t.error||"Failed to delete instrument",!1)}catch(t){return i.value=t.message,!1}finally{s.value=!1}}function F(){y.value=null}function C(){e.value=[],y.value=null}return{instruments:e,currentInstrument:y,loading:s,error:i,instrumentCount:g,instrumentsByType:h,activeInstruments:I,operationalInstruments:v,fetchInstrumentsByPlatform:o,fetchInstrumentsByStation:r,fetchInstrument:m,createInstrument:f,updateInstrument:x,deleteInstrument:w,clearCurrentInstrument:F,clearInstruments:C}});export{Ae as _,Pe as u};
