<!-- ========================================
     ROI Creation Button Integration Example
     This shows how to add the "Create ROI" button to the instrument details modal
     ======================================== -->

<!-- EXAMPLE 1: Add to Instrument Modal Header -->
<!-- Location: Inside instrument modal, around line 1840 in station.html -->

<div id="instrument-modal" class="instrument-modal">
    <div class="modal-content-large">
        <div class="modal-header-large">
            <h3><i class="fas fa-camera"></i> Instrument Details</h3>

            <!-- ADD THIS: ROI Creation Button in Header -->
            <div class="modal-header-actions">
                <button class="btn btn-sm btn-success" onclick="showROICreationModalFromInstrument()"
                        id="create-roi-header-btn" style="display: none;">
                    <i class="fas fa-draw-polygon"></i> Create ROI
                </button>
                <button class="modal-close-large" onclick="closeInstrumentModal()">&times;</button>
            </div>
        </div>

        <div class="modal-body-large">
            <!-- Instrument details content -->
        </div>
    </div>
</div>

<!-- EXAMPLE 2: Add to ROI Section in Instrument Modal -->
<!-- Location: Inside instrument details, ROI section -->

<div class="roi-section">
    <div class="roi-section-header">
        <h4>
            <i class="fas fa-draw-polygon"></i>
            Regions of Interest (ROIs)
            <span class="roi-count-badge" id="roi-count-badge">0</span>
        </h4>

        <!-- ADD THIS: ROI Creation Button in Section -->
        <button class="btn btn-sm btn-success" onclick="showROICreationModalFromInstrument()"
                id="create-roi-section-btn">
            <i class="fas fa-plus"></i> Create ROI
        </button>
    </div>

    <div class="roi-cards-container" id="instrument-rois-container">
        <!-- ROI cards will be displayed here -->
        <div class="roi-empty-state" id="roi-empty-state">
            <i class="fas fa-draw-polygon"></i>
            <p>No ROIs defined for this instrument</p>
            <button class="btn btn-primary" onclick="showROICreationModalFromInstrument()">
                <i class="fas fa-plus"></i> Create First ROI
            </button>
        </div>
    </div>
</div>

<!-- EXAMPLE 3: Add to Platform Card's Instrument Row -->
<!-- Location: Inside platform cards when displaying instruments -->

<div class="instrument-row">
    <div class="instrument-info">
        <span class="instrument-name">SVB_FOR_PL01_PHE01</span>
        <span class="roi-indicator">
            <i class="fas fa-draw-polygon"></i> 3 ROIs
        </span>
    </div>

    <div class="instrument-actions">
        <button class="btn btn-sm btn-secondary" onclick="viewInstrumentDetails(instrumentId)">
            <i class="fas fa-eye"></i> View
        </button>

        <!-- ADD THIS: Quick ROI Creation from Platform Card -->
        <button class="btn btn-sm btn-success" onclick="showROICreationModal(instrumentId, instrumentName)">
            <i class="fas fa-draw-polygon"></i> Add ROI
        </button>
    </div>
</div>

<!-- ========================================
     JavaScript Functions
     ======================================== -->

<script>
/**
 * Show ROI creation modal from instrument details modal
 * Automatically extracts instrument ID and name from current instrument modal
 */
function showROICreationModalFromInstrument() {
    // Get current instrument data from modal
    const instrumentId = document.getElementById('instrument-details')?.dataset?.instrumentId;
    const instrumentName = document.getElementById('instrument-details')?.dataset?.instrumentName;

    if (!instrumentId) {
        showNotification('Cannot determine instrument ID', 'error');
        return;
    }

    showROICreationModal(parseInt(instrumentId), instrumentName || 'Unknown');
}

/**
 * Enhanced instrument modal that loads ROI data
 * This replaces or enhances the existing showInstrumentModal function
 */
async function showInstrumentModal(instrumentId) {
    try {
        // Existing instrument data fetch
        const response = await fetch(`/api/instruments/${instrumentId}`, {
            headers: window.API.getAuthHeaders()
        });

        if (!response.ok) {
            throw new Error('Failed to fetch instrument details');
        }

        const instrument = await response.json();

        // Store instrument ID and name in modal for ROI creation
        const detailsContainer = document.getElementById('instrument-details');
        detailsContainer.dataset.instrumentId = instrumentId;
        detailsContainer.dataset.instrumentName = instrument.normalized_name;

        // Render instrument details (existing code)
        renderInstrumentDetails(instrument);

        // Load ROIs for this instrument
        await loadInstrumentROIs(instrumentId);

        // Show create ROI button based on permissions
        const user = window.API.getUser();
        if (user && (user.role === 'admin' || user.role === 'station')) {
            document.getElementById('create-roi-header-btn').style.display = 'inline-flex';
            document.getElementById('create-roi-section-btn').style.display = 'inline-flex';
        }

        // Show modal
        document.getElementById('instrument-modal').style.display = 'flex';

    } catch (error) {
        console.error('Error loading instrument details:', error);
        showNotification('Failed to load instrument details', 'error');
    }
}

/**
 * Load and display ROIs for an instrument
 */
async function loadInstrumentROIs(instrumentId) {
    try {
        const response = await fetch(`/api/instruments/${instrumentId}/rois`, {
            headers: window.API.getAuthHeaders()
        });

        if (!response.ok) {
            throw new Error('Failed to fetch ROIs');
        }

        const rois = await response.json();

        // Update ROI count badge
        const countBadge = document.getElementById('roi-count-badge');
        if (countBadge) {
            countBadge.textContent = rois.length;
            countBadge.style.display = rois.length > 0 ? 'inline-block' : 'none';
        }

        // Render ROI cards
        const container = document.getElementById('instrument-rois-container');
        const emptyState = document.getElementById('roi-empty-state');

        if (rois.length === 0) {
            if (emptyState) emptyState.style.display = 'flex';
            return;
        }

        if (emptyState) emptyState.style.display = 'none';

        // Create ROI cards
        let roiHTML = '<div class="roi-cards-grid">';

        rois.forEach(roi => {
            const colorRGB = `rgb(${roi.color_r}, ${roi.color_g}, ${roi.color_b})`;
            const points = JSON.parse(roi.points_json || '[]');
            const autoGenBadge = roi.auto_generated ? '<span class="roi-auto-badge">Auto</span>' : '';

            roiHTML += `
                <div class="roi-card">
                    <div class="roi-card-header" style="border-left: 4px solid ${colorRGB};">
                        <strong>${roi.roi_name}</strong>
                        ${autoGenBadge}
                    </div>
                    <div class="roi-card-body">
                        <div class="roi-card-info">
                            <i class="fas fa-info-circle"></i>
                            <span>${roi.description || 'No description'}</span>
                        </div>
                        <div class="roi-card-info">
                            <i class="fas fa-draw-polygon"></i>
                            <span>${points.length} points</span>
                        </div>
                        <div class="roi-card-info">
                            <i class="fas fa-palette"></i>
                            <span>
                                <span class="roi-color-swatch" style="background-color: ${colorRGB};"></span>
                                RGB(${roi.color_r}, ${roi.color_g}, ${roi.color_b})
                            </span>
                        </div>
                        ${roi.source_image ? `
                        <div class="roi-card-info">
                            <i class="fas fa-image"></i>
                            <span>${roi.source_image}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="roi-card-actions">
                        <button class="btn btn-sm btn-secondary" onclick="viewROIDetails(${roi.id})">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteROI(${roi.id}, '${roi.roi_name}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `;
        });

        roiHTML += '</div>';
        container.innerHTML = roiHTML;

    } catch (error) {
        console.error('Error loading ROIs:', error);
        // Don't show error notification as this is not critical
    }
}

/**
 * Delete ROI with confirmation
 */
async function deleteROI(roiId, roiName) {
    if (!confirm(`Are you sure you want to delete ROI "${roiName}"?\n\nThis action cannot be undone.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/rois/${roiId}`, {
            method: 'DELETE',
            headers: window.API.getAuthHeaders()
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to delete ROI');
        }

        showNotification(`ROI "${roiName}" deleted successfully`, 'success');

        // Reload ROIs for current instrument
        const instrumentId = document.getElementById('instrument-details')?.dataset?.instrumentId;
        if (instrumentId) {
            await loadInstrumentROIs(parseInt(instrumentId));
        }

    } catch (error) {
        console.error('Error deleting ROI:', error);
        showNotification(error.message, 'error');
    }
}

/**
 * View ROI details (future enhancement - could show visualization)
 */
function viewROIDetails(roiId) {
    showNotification('ROI visualization coming soon!', 'success');
    // TODO: Implement ROI visualization modal
    // - Show image with ROI overlay
    // - Display all ROI properties
    // - Allow editing ROI points
}

/**
 * Refresh instrument modal after ROI creation
 * Call this from the ROI creation modal's save function
 */
async function refreshInstrumentModal() {
    const instrumentId = document.getElementById('instrument-details')?.dataset?.instrumentId;
    if (instrumentId && document.getElementById('instrument-modal').style.display === 'flex') {
        await loadInstrumentROIs(parseInt(instrumentId));
    }
}
</script>

<!-- ========================================
     Additional CSS for ROI Section
     ======================================== -->

<style>
/* ROI Section Header */
.roi-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid #e5e7eb;
}

.roi-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #e5e7eb;
}

.roi-section-header h4 {
    margin: 0;
    color: #059669;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.roi-count-badge {
    display: inline-block;
    background: #059669;
    color: white;
    padding: 0.25rem 0.625rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    margin-left: 0.5rem;
}

/* ROI Empty State */
.roi-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 2rem;
    background: #f9fafb;
    border: 2px dashed #cbd5e1;
    border-radius: 12px;
    text-align: center;
    color: #6b7280;
}

.roi-empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.3;
}

.roi-empty-state p {
    margin: 0 0 1.5rem 0;
    font-size: 1.1rem;
    font-weight: 500;
}

/* ROI Cards Grid */
.roi-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
}

.roi-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.roi-card:hover {
    border-color: #059669;
    box-shadow: 0 4px 12px rgba(5, 150, 105, 0.15);
    transform: translateY(-2px);
}

.roi-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.875rem 1rem;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
}

.roi-card-header strong {
    color: #059669;
    font-size: 1rem;
    font-family: 'Courier New', monospace;
}

.roi-auto-badge {
    background: #fbbf24;
    color: #78350f;
    padding: 0.125rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}

.roi-card-body {
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.roi-card-info {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    font-size: 0.875rem;
    color: #6b7280;
}

.roi-card-info i {
    color: #9ca3af;
    width: 16px;
    text-align: center;
}

.roi-color-swatch {
    display: inline-block;
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 2px solid #e5e7eb;
    vertical-align: middle;
    margin-right: 0.25rem;
}

.roi-card-actions {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
}

.roi-card-actions .btn {
    flex: 1;
}

/* Modal Header Actions */
.modal-header-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

/* Instrument Row Actions (for platform cards) */
.instrument-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
}

.instrument-row:hover {
    border-color: #059669;
    box-shadow: 0 2px 8px rgba(5, 150, 105, 0.1);
}

.instrument-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.instrument-name {
    font-weight: 600;
    color: #059669;
    font-family: 'Courier New', monospace;
}

.roi-indicator {
    font-size: 0.875rem;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.roi-indicator i {
    color: #059669;
}

.instrument-actions {
    display: flex;
    gap: 0.5rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .roi-cards-grid {
        grid-template-columns: 1fr;
    }

    .roi-section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }

    .instrument-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .instrument-actions {
        width: 100%;
    }

    .instrument-actions .btn {
        flex: 1;
    }
}
</style>

<!-- ========================================
     Integration Notes
     ======================================== -->

<!--

INTEGRATION STEPS:

1. Add ROI section HTML to instrument modal body (around line 1850)
2. Add JavaScript functions to station.html <script> section (around line 5000)
3. Add CSS styles to station.html <style> section (around line 200)
4. Update showInstrumentModal() to load ROIs when instrument details are shown
5. Add "Create ROI" button visibility based on user permissions
6. Test ROI creation workflow:
   - Open instrument details
   - Click "Create ROI" button
   - Use either drawing mode or YAML upload
   - Save ROI
   - Verify ROI appears in instrument modal
   - Test delete functionality

PERMISSION RULES:

- Read-only users: Can view ROIs, cannot create/delete
- Station users: Can create ROIs for their station's instruments, cannot delete
- Admin users: Can create and delete ROIs for all instruments

API ENDPOINTS REQUIRED:

- GET /api/instruments/{id}/rois - List ROIs for instrument
- POST /api/rois - Create new ROI
- DELETE /api/rois/{id} - Delete ROI (admin only)

TESTING CHECKLIST:

[ ] ROI section appears in instrument modal
[ ] Create ROI button visible for admin/station users
[ ] Create ROI button hidden for read-only users
[ ] ROI cards display correctly with all information
[ ] ROI count badge updates when ROIs added/deleted
[ ] Empty state shows when no ROIs exist
[ ] Delete ROI confirmation works
[ ] ROI creation modal opens from instrument modal
[ ] ROI list refreshes after creation
[ ] Responsive design works on mobile

-->
