<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Station Dashboard - SITES Spectral</title>
    <meta name="description" content="Station-specific dashboard for managing platforms and instruments">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/images/SITES_favicon.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet.js for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="/css/styles.css?v=3.2.0">

    <style>
        .station-header {
            background: linear-gradient(135deg, #059669 0%, #064e3b 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .station-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .station-details h1 {
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
        }

        .station-meta {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 0.25rem;
        }

        .meta-value {
            font-weight: 500;
            font-size: 1rem;
        }

        .platform-map {
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .platforms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .platform-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.2s;
        }

        .platform-card:hover {
            transform: translateY(-2px);
        }

        .platform-header {
            padding: 1.5rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .platform-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .platform-content {
            padding: 1.5rem;
        }

        .platform-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #718096;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-weight: 500;
            color: #2d3748;
        }

        .instruments-section {
            border-top: 1px solid #e2e8f0;
            padding-top: 1rem;
        }

        .instruments-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .instruments-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .instrument-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .instrument-info {
            flex: 1;
        }

        .instrument-name {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .instrument-specs {
            font-size: 0.85rem;
            color: #4a5568;
        }

        .instrument-actions {
            display: flex;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-active {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-inactive {
            background: #fed7d7;
            color: #742a2a;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
            color: #2d3748;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8rem;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #4a5568;
        }

        .empty-state i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #a0aec0;
        }

        .loading-state {
            text-align: center;
            padding: 2rem;
            color: #4a5568;
        }

        .auth-required {
            display: none;
            min-height: 100vh;
            background: linear-gradient(135deg, #059669 0%, #064e3b 100%);
            color: white;
            text-align: center;
            padding: 2rem;
            justify-content: center;
            align-items: center;
        }

        .dashboard {
            display: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-content.large {
            max-width: 800px;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #2d3748;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #4a5568;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background: #f7fafc;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        fieldset {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        fieldset legend {
            padding: 0 0.5rem;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
        }

        /* Toast Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 15000;
        }

        .toast {
            background: white;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            min-width: 300px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-success {
            border-left-color: #48bb78;
        }

        .toast-error {
            border-left-color: #e53e3e;
        }

        @media (max-width: 768px) {
            .station-info {
                flex-direction: column;
                text-align: center;
            }

            .station-meta {
                justify-content: center;
            }

            .platforms-grid {
                grid-template-columns: 1fr;
            }

            .platform-details {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- Version Meta -->
    <meta name="app-version" content="3.2.0">
    <meta name="build-date" content="2025-09-18">
</head>
<body>
    <!-- Authentication Required Message -->
    <div class="auth-required" id="auth-required">
        <div class="auth-message">
            <div class="login-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h1>Authentication Required</h1>
            <p>You must be logged in to access the station dashboard. Please log in with your authorized credentials.</p>
            <a href="/login.html" class="btn btn-primary">
                <i class="fas fa-sign-in-alt"></i>
                Login to System
            </a>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-brand">
                    <img src="/images/SITES_spectral_LOGO.png" alt="SITES Spectral" class="brand-logo">
                    <span>SITES Spectral</span>
                </div>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="/stations.html" class="nav-link">
                            <i class="fas fa-broadcast-tower"></i> All Stations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/station-dashboard.html" class="nav-link active">
                            <i class="fas fa-map-marker-alt"></i> My Station
                        </a>
                    </li>
                </ul>
                <div class="nav-user">
                    <span id="nav-username"></span>
                    <a href="#" onclick="logout()" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </nav>

        <!-- Station Header -->
        <section class="station-header">
            <div class="container">
                <div class="station-info">
                    <div class="station-details">
                        <h1 id="station-name">Loading Station...</h1>
                        <div class="station-meta">
                            <div class="meta-item">
                                <span class="meta-label">Station Code</span>
                                <span class="meta-value" id="station-acronym">-</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Status</span>
                                <span class="meta-value status-badge" id="station-status">-</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Coordinates</span>
                                <span class="meta-value" id="station-coordinates">-</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Platforms</span>
                                <span class="meta-value" id="platforms-count">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Interactive Platform Map -->
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-map"></i>
                        Platform Locations
                    </h2>
                </div>
                <div id="platform-map" class="platform-map">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading map...</p>
                    </div>
                </div>

                <!-- Platforms Grid -->
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-tower-broadcast"></i>
                        Station Platforms
                    </h2>
                </div>
                <div class="platforms-grid" id="platforms-grid">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading platforms...</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-left">
                        <p>&copy; 2025 SITES Spectral. All rights reserved.</p>
                    </div>
                    <div class="footer-right">
                        <p>Version <span>3.2.0</span> | Built on <span>2025-09-18</span></p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Platform Edit Modal -->
    <div class="modal" id="platform-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="platform-modal-title">Edit Platform</h3>
                <button class="modal-close" onclick="closeModal('platform-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="platform-form">
                    <input type="hidden" id="platform-id">
                    <input type="hidden" id="platform-station-id">

                    <div class="form-row">
                        <div class="form-group">
                            <label for="platform-display-name">Display Name</label>
                            <input type="text" id="platform-display-name" name="display_name">
                        </div>
                        <div class="form-group">
                            <label for="platform-location-code">Location Code</label>
                            <input type="text" id="platform-location-code" name="location_code" placeholder="BL01, PL01, etc.">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="platform-mounting-structure">Mounting Structure</label>
                            <select id="platform-mounting-structure" name="mounting_structure">
                                <option value="">Select...</option>
                                <option value="Building RoofTop">Building RoofTop</option>
                                <option value="Building Wall">Building Wall</option>
                                <option value="Tower">Tower</option>
                                <option value="Mast">Mast</option>
                                <option value="Flagpole and Tower">Flagpole and Tower</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="platform-height">Platform Height (meters)</label>
                            <input type="number" id="platform-height" name="platform_height_m" step="0.1" min="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="platform-status">Status</label>
                            <select id="platform-status" name="status">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Removed">Removed</option>
                                <option value="Planned">Planned</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="platform-deployment-date">Deployment Date</label>
                            <input type="date" id="platform-deployment-date" name="deployment_date">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="platform-latitude">Latitude (decimal degrees)</label>
                            <input type="number" id="platform-latitude" name="latitude" step="0.0001" min="-90" max="90">
                        </div>
                        <div class="form-group">
                            <label for="platform-longitude">Longitude (decimal degrees)</label>
                            <input type="number" id="platform-longitude" name="longitude" step="0.0001" min="-180" max="180">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="platform-description">Description</label>
                        <textarea id="platform-description" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('platform-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePlatform()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentUser = null;
        let currentStation = null;
        let platformMap = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });

        // Check if user is authenticated
        async function checkAuthentication() {
            const token = localStorage.getItem('sites_spectral_token');
            const user = JSON.parse(localStorage.getItem('sites_spectral_user') || 'null');

            if (!token || !user) {
                showAuthRequired();
                return;
            }

            try {
                // Verify token is still valid
                const response = await fetch('/api/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok || !(await response.json()).valid) {
                    throw new Error('Invalid token');
                }

                currentUser = user;
                document.getElementById('nav-username').textContent = user.username;
                showDashboard();
                await loadStationData();

            } catch (error) {
                console.error('Authentication failed:', error);
                localStorage.removeItem('sites_spectral_token');
                localStorage.removeItem('sites_spectral_user');
                showAuthRequired();
            }
        }

        // Show authentication required message
        function showAuthRequired() {
            document.getElementById('auth-required').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }

        // Show dashboard after successful authentication
        function showDashboard() {
            document.getElementById('auth-required').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        // Load station data
        async function loadStationData() {
            try {
                const token = localStorage.getItem('sites_spectral_token');

                // Get user's station based on role
                let stationAcronym = null;
                if (currentUser.role === 'station' && currentUser.station_acronym) {
                    stationAcronym = currentUser.station_acronym;
                } else {
                    // For admin/readonly users, get the first station (or use query param)
                    const urlParams = new URLSearchParams(window.location.search);
                    stationAcronym = urlParams.get('station') || 'abisko'; // Default to abisko
                }

                // Load station details
                const stationResponse = await fetch(`/api/stations/${stationAcronym}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!stationResponse.ok) {
                    throw new Error('Failed to fetch station details');
                }

                currentStation = await stationResponse.json();
                updateStationHeader(currentStation);

                // Load platforms for this station
                const platformsResponse = await fetch(`/api/platforms?station_id=${currentStation.id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!platformsResponse.ok) {
                    throw new Error('Failed to fetch platforms');
                }

                const platformsData = await platformsResponse.json();
                const platforms = platformsData.platforms || platformsData;

                // Load instruments for each platform
                for (let platform of platforms) {
                    const instrumentsResponse = await fetch(`/api/instruments?platform_id=${platform.id}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (instrumentsResponse.ok) {
                        const instrumentsData = await instrumentsResponse.json();
                        platform.instruments = instrumentsData.instruments || instrumentsData;
                    } else {
                        platform.instruments = [];
                    }
                }

                renderPlatforms(platforms);
                initializeMap(platforms);

            } catch (error) {
                console.error('Error loading station data:', error);
                showToast('Failed to load station data', 'error');
            }
        }

        // Update station header information
        function updateStationHeader(station) {
            document.getElementById('station-name').textContent = station.display_name || station.name;
            document.getElementById('station-acronym').textContent = station.acronym || '-';

            const statusElement = document.getElementById('station-status');
            statusElement.textContent = station.status || 'Unknown';
            statusElement.className = `meta-value status-badge ${station.status === 'Active' ? 'status-active' : 'status-inactive'}`;

            if (station.latitude && station.longitude) {
                document.getElementById('station-coordinates').textContent =
                    `${station.latitude.toFixed(4)}, ${station.longitude.toFixed(4)}`;
            }
        }

        // Render platforms grid
        function renderPlatforms(platforms) {
            const grid = document.getElementById('platforms-grid');
            document.getElementById('platforms-count').textContent = platforms.length;

            if (platforms.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tower-broadcast"></i>
                        <p>No platforms configured for this station</p>
                    </div>
                `;
                return;
            }

            const platformsHTML = platforms.map(platform => `
                <div class="platform-card">
                    <div class="platform-header">
                        <h3 class="platform-title">
                            <i class="fas fa-tower-broadcast"></i>
                            ${platform.display_name || platform.normalized_name}
                        </h3>
                        ${currentUser.role !== 'readonly' ? `
                            <button class="btn btn-secondary btn-sm" onclick="editPlatform(${platform.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        ` : ''}
                    </div>
                    <div class="platform-content">
                        <div class="platform-details">
                            <div class="detail-item">
                                <span class="detail-label">Location Code</span>
                                <span class="detail-value">${platform.location_code || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Mounting Structure</span>
                                <span class="detail-value">${platform.mounting_structure || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Height</span>
                                <span class="detail-value">${platform.platform_height_m ? platform.platform_height_m + 'm' : '-'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Status</span>
                                <span class="detail-value status-badge ${platform.status === 'Active' ? 'status-active' : 'status-inactive'}">
                                    ${platform.status || 'Unknown'}
                                </span>
                            </div>
                        </div>

                        <div class="instruments-section">
                            <div class="instruments-header">
                                <h4>Instruments (${(platform.instruments || []).length})</h4>
                            </div>
                            <div class="instruments-list">
                                ${platform.instruments && platform.instruments.length > 0
                                    ? platform.instruments.map(instrument => `
                                        <div class="instrument-item">
                                            <div class="instrument-info">
                                                <div class="instrument-name">
                                                    <i class="fas fa-camera"></i>
                                                    ${instrument.display_name || instrument.normalized_name}
                                                </div>
                                                <div class="instrument-specs">
                                                    ${instrument.camera_brand || 'Unknown'} ${instrument.camera_model || ''}
                                                    ${instrument.camera_resolution ? '• ' + instrument.camera_resolution : ''}
                                                    ${instrument.ecosystem_code ? '• ' + instrument.ecosystem_code : ''}
                                                </div>
                                            </div>
                                            <div class="instrument-actions">
                                                <span class="status-badge ${instrument.status === 'Active' ? 'status-active' : 'status-inactive'}">
                                                    ${instrument.status || 'Unknown'}
                                                </span>
                                            </div>
                                        </div>
                                    `).join('')
                                    : '<div class="empty-state"><i class="fas fa-camera"></i><p>No instruments configured</p></div>'
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            grid.innerHTML = platformsHTML;
        }

        // Initialize map with platforms
        function initializeMap(platforms) {
            const mapContainer = document.getElementById('platform-map');

            if (platformMap) {
                platformMap.remove();
            }

            // Center map on station location
            const centerLat = currentStation.latitude || 62.0;
            const centerLng = currentStation.longitude || 15.0;
            const zoom = platforms.length > 1 ? 12 : 15;

            platformMap = L.map(mapContainer, {
                zoomControl: true,
                attributionControl: true
            }).setView([centerLat, centerLng], zoom);

            // Add tile layer
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles © Esri'
            }).addTo(platformMap);

            // Add station marker
            const stationMarker = L.marker([centerLat, centerLng], {
                icon: L.divIcon({
                    className: 'google-style-marker station-marker',
                    html: `
                        <div class="google-marker-pin station-pin">
                            <i class="fas fa-broadcast-tower"></i>
                        </div>
                        <div class="google-marker-shadow"></div>
                    `,
                    iconSize: [32, 42],
                    iconAnchor: [16, 42]
                })
            });

            stationMarker.addTo(platformMap);
            stationMarker.bindPopup(`
                <div class="map-popup">
                    <h4><i class="fas fa-broadcast-tower"></i> ${currentStation.display_name}</h4>
                    <p><strong>Station:</strong> ${currentStation.acronym}</p>
                    <p><strong>Status:</strong> ${currentStation.status}</p>
                </div>
            `);

            // Add platform markers
            platforms.forEach(platform => {
                if (platform.latitude && platform.longitude) {
                    const platformMarker = L.marker([platform.latitude, platform.longitude], {
                        icon: L.divIcon({
                            className: 'google-style-marker platform-marker',
                            html: `
                                <div class="google-marker-pin platform-pin">
                                    <i class="fas fa-tower-broadcast"></i>
                                </div>
                                <div class="google-marker-shadow"></div>
                            `,
                            iconSize: [28, 38],
                            iconAnchor: [14, 38]
                        })
                    });

                    platformMarker.addTo(platformMap);
                    platformMarker.bindPopup(`
                        <div class="map-popup">
                            <h4><i class="fas fa-tower-broadcast"></i> ${platform.display_name}</h4>
                            <p><strong>Location:</strong> ${platform.location_code}</p>
                            <p><strong>Height:</strong> ${platform.platform_height_m || 'N/A'}m</p>
                            <p><strong>Mounting:</strong> ${platform.mounting_structure || 'N/A'}</p>
                            <p><strong>Instruments:</strong> ${(platform.instruments || []).length}</p>
                        </div>
                    `);
                }
            });

            // Fit map to show all markers if multiple platforms
            if (platforms.length > 1) {
                const group = new L.featureGroup([stationMarker, ...platforms.filter(p => p.latitude && p.longitude).map(p =>
                    L.marker([p.latitude, p.longitude])
                )]);
                platformMap.fitBounds(group.getBounds().pad(0.1));
            }

            // Remove loading indicator
            mapContainer.querySelector('.loading-state').style.display = 'none';
        }

        // Edit platform
        async function editPlatform(platformId) {
            try {
                const token = localStorage.getItem('sites_spectral_token');
                const response = await fetch(`/api/platforms/${platformId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch platform details');
                }

                const platform = await response.json();
                populatePlatformForm(platform);
                showModal('platform-modal');

            } catch (error) {
                console.error('Error loading platform:', error);
                showToast('Failed to load platform details', 'error');
            }
        }

        // Populate platform form
        function populatePlatformForm(platform) {
            document.getElementById('platform-id').value = platform.id || '';
            document.getElementById('platform-station-id').value = platform.station_id || currentStation.id;
            document.getElementById('platform-display-name').value = platform.display_name || '';
            document.getElementById('platform-location-code').value = platform.location_code || '';
            document.getElementById('platform-mounting-structure').value = platform.mounting_structure || '';
            document.getElementById('platform-height').value = platform.platform_height_m || '';
            document.getElementById('platform-status').value = platform.status || 'Active';
            document.getElementById('platform-deployment-date').value = platform.deployment_date || '';
            document.getElementById('platform-latitude').value = platform.latitude || '';
            document.getElementById('platform-longitude').value = platform.longitude || '';
            document.getElementById('platform-description').value = platform.description || '';

            document.getElementById('platform-modal-title').textContent =
                platform.id ? 'Edit Platform' : 'Create Platform';
        }

        // Save platform
        async function savePlatform() {
            try {
                const form = document.getElementById('platform-form');
                const formData = new FormData(form);
                const platformId = document.getElementById('platform-id').value;
                const token = localStorage.getItem('sites_spectral_token');

                const data = {};
                for (let [key, value] of formData.entries()) {
                    if (value !== '') {
                        if (key === 'latitude' || key === 'longitude' || key === 'platform_height_m') {
                            data[key] = parseFloat(value);
                        } else if (key === 'station_id') {
                            data[key] = parseInt(value);
                        } else {
                            data[key] = value;
                        }
                    }
                }

                const url = platformId ? `/api/platforms/${platformId}` : '/api/platforms';
                const method = platformId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save platform');
                }

                showToast(platformId ? 'Platform updated successfully' : 'Platform created successfully', 'success');
                closeModal('platform-modal');
                loadStationData(); // Reload data

            } catch (error) {
                console.error('Error saving platform:', error);
                showToast(error.message, 'error');
            }
        }

        // Modal management
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        });

        // Logout function
        function logout() {
            localStorage.removeItem('sites_spectral_token');
            localStorage.removeItem('sites_spectral_user');
            window.location.href = '/login.html';
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;

            const container = document.getElementById('toast-container');
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>