<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stations Dashboard - SITES Spectral</title>
    <meta name="description" content="Authenticated dashboard for managing SITES spectral monitoring stations and instruments">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/images/SITES_favicon.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet.js for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="/css/styles.css?v=2.0.2">

    <style>
        /* Authentication Required Styles */
        .auth-required {
            display: none;
            min-height: 100vh;
            background: linear-gradient(135deg, #059669 0%, #064e3b 100%);
            color: white;
            text-align: center;
            padding: 2rem;
            justify-content: center;
            align-items: center;
        }

        .auth-message {
            max-width: 500px;
            margin: 0 auto;
        }

        .auth-message h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .auth-message p {
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        /* Dashboard Styles */
        .dashboard {
            display: none;
        }

        .user-header {
            background: linear-gradient(135deg, #059669 0%, #064e3b 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-details h1 {
            margin: 0 0 0.5rem 0;
            font-size: 1.8rem;
        }

        .user-role {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            text-transform: uppercase;
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            color: #4a5568;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .nav-tab:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .dashboard-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.2s;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            padding: 1.5rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: between;
        }

        .card-title {
            margin: 0;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }

        .card-content {
            padding: 1.5rem;
        }

        .station-card {
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .station-card:hover {
            border-color: #667eea;
        }

        .station-card.highlighted {
            border-color: #f39c12 !important;
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.3);
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.05) 0%, rgba(243, 156, 18, 0.1) 100%);
        }

        .station-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-label {
            font-size: 0.8rem;
            color: #718096;
            margin-bottom: 0.25rem;
        }

        .meta-value {
            font-weight: 500;
            color: #2d3748;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-active {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-inactive {
            background: #fed7d7;
            color: #742a2a;
        }

        .interactive-map {
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .map-container {
            position: relative;
        }

        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
        }

        .loading-card {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #4a5568;
        }

        .loading-card .spinner {
            margin-right: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #4a5568;
        }

        .empty-state i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #a0aec0;
        }

        .station-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .error-state {
            background: #fed7d7;
            color: #742a2a;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-content.large {
            max-width: 800px;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #2d3748;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #4a5568;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background: #f7fafc;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        fieldset {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        fieldset legend {
            padding: 0 0.5rem;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        /* Toast Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 15000;
        }

        .toast {
            background: white;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            min-width: 300px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-success {
            border-left-color: #48bb78;
        }

        .toast-error {
            border-left-color: #e53e3e;
        }

        .toast-warning {
            border-left-color: #ed8936;
        }

        /* Instructions and Help Styles */
        .instructions-banner {
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
            border: 1px solid #4fd1c7;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: block;
        }

        .instructions-banner.hidden {
            display: none;
        }

        .instructions-content {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .instructions-icon {
            color: #319795;
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 0.25rem;
        }

        .instructions-text {
            flex: 1;
        }

        .instructions-text h4 {
            margin: 0 0 0.5rem 0;
            color: #234e52;
            font-size: 1.1rem;
        }

        .instructions-text p {
            margin: 0;
            color: #2d3748;
            line-height: 1.5;
        }

        .instructions-close {
            background: none;
            border: none;
            color: #319795;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .instructions-close:hover {
            background: rgba(49, 151, 149, 0.1);
        }

        .tab-header {
            margin-bottom: 1.5rem;
        }

        .tab-header h2 {
            margin: 0 0 0.5rem 0;
            color: #2d3748;
        }

        .tab-instructions {
            background: #f7fafc;
            border-left: 4px solid #667eea;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .tab-instructions p {
            margin: 0;
            color: #4a5568;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-instructions i {
            color: #667eea;
        }

        .tab-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .form-instructions {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-instructions p {
            margin: 0;
            color: #0c4a6e;
            font-size: 0.9rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .form-instructions i {
            color: #0369a1;
            margin-top: 0.1rem;
            flex-shrink: 0;
        }

        .map-legend-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1rem;
            margin-top: 1rem;
        }

        .map-legend-panel h4 {
            margin: 0 0 1rem 0;
            color: #2d3748;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .legend-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
        }

        .legend-marker.station-marker {
            background: #667eea;
        }

        .legend-marker.platform-marker {
            background: #48bb78;
        }

        .legend-marker.phenocam-marker {
            background: #4299e1;
        }

        .legend-marker.sensor-marker {
            background: #9f7aea;
        }

        /* Google-style Map Markers */
        .google-style-marker {
            position: relative !important;
            background: transparent !important;
        }

        .google-marker-pin {
            position: relative;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .google-marker-pin:hover {
            transform: rotate(-45deg) scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), 0 3px 6px rgba(0, 0, 0, 0.3);
        }

        .google-marker-pin i {
            transform: rotate(45deg);
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .google-marker-shadow {
            position: absolute;
            left: 50%;
            background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.25) 0%, rgba(0, 0, 0, 0.1) 50%, transparent 100%);
            border-radius: 50%;
            transform: translateX(-50%);
            pointer-events: none;
        }

        /* Station marker - Red/Orange like Google Maps */
        .station-pin {
            background: linear-gradient(135deg, #EA4335 0%, #FBBC04 100%);
            width: 32px;
            height: 32px;
        }

        .station-marker .google-marker-shadow {
            width: 32px;
            height: 14px;
            bottom: -6px;
        }

        /* Platform marker - Blue */
        .platform-pin {
            background: linear-gradient(135deg, #4285F4 0%, #34A853 100%);
            width: 28px;
            height: 28px;
        }

        .platform-marker .google-marker-shadow {
            width: 28px;
            height: 12px;
            bottom: -5px;
        }

        /* Instrument marker - Green */
        .instrument-pin {
            background: linear-gradient(135deg, #34A853 0%, #0F9D58 100%);
            width: 24px;
            height: 24px;
        }

        .phenocam-marker .google-marker-shadow {
            width: 24px;
            height: 10px;
            bottom: -4px;
        }

        /* Default marker - Gray */
        .default-pin {
            background: linear-gradient(135deg, #9AA0A6 0%, #5F6368 100%);
            width: 24px;
            height: 24px;
        }

        .default-marker .google-marker-shadow {
            width: 24px;
            height: 10px;
            bottom: -4px;
        }

        /* Professional Map Popups */
        .map-popup {
            font-family: var(--font-family);
            min-width: 250px;
            padding: 0;
        }

        .map-popup h4 {
            margin: 0 0 12px 0;
            color: #1a73e8;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .map-popup p {
            margin: 8px 0;
            font-size: 14px;
            color: #5f6368;
            line-height: 1.4;
        }

        .map-popup strong {
            color: #202124;
            font-weight: 500;
        }

        .popup-actions {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid #e8eaed;
        }

        .popup-actions .btn {
            font-size: 13px;
            padding: 6px 12px;
            font-weight: 500;
        }

        /* Status badges in popups */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-active {
            background: #e8f5e8;
            color: #137333;
        }

        .status-inactive {
            background: #fce8e6;
            color: #d93025;
        }

        .status-unknown {
            background: #f1f3f4;
            color: #5f6368;
        }

        /* Help tooltips */
        .help-tooltip {
            position: relative;
            display: inline-block;
            color: #667eea;
            cursor: help;
            margin-left: 0.25rem;
        }

        .help-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #2d3748;
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .help-tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Platform and Instrument Nested Layout */
        .platform-summary {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: auto;
        }

        .instruments-count {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85rem;
            color: #4a5568;
            background: rgba(102, 126, 234, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
        }

        .platform-actions {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .instruments-section {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 2px solid #e2e8f0;
        }

        .instruments-title {
            margin: 0 0 1rem 0;
            color: #2d3748;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .instruments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 0.75rem;
        }

        .instrument-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .instrument-card:hover {
            background: #f1f5f9;
            border-color: #cbd5e0;
            transform: translateY(-1px);
        }

        .instrument-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .instrument-title {
            font-weight: 500;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .instrument-details {
            margin-bottom: 0.75rem;
        }

        .instrument-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }

        .instrument-meta .meta-label {
            color: #718096;
            font-weight: 500;
        }

        .instrument-meta .meta-value {
            color: #2d3748;
        }

        .instrument-actions {
            display: flex;
            gap: 0.5rem;
        }

        .no-instruments {
            text-align: center;
            padding: 2rem;
            color: #718096;
            font-style: italic;
        }

        .no-instruments i {
            margin-right: 0.5rem;
        }

        /* Map legend styling */
        .legend-note {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e2e8f0;
        }

        .legend-note p {
            margin: 0;
            color: #718096;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .legend-note i {
            color: #4299e1;
            margin-right: 0.25rem;
        }

        /* Custom Map Tooltips */
        .custom-tooltip {
            background: rgba(0, 0, 0, 0.9) !important;
            border: none !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            color: white !important;
            font-family: 'Inter', sans-serif !important;
            font-size: 13px !important;
            line-height: 1.4 !important;
            padding: 0 !important;
            max-width: 220px !important;
        }

        .custom-tooltip::before {
            border-top-color: rgba(0, 0, 0, 0.9) !important;
        }

        .map-tooltip {
            padding: 10px 12px;
            text-align: left;
        }

        .map-tooltip strong {
            font-weight: 600;
            font-size: 14px;
            display: block;
            margin-bottom: 4px;
            color: #ffffff;
        }

        .map-tooltip small {
            display: block;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.3;
            margin-bottom: 2px;
        }

        .map-tooltip small:last-child {
            margin-bottom: 0;
        }

        .station-tooltip {
            border-left: 3px solid #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(0, 0, 0, 0.1) 100%);
        }

        .platform-tooltip {
            border-left: 3px solid #48bb78;
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(0, 0, 0, 0.1) 100%);
        }

        @media (max-width: 768px) {
            .user-info {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .station-meta {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-footer {
                flex-direction: column;
            }

            .toast {
                min-width: 250px;
            }
        }
    </style>

    <!-- Version Meta -->
    <meta name="app-version" content="3.0.0">
    <meta name="build-date" content="2025-09-17">
</head>
<body>
    <!-- Authentication Required Message -->
    <div class="auth-required" id="auth-required">
        <div class="auth-message">
            <div class="login-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h1>Authentication Required</h1>
            <p>You must be logged in to access the stations dashboard. Please log in with your authorized credentials.</p>
            <a href="/login.html" class="btn btn-primary">
                <i class="fas fa-sign-in-alt"></i>
                Login to System
            </a>
        </div>
    </div>

    <!-- Main Dashboard (shown after authentication) -->
    <div class="dashboard" id="dashboard">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-brand">
                    <img src="/images/SITES_spectral_LOGO.png" alt="SITES Spectral" class="brand-logo">
                    <span>SITES Spectral</span>
                </div>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="/stations.html" class="nav-link active">
                            <i class="fas fa-broadcast-tower"></i> Stations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/export.html" class="nav-link">
                            <i class="fas fa-download"></i> Export
                        </a>
                    </li>
                    <li class="nav-item" id="admin-nav" style="display: none;">
                        <a href="/admin/dashboard.html" class="nav-link">
                            <i class="fas fa-cog"></i> Admin
                        </a>
                    </li>
                </ul>
                <div class="nav-user">
                    <span id="nav-username"></span>
                    <a href="#" onclick="logout()" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </nav>

        <!-- User Header -->
        <section class="user-header">
            <div class="container">
                <div class="user-info">
                    <div class="user-details">
                        <h1>Welcome, <span id="user-name"></span></h1>
                        <span class="user-role" id="user-role"></span>
                    </div>
                    <a href="#" onclick="logout()" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- User Instructions Banner -->
                <div class="instructions-banner">
                    <div class="instructions-content">
                        <div class="instructions-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="instructions-text">
                            <h4>Welcome to SITES Spectral Management System</h4>
                            <p id="role-instructions">
                                <!-- Role-specific instructions will be populated here -->
                            </p>
                        </div>
                        <button class="instructions-close" onclick="hideInstructions()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Navigation Tabs -->
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('stations')" title="View and manage research stations">
                        <i class="fas fa-broadcast-tower"></i> Stations & Map
                    </button>
                    <button class="nav-tab" onclick="showTab('platforms')" title="View and manage all platforms">
                        <i class="fas fa-tower-broadcast"></i> All Platforms
                    </button>
                </div>

                <!-- Stations Tab -->
                <div class="tab-content active" id="stations-tab">
                    <div class="tab-header">
                        <h2>Research Stations & Interactive Map</h2>
                        <div class="tab-instructions">
                            <p><i class="fas fa-lightbulb"></i> Explore stations on the interactive map below or browse the station cards. Click map markers to highlight corresponding stations in the list.</p>
                        </div>
                        <div class="tab-actions" id="station-tab-actions" style="display: none;">
                            <button class="btn btn-primary" onclick="createNewStation()" title="Create a new research station">
                                <i class="fas fa-plus"></i> Add New Station
                            </button>
                        </div>
                    </div>

                    <!-- Integrated Map Section -->
                    <div class="map-container">
                        <div id="stations-map" class="interactive-map">
                            <div class="map-loading">
                                <div class="spinner"></div>
                                <p>Loading map...</p>
                            </div>
                        </div>
                        <div class="map-legend-panel">
                            <h4><i class="fas fa-map-signs"></i> Map Legend</h4>
                            <div class="legend-items">
                                <div class="legend-item">
                                    <div class="legend-marker station-marker">
                                        <i class="fas fa-broadcast-tower"></i>
                                    </div>
                                    <span>Research Stations</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-marker platform-marker">
                                        <i class="fas fa-tower-broadcast"></i>
                                    </div>
                                    <span>Platforms (with mounted instruments)</span>
                                </div>
                            </div>
                            <div class="legend-note">
                                <p><i class="fas fa-info-circle"></i> <small>Instruments (phenocams/sensors) are mounted on platforms and share the same location.</small></p>
                            </div>
                        </div>
                    </div>

                    <!-- Stations Grid -->
                    <div class="dashboard-grid" id="stations-grid" style="margin-top: 2rem;">
                        <div class="loading-card">
                            <div class="spinner"></div>
                            <span>Loading stations...</span>
                        </div>
                    </div>
                </div>


                <!-- Platforms Tab -->
                <div class="tab-content" id="platforms-tab">
                    <div class="tab-header">
                        <h2>All Platforms</h2>
                        <div class="tab-instructions">
                            <p><i class="fas fa-lightbulb"></i> View all platforms across your accessible stations. Each platform represents a mounting structure that holds instruments.</p>
                        </div>
                        <div class="tab-actions" id="platform-tab-actions" style="display: none;">
                            <button class="btn btn-primary" onclick="createNewPlatform()" title="Add a new platform">
                                <i class="fas fa-plus"></i> Add New Platform
                            </button>
                        </div>
                    </div>
                    <div class="dashboard-grid" id="platforms-grid">
                        <div class="loading-card">
                            <div class="spinner"></div>
                            <span>Loading platforms...</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-left">
                        <p>&copy; 2025 SITES Spectral. All rights reserved.</p>
                    </div>
                    <div class="footer-right">
                        <p>Version <span id="app-version">3.2.6</span> | Built on <span id="build-date">2025-09-18</span></p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal Forms -->

    <!-- Station Edit Modal -->
    <div class="modal" id="station-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="station-modal-title">Edit Station</h3>
                <button class="modal-close" onclick="closeModal('station-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-instructions">
                    <p><i class="fas fa-info-circle"></i> <strong>Station Information:</strong> Fill in the basic details for this research station. Required fields are marked with an asterisk (*).</p>
                </div>
                <form id="station-form">
                    <input type="hidden" id="station-id">

                    <div class="form-row">
                        <div class="form-group">
                            <label for="station-display-name">Display Name *</label>
                            <input type="text" id="station-display-name" name="display_name" required>
                        </div>
                        <div class="form-group">
                            <label for="station-acronym">Acronym *</label>
                            <input type="text" id="station-acronym" name="acronym" required maxlength="10">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="station-status">Status *</label>
                            <select id="station-status" name="status" required>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Maintenance">Maintenance</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="station-country">Country</label>
                            <input type="text" id="station-country" name="country" value="Sweden">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="station-latitude">Latitude (decimal degrees)</label>
                            <input type="number" id="station-latitude" name="latitude" step="0.0001" min="-90" max="90">
                        </div>
                        <div class="form-group">
                            <label for="station-longitude">Longitude (decimal degrees)</label>
                            <input type="number" id="station-longitude" name="longitude" step="0.0001" min="-180" max="180">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="station-elevation">Elevation (meters)</label>
                        <input type="number" id="station-elevation" name="elevation_m" step="0.1">
                    </div>

                    <div class="form-group">
                        <label for="station-description">Description</label>
                        <textarea id="station-description" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('station-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStation()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Platform Edit Modal -->
    <div class="modal" id="platform-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="platform-modal-title">Edit Platform</h3>
                <button class="modal-close" onclick="closeModal('platform-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-instructions">
                    <p><i class="fas fa-info-circle"></i> <strong>Platform Details:</strong> Platforms are physical mounting structures that hold instruments. Specify the location and technical details.</p>
                </div>
                <form id="platform-form">
                    <input type="hidden" id="platform-id">
                    <input type="hidden" id="platform-station-id">

                    <div class="form-row">
                        <div class="form-group">
                            <label for="platform-display-name">Display Name</label>
                            <input type="text" id="platform-display-name" name="display_name">
                        </div>
                        <div class="form-group">
                            <label for="platform-location-code">Location Code</label>
                            <input type="text" id="platform-location-code" name="location_code" placeholder="BL01, PL01, etc.">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="platform-mounting-structure">Mounting Structure</label>
                            <select id="platform-mounting-structure" name="mounting_structure">
                                <option value="">Select...</option>
                                <option value="Building RoofTop">Building RoofTop</option>
                                <option value="Building Wall">Building Wall</option>
                                <option value="Tower">Tower</option>
                                <option value="Mast">Mast</option>
                                <option value="Flagpole and Tower">Flagpole and Tower</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="platform-height">Platform Height (meters)</label>
                            <input type="number" id="platform-height" name="platform_height_m" step="0.1" min="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="platform-status">Status</label>
                            <select id="platform-status" name="status">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Removed">Removed</option>
                                <option value="Planned">Planned</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="platform-deployment-date">Deployment Date</label>
                            <input type="date" id="platform-deployment-date" name="deployment_date">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="platform-latitude">Latitude (decimal degrees)</label>
                            <input type="number" id="platform-latitude" name="latitude" step="0.0001" min="-90" max="90">
                        </div>
                        <div class="form-group">
                            <label for="platform-longitude">Longitude (decimal degrees)</label>
                            <input type="number" id="platform-longitude" name="longitude" step="0.0001" min="-180" max="180">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="platform-description">Description</label>
                        <textarea id="platform-description" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('platform-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePlatform()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Instrument Edit Modal -->
    <div class="modal" id="instrument-modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 id="instrument-modal-title">Edit Instrument</h3>
                <button class="modal-close" onclick="closeModal('instrument-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-instructions">
                    <p><i class="fas fa-info-circle"></i> <strong>Instrument Configuration:</strong> Configure the detailed specifications for this phenocam or sensor. Use the sections below to organize different types of information.</p>
                </div>
                <form id="instrument-form">
                    <input type="hidden" id="instrument-id">
                    <input type="hidden" id="instrument-platform-id">

                    <!-- Basic Information -->
                    <fieldset>
                        <legend><i class="fas fa-info-circle"></i> Basic Information</legend>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="instrument-display-name">Display Name</label>
                                <input type="text" id="instrument-display-name" name="display_name">
                            </div>
                            <div class="form-group">
                                <label for="instrument-ecosystem">Ecosystem Code</label>
                                <select id="instrument-ecosystem" name="ecosystem_code">
                                    <option value="">Select...</option>
                                    <option value="FOR">Forest (FOR)</option>
                                    <option value="AGR">Agriculture (AGR)</option>
                                    <option value="MIR">Mire (MIR)</option>
                                    <option value="LAK">Lake (LAK)</option>
                                    <option value="WET">Wetland (WET)</option>
                                    <option value="HEA">Heath (HEA)</option>
                                    <option value="SFO">Sub-forest (SFO)</option>
                                    <option value="CEM">Cemetery (CEM)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="instrument-number">Instrument Number</label>
                                <input type="text" id="instrument-number" name="instrument_number" placeholder="PHE01, PHE02, etc.">
                            </div>
                            <div class="form-group">
                                <label for="instrument-status">Status</label>
                                <select id="instrument-status" name="status">
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Removed">Removed</option>
                                    <option value="Planned">Planned</option>
                                    <option value="Unknown">Unknown</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Camera Specifications -->
                    <fieldset>
                        <legend><i class="fas fa-camera"></i> Camera Specifications</legend>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="camera-brand">Camera Brand</label>
                                <select id="camera-brand" name="camera_brand">
                                    <option value="Mobotix">Mobotix</option>
                                    <option value="RedDot">RedDot</option>
                                    <option value="Canon">Canon</option>
                                    <option value="Nikon">Nikon</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="camera-model">Camera Model</label>
                                <input type="text" id="camera-model" name="camera_model" placeholder="M16B, D850, etc.">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="camera-resolution">Camera Resolution</label>
                                <input type="text" id="camera-resolution" name="camera_resolution" placeholder="4096x3072, 2048x1536">
                            </div>
                            <div class="form-group">
                                <label for="camera-serial">Serial Number</label>
                                <input type="text" id="camera-serial" name="camera_serial_number">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Measurement Timeline -->
                    <fieldset>
                        <legend><i class="fas fa-calendar"></i> Measurement Timeline</legend>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="first-measurement-year">First Measurement Year</label>
                                <input type="number" id="first-measurement-year" name="first_measurement_year" min="1990" max="2030">
                            </div>
                            <div class="form-group">
                                <label for="last-measurement-year">Last Measurement Year</label>
                                <input type="number" id="last-measurement-year" name="last_measurement_year" min="1990" max="2030">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="measurement-status">Measurement Status</label>
                                <select id="measurement-status" name="measurement_status">
                                    <option value="Active">Active</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Interrupted">Interrupted</option>
                                    <option value="Planned">Planned</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="deployment-date">Deployment Date</label>
                                <input type="date" id="deployment-date" name="deployment_date">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="removal-date">Removal Date</label>
                            <input type="date" id="removal-date" name="removal_date">
                        </div>
                    </fieldset>

                    <!-- Physical Position -->
                    <fieldset>
                        <legend><i class="fas fa-map-marker-alt"></i> Physical Position</legend>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="instrument-latitude">Latitude (decimal degrees)</label>
                                <input type="number" id="instrument-latitude" name="latitude" step="0.000001" min="-90" max="90">
                            </div>
                            <div class="form-group">
                                <label for="instrument-longitude">Longitude (decimal degrees)</label>
                                <input type="number" id="instrument-longitude" name="longitude" step="0.000001" min="-180" max="180">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="instrument-height">Height Above Ground (meters)</label>
                                <input type="number" id="instrument-height" name="instrument_height_m" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label for="viewing-direction">Viewing Direction</label>
                                <input type="text" id="viewing-direction" name="viewing_direction" placeholder="West, North-West, etc.">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="azimuth-degrees">Azimuth (degrees)</label>
                                <input type="number" id="azimuth-degrees" name="azimuth_degrees" min="0" max="360" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="degrees-from-nadir">Degrees from Nadir</label>
                                <input type="number" id="degrees-from-nadir" name="degrees_from_nadir" min="0" max="90" step="0.1">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Metadata -->
                    <fieldset>
                        <legend><i class="fas fa-sticky-note"></i> Metadata & Notes</legend>
                        <div class="form-group">
                            <label for="instrument-description">Description</label>
                            <textarea id="instrument-description" name="description" rows="2"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="installation-notes">Installation Notes</label>
                            <textarea id="installation-notes" name="installation_notes" rows="2"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="maintenance-notes">Maintenance Notes</label>
                            <textarea id="maintenance-notes" name="maintenance_notes" rows="2"></textarea>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('instrument-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveInstrument()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/js/utils.js?v=3.0.0"></script>
    <script>
        let currentUser = null;
        let stationsMap = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });

        // Check if user is authenticated
        async function checkAuthentication() {
            const token = localStorage.getItem('sites_spectral_token');
            const user = JSON.parse(localStorage.getItem('sites_spectral_user') || 'null');

            if (!token || !user) {
                showAuthRequired();
                return;
            }

            try {
                // Verify token is still valid
                const response = await fetch('/api/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok || !(await response.json()).valid) {
                    throw new Error('Invalid token');
                }

                currentUser = user;
                showDashboard();
                await loadDashboardData();

            } catch (error) {
                console.error('Authentication failed:', error);
                // Clear invalid credentials
                localStorage.removeItem('sites_spectral_token');
                localStorage.removeItem('sites_spectral_user');
                showAuthRequired();
            }
        }

        // Show authentication required message
        function showAuthRequired() {
            document.getElementById('auth-required').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }

        // Show dashboard after successful authentication
        function showDashboard() {
            document.getElementById('auth-required').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            // Update user info
            document.getElementById('user-name').textContent = currentUser.username;
            document.getElementById('user-role').textContent = currentUser.role;
            document.getElementById('nav-username').textContent = currentUser.username;

            // Show admin nav for admin users
            if (currentUser.role === 'admin') {
                document.getElementById('admin-nav').style.display = 'block';
                document.getElementById('station-tab-actions').style.display = 'flex';
                document.getElementById('platform-tab-actions').style.display = 'flex';
            }

            // Set role-specific instructions
            setupRoleInstructions();
        }

        // Setup role-specific instructions
        function setupRoleInstructions() {
            const instructionsElement = document.getElementById('role-instructions');

            switch (currentUser.role) {
                case 'admin':
                    instructionsElement.innerHTML = `
                        As an <strong>Administrator</strong>, you have full access to all stations and instruments. You can:
                         View and edit all research stations and their configurations
                         Manage platforms and instruments across the entire network
                         Create new stations, platforms, and instruments
                         Access detailed maps and export data from all locations
                    `;
                    break;
                case 'station':
                    instructionsElement.innerHTML = `
                        As a <strong>Station User</strong>, you can manage data for your assigned station. You can:
                         View and edit instruments and platforms at your station
                         Update camera specifications and measurement timelines
                         Modify coordinates and physical positioning data
                         Export data and view maps for your station's instruments
                    `;
                    break;
                case 'readonly':
                    instructionsElement.innerHTML = `
                        As a <strong>Read-Only User</strong>, you can view station and instrument information. You can:
                         Browse all available stations and their details
                         View instrument specifications and status information
                         Access interactive maps and visualizations
                         Export available data (contact admin for edit permissions)
                    `;
                    break;
                default:
                    instructionsElement.innerHTML = `
                        Welcome to the SITES Spectral Management System. Use the tabs above to navigate between different views and manage your accessible stations and instruments.
                    `;
            }
        }

        // Hide instructions banner
        function hideInstructions() {
            document.querySelector('.instructions-banner').classList.add('hidden');
            localStorage.setItem('sites_spectral_hide_instructions', 'true');
        }

        // Check if instructions should be hidden
        function checkInstructionsVisibility() {
            const hideInstructions = localStorage.getItem('sites_spectral_hide_instructions');
            if (hideInstructions === 'true') {
                document.querySelector('.instructions-banner').classList.add('hidden');
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            await Promise.all([
                loadStations(),
                loadPlatforms()
            ]);
            // Initialize map after data is loaded
            setTimeout(initializeMap, 500);
        }

        // Load stations based on user role
        async function loadStations() {
            try {
                const token = localStorage.getItem('sites_spectral_token');
                const response = await fetch('/api/stations', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch stations');
                }

                const data = await response.json();
                const stations = data.stations || data;

                renderStations(stations);

            } catch (error) {
                console.error('Error loading stations:', error);
                document.getElementById('stations-grid').innerHTML =
                    '<div class="error-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load stations</p></div>';
                Utils.showToast('Failed to load stations', 'error');
            }
        }

        // Render stations in the grid
        function renderStations(stations) {
            const grid = document.getElementById('stations-grid');

            if (stations.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-broadcast-tower"></i>
                        <p>No stations available</p>
                    </div>
                `;
                return;
            }

            const stationsHTML = stations.map(station => `
                <div class="dashboard-card station-card" onclick="openStation(${station.id})">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-broadcast-tower"></i>
                            ${station.display_name || station.name}
                        </h3>
                    </div>
                    <div class="card-content">
                        <div class="station-meta">
                            <div class="meta-item">
                                <span class="meta-label">Acronym</span>
                                <span class="meta-value">${station.acronym || '-'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Status</span>
                                <span class="meta-value status-badge ${station.status === 'Active' ? 'status-active' : 'status-inactive'}">
                                    ${station.status || 'Unknown'}
                                </span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Country</span>
                                <span class="meta-value">${station.country || '-'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Coordinates</span>
                                <span class="meta-value">
                                    ${station.latitude && station.longitude
                                        ? `${station.latitude.toFixed(4)}, ${station.longitude.toFixed(4)}`
                                        : '-'
                                    }
                                </span>
                            </div>
                        </div>
                        <div class="station-actions">
                            <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openStation(${station.id})">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            ${currentUser.role === 'admin' || (currentUser.role === 'station' && currentUser.station_id === station.id) ? `
                                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); editStation(${station.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            grid.innerHTML = stationsHTML;
        }

        // Load platforms with their instruments
        async function loadPlatforms() {
            try {
                const token = localStorage.getItem('sites_spectral_token');

                // Load both platforms and instruments in parallel
                const [platformsResponse, instrumentsResponse] = await Promise.all([
                    fetch('/api/platforms', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/instruments', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                if (!platformsResponse.ok) {
                    throw new Error('Failed to fetch platforms');
                }
                if (!instrumentsResponse.ok) {
                    throw new Error('Failed to fetch instruments');
                }

                const platformsData = await platformsResponse.json();
                const instrumentsData = await instrumentsResponse.json();

                const platforms = platformsData.platforms || platformsData;
                const instruments = instrumentsData.instruments || instrumentsData;

                // Group instruments by platform_id
                const instrumentsByPlatform = {};
                instruments.forEach(instrument => {
                    if (!instrumentsByPlatform[instrument.platform_id]) {
                        instrumentsByPlatform[instrument.platform_id] = [];
                    }
                    instrumentsByPlatform[instrument.platform_id].push(instrument);
                });

                // Add instruments to each platform
                platforms.forEach(platform => {
                    platform.instruments = instrumentsByPlatform[platform.id] || [];
                });

                renderPlatforms(platforms);

            } catch (error) {
                console.error('Error loading platforms:', error);
                document.getElementById('platforms-grid').innerHTML =
                    '<div class="error-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load platforms</p></div>';
            }
        }

        // Render platforms in the grid with nested instruments
        function renderPlatforms(platforms) {
            const grid = document.getElementById('platforms-grid');

            if (platforms.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tower-broadcast"></i>
                        <p>No platforms available</p>
                    </div>
                `;
                return;
            }

            const platformsHTML = platforms.map(platform => {
                // Render instruments for this platform
                const instrumentsHTML = platform.instruments && platform.instruments.length > 0
                    ? platform.instruments.map(instrument => `
                        <div class="instrument-card" onclick="event.stopPropagation(); openInstrument(${instrument.id})">
                            <div class="instrument-header">
                                <span class="instrument-title">
                                    <i class="fas fa-camera"></i>
                                    ${instrument.display_name || instrument.instrument_number || 'Instrument ' + instrument.id}
                                </span>
                                <span class="status-badge ${instrument.status === 'Active' ? 'status-active' : 'status-inactive'}">
                                    ${instrument.status || 'Unknown'}
                                </span>
                            </div>
                            <div class="instrument-details">
                                <div class="instrument-meta">
                                    <span class="meta-label">Camera:</span>
                                    <span class="meta-value">${instrument.camera_brand || 'N/A'} ${instrument.camera_model || ''}</span>
                                </div>
                                <div class="instrument-meta">
                                    <span class="meta-label">Ecosystem:</span>
                                    <span class="meta-value">${instrument.ecosystem_code || '-'}</span>
                                </div>
                                ${instrument.first_measurement_year ? `
                                    <div class="instrument-meta">
                                        <span class="meta-label">Active Since:</span>
                                        <span class="meta-value">${instrument.first_measurement_year}</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="instrument-actions">
                                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openInstrument(${instrument.id})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                ${currentUser.role === 'admin' || currentUser.role === 'station' ? `
                                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); editInstrument(${instrument.id}, ${platform.id})">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')
                    : '<div class="no-instruments"><i class="fas fa-info-circle"></i> No instruments on this platform</div>';

                return `
                    <div class="dashboard-card platform-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-tower-broadcast"></i>
                                ${platform.display_name || platform.location_code || 'Platform ' + platform.id}
                            </h3>
                            <div class="platform-summary">
                                <span class="instruments-count">
                                    <i class="fas fa-camera"></i> ${platform.instruments ? platform.instruments.length : 0} instruments
                                </span>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="station-meta">
                                <div class="meta-item">
                                    <span class="meta-label">Station</span>
                                    <span class="meta-value">${platform.station_name || '-'}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Location Code</span>
                                    <span class="meta-value">${platform.location_code || '-'}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Mounting Structure</span>
                                    <span class="meta-value">${platform.mounting_structure || '-'}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Status</span>
                                    <span class="meta-value status-badge ${platform.status === 'Active' ? 'status-active' : 'status-inactive'}">
                                        ${platform.status || 'Unknown'}
                                    </span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Platform Height</span>
                                    <span class="meta-value">${platform.platform_height_m ? platform.platform_height_m + 'm' : '-'}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Coordinates</span>
                                    <span class="meta-value">
                                        ${platform.latitude && platform.longitude
                                            ? `${platform.latitude.toFixed(4)}, ${platform.longitude.toFixed(4)}`
                                            : '-'
                                        }
                                    </span>
                                </div>
                            </div>

                            <!-- Platform Actions -->
                            <div class="platform-actions">
                                <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openPlatform(${platform.id})">
                                    <i class="fas fa-eye"></i> View Platform Details
                                </button>
                                ${currentUser.role === 'admin' || currentUser.role === 'station' ? `
                                    <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); editPlatform(${platform.id}, ${platform.station_id || ''})">
                                        <i class="fas fa-edit"></i> Edit Platform
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); createNewInstrument(${platform.id})">
                                        <i class="fas fa-plus"></i> Add Instrument
                                    </button>
                                ` : ''}
                            </div>

                            <!-- Instruments Section -->
                            <div class="instruments-section">
                                <h4 class="instruments-title">
                                    <i class="fas fa-camera"></i> Instruments on this Platform
                                </h4>
                                <div class="instruments-grid">
                                    ${instrumentsHTML}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = platformsHTML;
        }

        // Initialize map when map tab is shown
        async function initializeMap() {
            if (stationsMap) return; // Map already initialized

            const mapContainer = document.getElementById('stations-map');

            stationsMap = L.map(mapContainer, {
                zoomControl: true,
                attributionControl: true
            }).setView([62.0, 15.0], 5); // Center on Sweden

            // Add tile layer
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles  Esri'
            }).addTo(stationsMap);

            try {
                // Load GeoJSON data
                const token = localStorage.getItem('sites_spectral_token');
                const response = await fetch('/api/geojson/all', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch map data');

                const geoJsonData = await response.json();

                // Add markers for each feature
                geoJsonData.features.forEach(feature => {
                    const [lng, lat] = feature.geometry.coordinates;
                    const props = feature.properties;

                    let markerHtml, popupContent, markerClass, iconSize, iconAnchor;

                    switch (props.type) {
                        case 'station':
                            markerHtml = `
                                <div class="google-marker-pin station-pin">
                                    <i class="fas fa-broadcast-tower"></i>
                                </div>
                                <div class="google-marker-shadow"></div>
                            `;
                            markerClass = 'station-marker google-style-marker';
                            popupContent = `
                                <div class="map-popup">
                                    <h4><i class="fas fa-broadcast-tower"></i> ${props.name}</h4>
                                    <p><strong>Acronym:</strong> ${props.acronym || 'N/A'}</p>
                                    <p><strong>Status:</strong> <span class="status-badge status-${(props.status || 'unknown').toLowerCase()}">${props.status || 'Unknown'}</span></p>
                                    <p><strong>Location:</strong> ${props.latitude?.toFixed(4) || lat.toFixed(4)}, ${props.longitude?.toFixed(4) || lng.toFixed(4)}</p>
                                    <div class="popup-actions">
                                        <button class="btn btn-sm btn-primary" onclick="window.location.href='/station.html?id=${props.id}'">
                                            <i class="fas fa-eye"></i> View Station Details
                                        </button>
                                    </div>
                                </div>
                            `;
                            iconSize = [32, 42];
                            iconAnchor = [16, 42];
                            break;
                        case 'platform':
                            markerHtml = `
                                <div class="google-marker-pin platform-pin">
                                    <i class="fas fa-tower-broadcast"></i>
                                </div>
                                <div class="google-marker-shadow"></div>
                            `;
                            markerClass = 'platform-marker google-style-marker';
                            popupContent = `
                                <div class="map-popup">
                                    <h4><i class="fas fa-tower-broadcast"></i> ${props.name}</h4>
                                    <p><strong>Station:</strong> ${props.station_name}</p>
                                    <p><strong>Height:</strong> ${props.platform_height_m ? props.platform_height_m + 'm' : 'N/A'}</p>
                                    <p><strong>Mounting:</strong> ${props.mounting_structure || 'N/A'}</p>
                                    <p><strong>Status:</strong> <span class="status-badge status-${(props.status || 'unknown').toLowerCase()}">${props.status || 'Unknown'}</span></p>
                                    <p><strong>Location:</strong> ${props.latitude?.toFixed(4) || lat.toFixed(4)}, ${props.longitude?.toFixed(4) || lng.toFixed(4)}</p>
                                    <div class="popup-actions">
                                        <button class="btn btn-sm btn-primary" onclick="window.location.href='/platform.html?id=${props.id}'">
                                            <i class="fas fa-eye"></i> View Platform Details
                                        </button>
                                    </div>
                                </div>
                            `;
                            iconSize = [28, 38];
                            iconAnchor = [14, 38];
                            break;
                        default:
                            markerHtml = `
                                <div class="google-marker-pin default-pin">
                                    <i class="fas fa-map-marker"></i>
                                </div>
                                <div class="google-marker-shadow"></div>
                            `;
                            markerClass = 'default-marker google-style-marker';
                            popupContent = `
                                <div class="map-popup">
                                    <h4>${props.name || 'Unknown Location'}</h4>
                                    <p>Location marker</p>
                                </div>
                            `;
                            iconSize = [24, 34];
                            iconAnchor = [12, 34];
                    }

                    const marker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: markerClass,
                            html: markerHtml,
                            iconSize: iconSize,
                            iconAnchor: iconAnchor
                        })
                    });

                    // Create tooltip content based on marker type
                    let tooltipContent = '';
                    if (props.type === 'station') {
                        tooltipContent = `
                            <div class="map-tooltip station-tooltip">
                                <strong>${props.name}</strong><br>
                                <small> ${props.platform_count || 0} platform${(props.platform_count || 0) !== 1 ? 's' : ''}</small><br>
                                <small> ${props.instrument_count || 0} instrument${(props.instrument_count || 0) !== 1 ? 's' : ''} (${props.active_instrument_count || 0} active)</small>
                            </div>
                        `;
                    } else if (props.type === 'platform') {
                        const cameraBrands = props.camera_brands && props.camera_brands.length > 0
                            ? [...new Set(props.camera_brands)].join(', ')
                            : 'N/A';
                        const ecosystems = props.ecosystem_codes && props.ecosystem_codes.length > 0
                            ? [...new Set(props.ecosystem_codes)].join(', ')
                            : 'N/A';

                        tooltipContent = `
                            <div class="map-tooltip platform-tooltip">
                                <strong>${props.name}</strong><br>
                                <small> ${props.station_name}</small><br>
                                <small> ${props.instrument_count || 0} instrument${(props.instrument_count || 0) !== 1 ? 's' : ''} (${props.active_instrument_count || 0} active)</small><br>
                                ${props.instrument_count > 0 ? `<small> ${cameraBrands}</small><br>` : ''}
                                ${props.instrument_count > 0 ? `<small> ${ecosystems}</small>` : ''}
                            </div>
                        `;
                    }

                    // Add click handler for station markers to highlight corresponding card
                    if (props.type === 'station') {
                        marker.on('click', function() {
                            highlightStationCard(props.id);
                        });
                    }

                    marker.addTo(stationsMap);
                    marker.bindPopup(popupContent);

                    // Add tooltip on hover
                    if (tooltipContent) {
                        marker.bindTooltip(tooltipContent, {
                            permanent: false,
                            direction: 'top',
                            offset: [0, -10],
                            className: 'custom-tooltip'
                        });
                    }
                });

                // Remove loading indicator
                document.querySelector('.map-loading').style.display = 'none';

            } catch (error) {
                console.error('Error loading map data:', error);
                document.querySelector('.map-loading').innerHTML =
                    '<i class="fas fa-exclamation-triangle"></i><p>Failed to load map data</p>';
            }
        }

        // Tab switching
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Initialize map if stations tab is shown (since map is integrated)
            if (tabName === 'stations') {
                setTimeout(initializeMap, 100);
            }
        }

        // Open station details
        function openStation(stationId) {
            window.location.href = `/station.html?id=${stationId}`;
        }

        // Edit station
        async function editStation(stationId) {
            try {
                const token = localStorage.getItem('sites_spectral_token');
                const response = await fetch(`/api/stations/${stationId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch station details');
                }

                const station = await response.json();
                populateStationForm(station);
                showModal('station-modal');

            } catch (error) {
                console.error('Error loading station:', error);
                Utils.showToast('Failed to load station details', 'error');
            }
        }

        // Populate station form
        function populateStationForm(station) {
            document.getElementById('station-id').value = station.id || '';
            document.getElementById('station-display-name').value = station.display_name || '';
            document.getElementById('station-acronym').value = station.acronym || '';
            document.getElementById('station-status').value = station.status || 'Active';
            document.getElementById('station-country').value = station.country || 'Sweden';
            document.getElementById('station-latitude').value = station.latitude || '';
            document.getElementById('station-longitude').value = station.longitude || '';
            document.getElementById('station-elevation').value = station.elevation_m || '';
            document.getElementById('station-description').value = station.description || '';

            document.getElementById('station-modal-title').textContent =
                station.id ? 'Edit Station' : 'Create Station';
        }

        // Save station
        async function saveStation() {
            try {
                const form = document.getElementById('station-form');
                const formData = new FormData(form);
                const stationId = document.getElementById('station-id').value;
                const token = localStorage.getItem('sites_spectral_token');

                const data = {};
                for (let [key, value] of formData.entries()) {
                    if (value !== '') {
                        if (key === 'latitude' || key === 'longitude' || key === 'elevation_m') {
                            data[key] = parseFloat(value);
                        } else {
                            data[key] = value;
                        }
                    }
                }

                const url = stationId ? `/api/stations/${stationId}` : '/api/stations';
                const method = stationId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save station');
                }

                Utils.showToast(stationId ? 'Station updated successfully' : 'Station created successfully', 'success');
                closeModal('station-modal');
                loadStations(); // Reload stations list

            } catch (error) {
                console.error('Error saving station:', error);
                Utils.showToast(error.message, 'error');
            }
        }

        // Edit platform
        async function editPlatform(platformId, stationId) {
            try {
                const token = localStorage.getItem('sites_spectral_token');
                const response = await fetch(`/api/platforms/${platformId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch platform details');
                }

                const platform = await response.json();
                populatePlatformForm(platform, stationId);
                showModal('platform-modal');

            } catch (error) {
                console.error('Error loading platform:', error);
                Utils.showToast('Failed to load platform details', 'error');
            }
        }

        // Populate platform form
        function populatePlatformForm(platform, stationId) {
            document.getElementById('platform-id').value = platform.id || '';
            document.getElementById('platform-station-id').value = stationId || platform.station_id || '';
            document.getElementById('platform-display-name').value = platform.display_name || '';
            document.getElementById('platform-location-code').value = platform.location_code || '';
            document.getElementById('platform-mounting-structure').value = platform.mounting_structure || '';
            document.getElementById('platform-height').value = platform.platform_height_m || '';
            document.getElementById('platform-status').value = platform.status || 'Active';
            document.getElementById('platform-deployment-date').value = platform.deployment_date || '';
            document.getElementById('platform-latitude').value = platform.latitude || '';
            document.getElementById('platform-longitude').value = platform.longitude || '';
            document.getElementById('platform-description').value = platform.description || '';

            document.getElementById('platform-modal-title').textContent =
                platform.id ? 'Edit Platform' : 'Create Platform';
        }

        // Save platform
        async function savePlatform() {
            try {
                const form = document.getElementById('platform-form');
                const formData = new FormData(form);
                const platformId = document.getElementById('platform-id').value;
                const token = localStorage.getItem('sites_spectral_token');

                const data = {};
                for (let [key, value] of formData.entries()) {
                    if (value !== '') {
                        if (key === 'latitude' || key === 'longitude' || key === 'platform_height_m') {
                            data[key] = parseFloat(value);
                        } else if (key === 'station_id') {
                            data[key] = parseInt(value);
                        } else {
                            data[key] = value;
                        }
                    }
                }

                const url = platformId ? `/api/platforms/${platformId}` : '/api/platforms';
                const method = platformId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save platform');
                }

                Utils.showToast(platformId ? 'Platform updated successfully' : 'Platform created successfully', 'success');
                closeModal('platform-modal');
                loadPlatforms(); // Reload platforms to show changes

            } catch (error) {
                console.error('Error saving platform:', error);
                Utils.showToast(error.message, 'error');
            }
        }

        // Edit instrument
        async function editInstrument(instrumentId, platformId) {
            try {
                const token = localStorage.getItem('sites_spectral_token');
                const response = await fetch(`/api/instruments/${instrumentId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch instrument details');
                }

                const instrument = await response.json();
                populateInstrumentForm(instrument, platformId);
                showModal('instrument-modal');

            } catch (error) {
                console.error('Error loading instrument:', error);
                Utils.showToast('Failed to load instrument details', 'error');
            }
        }

        // Populate instrument form
        function populateInstrumentForm(instrument, platformId) {
            document.getElementById('instrument-id').value = instrument.id || '';
            document.getElementById('instrument-platform-id').value = platformId || instrument.platform_id || '';
            document.getElementById('instrument-display-name').value = instrument.display_name || '';
            document.getElementById('instrument-ecosystem').value = instrument.ecosystem_code || '';
            document.getElementById('instrument-number').value = instrument.instrument_number || '';
            document.getElementById('instrument-status').value = instrument.status || 'Active';

            // Camera specifications
            document.getElementById('camera-brand').value = instrument.camera_brand || 'Mobotix';
            document.getElementById('camera-model').value = instrument.camera_model || '';
            document.getElementById('camera-resolution').value = instrument.camera_resolution || '';
            document.getElementById('camera-serial').value = instrument.camera_serial_number || '';

            // Measurement timeline
            document.getElementById('first-measurement-year').value = instrument.first_measurement_year || '';
            document.getElementById('last-measurement-year').value = instrument.last_measurement_year || '';
            document.getElementById('measurement-status').value = instrument.measurement_status || 'Active';
            document.getElementById('deployment-date').value = instrument.deployment_date || '';
            document.getElementById('removal-date').value = instrument.removal_date || '';

            // Physical position
            document.getElementById('instrument-latitude').value = instrument.latitude || '';
            document.getElementById('instrument-longitude').value = instrument.longitude || '';
            document.getElementById('instrument-height').value = instrument.instrument_height_m || '';
            document.getElementById('viewing-direction').value = instrument.viewing_direction || '';
            document.getElementById('azimuth-degrees').value = instrument.azimuth_degrees || '';
            document.getElementById('degrees-from-nadir').value = instrument.degrees_from_nadir || '';

            // Metadata
            document.getElementById('instrument-description').value = instrument.description || '';
            document.getElementById('installation-notes').value = instrument.installation_notes || '';
            document.getElementById('maintenance-notes').value = instrument.maintenance_notes || '';

            document.getElementById('instrument-modal-title').textContent =
                instrument.id ? 'Edit Instrument' : 'Create Instrument';
        }

        // Save instrument
        async function saveInstrument() {
            try {
                const form = document.getElementById('instrument-form');
                const formData = new FormData(form);
                const instrumentId = document.getElementById('instrument-id').value;
                const token = localStorage.getItem('sites_spectral_token');

                const data = {};
                for (let [key, value] of formData.entries()) {
                    if (value !== '') {
                        if (['latitude', 'longitude', 'instrument_height_m', 'azimuth_degrees', 'degrees_from_nadir'].includes(key)) {
                            data[key] = parseFloat(value);
                        } else if (['platform_id', 'first_measurement_year', 'last_measurement_year'].includes(key)) {
                            data[key] = parseInt(value);
                        } else {
                            data[key] = value;
                        }
                    }
                }

                const url = instrumentId ? `/api/instruments/${instrumentId}` : '/api/instruments';
                const method = instrumentId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save instrument');
                }

                Utils.showToast(instrumentId ? 'Instrument updated successfully' : 'Instrument created successfully', 'success');
                closeModal('instrument-modal');
                loadPlatforms(); // Reload platforms to show updated instruments

            } catch (error) {
                console.error('Error saving instrument:', error);
                Utils.showToast(error.message, 'error');
            }
        }

        // Modal management functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        });

        // Create new station (admin only)
        function createNewStation() {
            populateStationForm({}); // Empty station object for new creation
            showModal('station-modal');
        }

        // Create new platform (admin only)
        function createNewPlatform() {
            populatePlatformForm({}); // Empty platform object for new creation
            showModal('platform-modal');
        }

        // Create new instrument (admin only)
        function createNewInstrument(platformId = null) {
            const instrumentData = {};
            if (platformId) {
                instrumentData.platform_id = platformId;
            }
            populateInstrumentForm(instrumentData, platformId);
            showModal('instrument-modal');
        }

        // Open platform details
        function openPlatform(platformId) {
            window.location.href = `/platform.html?id=${platformId}`;
        }

        // Open instrument details
        function openInstrument(instrumentId) {
            window.location.href = `/instrument.html?id=${instrumentId}`;
        }

        // Initialize instructions visibility on load
        document.addEventListener('DOMContentLoaded', function() {
            checkInstructionsVisibility();
        });

        // Highlight station card when map marker is clicked
        function highlightStationCard(stationId) {
            // Remove existing highlights
            document.querySelectorAll('.station-card.highlighted').forEach(card => {
                card.classList.remove('highlighted');
            });

            // Find and highlight the station card
            const stationCards = document.querySelectorAll('.station-card');
            stationCards.forEach(card => {
                const cardOnClick = card.getAttribute('onclick');
                if (cardOnClick && cardOnClick.includes(`openStation(${stationId})`)) {
                    card.classList.add('highlighted');
                    // Scroll to the highlighted card
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }

        // Logout function
        function logout() {
            localStorage.removeItem('sites_spectral_token');
            localStorage.removeItem('sites_spectral_user');
            window.location.href = '/login.html';
        }

        // Global utility functions
        window.Utils = {
            showToast: function(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;

                const container = document.getElementById('toast-container');
                container.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        container.removeChild(toast);
                    }, 300);
                }, 3000);
            }
        };
    </script>
</body>
</html>