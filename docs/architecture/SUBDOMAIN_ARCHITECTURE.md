# SITES Spectral Subdomain Architecture

> **Architecture Credit**: This subdomain-based architecture design is based on
> architectural knowledge shared by **Flights for Biodiversity Sweden AB**
> (https://github.com/flightsforbiodiversity).

## Version History

| Version | Date | Author | Description |
|---------|------|--------|-------------|
| 15.0.0 | 2026-01-24 | SITES Spectral Team | Initial subdomain architecture |

---

## Executive Summary

Migration from single-domain (`sitesspectral.work`) to subdomain-based architecture with Cloudflare Access authentication.

| Current State | Target State |
|---------------|--------------|
| Single domain, all features | `sitesspectral.work` - Public only |
| Database password auth | `admin.sitesspectral.work` - Global admins (CF Access) |
| 5 roles mixed | `{station}.sitesspectral.work` - Station portals (CF Access) |

---

## Architecture Overview

### Portal Types

```
sitesspectral.work (Public)
│
├── No authentication required
├── Public dashboard with station map
├── Station status indicators
└── Platform/instrument counts

admin.sitesspectral.work (Admin Portal)
│
├── Cloudflare Access OTP required
├── Global admin emails only
└── Full system access (all stations)

{station}.sitesspectral.work (Station Portals)
│
├── Cloudflare Access or Magic Link
├── Station-specific admin emails
├── UAV pilot access per station
└── Read-only via magic links
```

### Request Flow

```
Request → Cloudflare CDN → CF Access Check → Worker
                                               │
                                               ├── getSubdomain()
                                               │
                                               ├── getPortalType()
                                               │
                                               └── Route to appropriate handler
```

---

## User Model

| User Type | Authentication | Access |
|-----------|----------------|--------|
| **Global Admins** | CF Access passwordless (email OTP) | Full system access |
| **Station Admins** | CF Access passwordless (email OTP) | Their station only |
| **UAV Pilots** | CF Access by email (per station) | Mission/flight logging |
| **Station Internal** | Magic links (generated by admins) | Read-only station view |
| **Public** | None | Public metrics only |

### Roles

| Role | Permissions | Portal Access |
|------|-------------|---------------|
| `admin` | All | Admin, any station |
| `sites-admin` | All | Admin, any station |
| `station-admin` | CRUD for station | Their station |
| `station` | Read only | Their station |
| `uav-pilot` | Read + flight logs | Authorized stations |
| `station-internal` | Read only | Station via magic link |
| `readonly` | Read only | Public only |

---

## Subdomain Routing

### Detection Algorithm

```javascript
function getSubdomain(request) {
  const host = request.headers.get('Host');
  const parts = host.split('.');

  // subdomain.sitesspectral.work
  if (parts.length === 3 && parts[1] === 'sitesspectral' && parts[2] === 'work') {
    return parts[0];
  }

  return null; // Root domain
}
```

### Portal Type Mapping

| Subdomain | Portal Type | Authentication |
|-----------|-------------|----------------|
| (none) | `public` | None |
| `www` | `public` | None |
| `admin` | `admin` | CF Access required |
| Any other | `station` | CF Access or Magic Link |

---

## Cloudflare Access Integration

### JWT Verification

The Worker verifies Cloudflare Access JWT tokens from the `Cf-Access-Jwt-Assertion` header:

```javascript
import { createRemoteJWKSet, jwtVerify } from 'jose';

const jwks = createRemoteJWKSet(
  new URL('https://sitesspectral.cloudflareaccess.com/cdn-cgi/access/certs')
);

const { payload } = await jwtVerify(jwt, jwks, {
  issuer: 'https://sitesspectral.cloudflareaccess.com'
});
```

### User Mapping

CF Access email is mapped to user records in the database:

1. Check `users.cf_access_email` for existing user
2. If not found, check `uav_pilots.email`
3. For global admins, check against whitelist
4. Return role and permissions based on match

---

## Magic Links

### Token Specification

| Property | Value |
|----------|-------|
| Algorithm | 256-bit cryptographic random |
| Storage | SHA-256 hash only (token never stored) |
| Default Expiry | 7 days |
| Single-use | Optional |
| Scope | Station-specific read-only |

### Token Flow

```
1. Station Admin creates magic link
   └── POST /api/v11/magic-links/create

2. Token generated, hash stored in DB
   └── Raw token returned ONCE to creator

3. Link shared via email/message
   └── https://{station}.sitesspectral.work/auth/magic?token={token}

4. User clicks link, token validated
   └── GET /api/v11/magic-links/validate?token={token}

5. Session JWT issued (8 hour expiry)
   └── httpOnly cookie set
```

---

## DNS Configuration

### Required Records

| Type | Name | Target | Proxied |
|------|------|--------|---------|
| CNAME | @ | sites-spectral-instruments.jose-e5f.workers.dev | Yes |
| CNAME | admin | sites-spectral-instruments.jose-e5f.workers.dev | Yes |
| CNAME | * | sites-spectral-instruments.jose-e5f.workers.dev | Yes |

> **Note**: Wildcard CNAME requires Cloudflare Pro plan or higher for SSL coverage.

### Alternative (Individual Station Records)

| Type | Name | Target |
|------|------|--------|
| CNAME | svartberget | sites-spectral-instruments.jose-e5f.workers.dev |
| CNAME | abisko | sites-spectral-instruments.jose-e5f.workers.dev |
| CNAME | lonnstorp | sites-spectral-instruments.jose-e5f.workers.dev |
| ... | ... | ... |

---

## CORS Configuration

### Dynamic Origin Support

Origins are allowed based on pattern matching:

```javascript
// Static whitelist
const ALLOWED_ORIGINS = [
  'https://sitesspectral.work',
  'https://admin.sitesspectral.work',
  // ... development URLs
];

// Dynamic pattern matching
if (host.endsWith('.sitesspectral.work')) {
  const subdomain = host.replace('.sitesspectral.work', '');
  if (/^[a-z0-9-]+$/.test(subdomain)) {
    return true; // Valid station subdomain
  }
}
```

---

## Security Considerations

### Authentication Layers

1. **Cloudflare Access** (Edge)
   - Enforced before request reaches Worker
   - Email-based OTP (passwordless)
   - Session duration configurable

2. **Worker Verification** (Application)
   - JWT signature verification
   - Email-to-user mapping
   - Role-based access control

3. **Magic Links** (Alternative)
   - For users without email access
   - Time-limited, station-scoped
   - Revocable by admins

### Bypass Rules

CF Access should bypass authentication for:

- `/api/public/*` - Public API endpoints
- `/api/health` - Health checks
- `/css/*`, `/js/*`, `/images/*` - Static assets
- `/favicon.ico`, `/robots.txt` - Standard files

---

## Database Changes

### New Tables

- `magic_link_tokens` - Token storage and tracking
- `uav_pilots` - Pilot registry
- `uav_missions` - Mission planning/execution
- `mission_pilots` - Pilot-mission assignments
- `uav_flight_logs` - Individual flight records
- `uav_batteries` - Battery inventory

### Schema Changes

```sql
-- Users table extensions
ALTER TABLE users ADD COLUMN auth_provider TEXT DEFAULT 'database';
ALTER TABLE users ADD COLUMN cf_access_email TEXT;
ALTER TABLE users ADD COLUMN cf_access_identity_id TEXT;
ALTER TABLE users ADD COLUMN last_cf_access_login DATETIME;
```

---

## Rollback Plan

If issues arise:

1. Revert wrangler.toml routes to single domain
2. Disable CF Access applications
3. Re-enable legacy password authentication
4. DNS changes can remain (no impact without Access policies)

---

## Related Documentation

- [[CLOUDFLARE_ACCESS_INTEGRATION]] - Detailed CF Access setup
- [[MAGIC_LINK_SYSTEM]] - Magic link implementation details
- [[UAV_PILOT_SYSTEM]] - UAV pilot and mission management
