# Phenocam Image Management Guide

This document explains how to update representative phenocam images for the SITES Spectral Instruments Dashboard.

## Overview

Representative phenocam images are displayed in two locations:
1. **Instrument Card Thumbnails** - Small preview on the platform card
2. **Instrument Details Modal** - Full-size image with zoom capability

## Image Storage Location

Images are stored as static files in the Cloudflare Workers deployment:

```
public/images/stations/{station_dir}/instruments/{normalized_name}.jpg
```

### Station Directory Mapping

| Station Acronym | Directory Name | Full Path Example |
|-----------------|----------------|-------------------|
| ANS | abisko | `/images/stations/abisko/instruments/` |
| ASA | asa | `/images/stations/asa/instruments/` |
| GRI | grimso | `/images/stations/grimso/instruments/` |
| LON | lonnstorp | `/images/stations/lonnstorp/instruments/` |
| RBD | robacksdalen | `/images/stations/robacksdalen/instruments/` |
| SKC | skogaryd | `/images/stations/skogaryd/instruments/` |
| SVB | svartberget | `/images/stations/svartberget/instruments/` |

### Image Naming Convention

The image filename must match the instrument's **normalized name** exactly:

```
{STATION}_{ECOSYSTEM}_{PLATFORM}_{TYPE}{NUMBER}.jpg

Examples:
ANS_FOR_BL01_PHE01.jpg
LON_AGR_PL01_PHE01.jpg
SVB_MIR_PL03_PHE01.jpg
```

## How to Update a Phenocam Image

### Step 1: Prepare the Image

1. Select a representative L1-processed phenocam image
2. Recommended image specifications:
   - Format: JPEG (`.jpg`)
   - Resolution: Original camera resolution (typically 3264x2448 or similar)
   - File size: 500KB - 4MB recommended

### Step 2: Copy Image to Correct Location

```bash
# Navigate to the project directory
cd /lunarc/nobackup/projects/sitesspec/SITES/Spectral/apps/sites-spectral-instruments

# Copy image to correct location
# Replace {station_dir} and {normalized_name} with actual values
cp /path/to/source/image.jpg public/images/stations/{station_dir}/instruments/{normalized_name}.jpg

# Example for ANS_FOR_BL01_PHE01:
cp ~/phenocam_images/abisko_sample.jpg public/images/stations/abisko/instruments/ANS_FOR_BL01_PHE01.jpg
```

### Step 3: Update the Manifest (Optional)

Update the manifest file for tracking purposes:

```bash
# View current manifest
cat public/images/stations/instrument-images-manifest.json

# The manifest is automatically generated by scripts, but you can manually update it
```

### Step 4: Deploy to Production

```bash
# Build and deploy (bumps version automatically)
npm run deploy:bump

# Or build first, then deploy
npm run build
npm run deploy
```

### Step 5: Verify Deployment

1. Open the station dashboard: `https://sites.jobelab.com/station-dashboard?station={ACRONYM}`
2. Click on the phenocam instrument card
3. Verify the image loads in the details modal
4. Click the image to test the zoom functionality

## Image Manifest

A manifest file tracks all instrument images:

**Location:** `public/images/stations/instrument-images-manifest.json`

**Structure:**
```json
{
  "generated": "2025-09-19T16:05:04.696Z",
  "totalInstruments": 23,
  "successCount": 13,
  "failedCount": 10,
  "instruments": [
    {
      "instrumentId": "ANS_FOR_BL01_PHE01",
      "stationAcronym": "ANS",
      "success": true,
      "sourceFilename": "abisko_ANS_FOR_BL01_PHE01_2025_146_20250526_120848.jpg",
      "year": "2025",
      "timestamp": "2025-05-26 12:08:48",
      "imageDate": "2025-05-26",
      "dayOfYear": 146,
      "sizeKB": 3909,
      "error": null
    }
  ]
}
```

## Bulk Image Update Script

For updating multiple images at once, you can use a script:

```bash
#!/bin/bash
# update_phenocam_images.sh

# Source directory containing processed L1 images
SOURCE_DIR="/path/to/l1/images"

# Destination base directory
DEST_BASE="public/images/stations"

# Station mapping
declare -A STATIONS=(
    ["ANS"]="abisko"
    ["ASA"]="asa"
    ["GRI"]="grimso"
    ["LON"]="lonnstorp"
    ["RBD"]="robacksdalen"
    ["SKC"]="skogaryd"
    ["SVB"]="svartberget"
)

# Function to copy latest image for an instrument
update_instrument_image() {
    local instrument_id=$1
    local station_acronym=${instrument_id:0:3}
    local station_dir=${STATIONS[$station_acronym]}

    if [ -z "$station_dir" ]; then
        echo "Unknown station: $station_acronym"
        return 1
    fi

    local dest_dir="$DEST_BASE/$station_dir/instruments"
    local dest_file="$dest_dir/${instrument_id}.jpg"

    # Find latest image for this instrument (adjust pattern as needed)
    local source_file=$(ls -t "$SOURCE_DIR"/*${instrument_id}*.jpg 2>/dev/null | head -1)

    if [ -f "$source_file" ]; then
        mkdir -p "$dest_dir"
        cp "$source_file" "$dest_file"
        echo "Updated: $instrument_id"
    else
        echo "No image found for: $instrument_id"
    fi
}

# Update specific instruments
# update_instrument_image "ANS_FOR_BL01_PHE01"
# update_instrument_image "LON_AGR_PL01_PHE01"

# Or update all from a list
# cat instruments.txt | while read inst; do update_instrument_image "$inst"; done
```

## Troubleshooting

### Image Not Loading

1. **Check file exists:**
   ```bash
   ls -la public/images/stations/{station_dir}/instruments/{normalized_name}.jpg
   ```

2. **Verify filename matches normalized_name exactly** (case-sensitive)

3. **Check file permissions:**
   ```bash
   chmod 644 public/images/stations/{station_dir}/instruments/{normalized_name}.jpg
   ```

4. **Clear browser cache** and hard refresh (Ctrl+Shift+R)

5. **Redeploy** if image was added after last deployment:
   ```bash
   npm run deploy
   ```

### Image Shows SITES Logo Placeholder

This means either:
- No image file exists for this instrument
- Image file failed to load (wrong filename, corrupted file)
- Station acronym is not in the mapping

### Image Shows Loading Spinner Forever

Check browser console (F12) for errors. Common issues:
- CORS issues (shouldn't happen with static files)
- Network connectivity problems

## Current Image Status

As of the last manifest generation:

| Status | Count |
|--------|-------|
| Images Available | 13 |
| Images Missing | 10 |
| **Total Instruments** | **23** |

### Instruments with Images

- ANS_FOR_BL01_PHE01 (Abisko)
- GRI_FOR_BL01_PHE01 (Grimsö)
- LON_AGR_PL01_PHE01, PHE02, PHE03 (Lönnstorp)
- RBD_AGR_PL01_PHE01, PL02_PHE01 (Röbäcksdalen)
- SKC_CEM_FOR_PL01_PHE01, PL02_PHE01, PL03_PHE01 (Skogaryd)
- SKC_LAK_PL01_PHE01 (Skogaryd Lake)
- SKC_MAD_FOR_PL02_PHE01 (Skogaryd)
- SKC_MAD_WET_PL01_PHE01 (Skogaryd)

### Instruments Missing Images

- ASA stations (no L1 images processed)
- SVB stations (no L1 images processed)
- Some SKC/STM stations

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 9.0.23 | 2025-12-03 | Fixed static image path loading |
| 9.0.21 | 2025-12-03 | Added loading spinner and fallback |
| 9.0.20 | 2025-12-03 | Added click-to-zoom functionality |
