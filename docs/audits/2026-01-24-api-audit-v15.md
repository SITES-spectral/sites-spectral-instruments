# API Endpoint Audit Report - v15.0.0

> **Audited by:** @spectrum (API Expert)
> **Date:** 2026-01-24
> **Application Version:** 15.0.0
> **OpenAPI Spec Version:** 13.4.0 (OUTDATED - needs update to 15.0.0)

---

## Executive Summary

This audit identifies significant gaps between the OpenAPI specification, implemented handlers, and router wiring in SITES Spectral webapp v15.0.0. The most critical finding is that new v15.0.0 features (magic links, public API, UAV domain) have handler implementations but are **NOT wired into the routing layer**.

| Category | Count |
|----------|-------|
| Endpoints in OpenAPI | ~85 |
| Endpoints Implemented | ~90+ |
| **Broken/Missing Wiring** | **3 major areas** |
| Authentication Gaps | 2 |
| OpenAPI Version Mismatch | Yes (13.4.0 vs 15.0.0) |

---

## Critical Issues

### 1. BROKEN: Magic Links Handler NOT Wired

**Status:** CRITICAL - Handler exists but NOT routed

**Files:**
- Handler: `/src/handlers/magic-links.js` (482 lines, complete implementation)
- Router: `/src/infrastructure/http/router.js` (no import or route)
- API Handler: `/src/api-handler.js` (no import or route)

**Expected Endpoints (NOT ACCESSIBLE):**
| Endpoint | Method | Auth Required | Implementation Status |
|----------|--------|---------------|----------------------|
| `/api/v11/magic-links/create` | POST | admin, sites-admin, station-admin | Handler exists, NOT routed |
| `/api/v11/magic-links/validate` | GET | None (public) | Handler exists, NOT routed |
| `/api/v11/magic-links/revoke` | POST | admin, sites-admin, station-admin | Handler exists, NOT routed |
| `/api/v11/magic-links/list` | GET | admin, sites-admin, station-admin | Handler exists, NOT routed |

**Impact:** Station internal users cannot use passwordless authentication via magic links.

**Fix Required:** Add to `router.js`:
```javascript
import { handleMagicLinks } from '../../handlers/magic-links.js';

// In router switch statement:
case 'magic-links':
  return await handleMagicLinks(request.method, resourcePath, request, env);
```

---

### 2. BROKEN: Public API Handler NOT Wired

**Status:** CRITICAL - Handler exists but NOT routed

**Files:**
- Handler: `/src/handlers/public.js` (359 lines, complete implementation)
- Router: `/src/infrastructure/http/router.js` (no import or route)
- API Handler: `/src/api-handler.js` (no import or route)

**Expected Endpoints (NOT ACCESSIBLE):**
| Endpoint | Method | Auth Required | Implementation Status |
|----------|--------|---------------|----------------------|
| `/api/public/stations` | GET | None | Handler exists, NOT routed |
| `/api/public/station/{id}` | GET | None | Handler exists, NOT routed |
| `/api/public/health` | GET | None | Handler exists, NOT routed |
| `/api/public/metrics` | GET | None | Handler exists, NOT routed |

**Impact:** Public dashboard cannot fetch station data without authentication.

**Fix Required:** Add to `api-handler.js`:
```javascript
import { handlePublicApi } from './handlers/public.js';

// In switch statement:
case 'public':
  return await handlePublicApi(method, pathSegments.slice(1), request, env);
```

---

### 3. INCOMPLETE: UAV Domain Entities Without Controllers

**Status:** HIGH - Domain entities exist but no API endpoints

**Files:**
- Domain Entities:
  - `/src/domain/uav/Pilot.js` (256 lines)
  - `/src/domain/uav/Mission.js` (364 lines)
  - `/src/domain/uav/FlightLog.js` (282 lines)
- **Missing:**
  - No `UAVController.js` in `/src/infrastructure/http/controllers/`
  - No routes in `router.js`
  - No repository implementations

**Expected Endpoints (NOT IMPLEMENTED):**
| Endpoint | Method | Auth Required | Status |
|----------|--------|---------------|--------|
| `/api/v11/uav/pilots` | GET | uav-pilot, station-admin, admin | NOT IMPLEMENTED |
| `/api/v11/uav/pilots` | POST | station-admin, admin | NOT IMPLEMENTED |
| `/api/v11/uav/pilots/{id}` | GET/PUT/DELETE | varies | NOT IMPLEMENTED |
| `/api/v11/uav/missions` | GET | station, admin | NOT IMPLEMENTED |
| `/api/v11/uav/missions` | POST | uav-pilot, station-admin | NOT IMPLEMENTED |
| `/api/v11/uav/missions/{id}` | GET/PUT/DELETE | varies | NOT IMPLEMENTED |
| `/api/v11/uav/missions/{id}/approve` | POST | station-admin, admin | NOT IMPLEMENTED |
| `/api/v11/uav/flight-logs` | GET/POST | uav-pilot | NOT IMPLEMENTED |

**Impact:** UAV pilot management, mission planning, and flight logging features are not accessible via API.

---

## Endpoint Coverage Matrix

### Authentication Endpoints

| Endpoint | OpenAPI | Implemented | Auth | Status |
|----------|---------|-------------|------|--------|
| `POST /auth/login` | Yes | Yes | None | OK |
| `GET /auth/verify` | Yes | Yes | Bearer/Cookie | OK |
| `GET /auth/me` | Yes | Yes | Bearer/Cookie | OK |
| `POST /auth/logout` | Yes | Yes | Bearer/Cookie | OK |

### Station Endpoints

| Endpoint | OpenAPI | Implemented | Auth | Status |
|----------|---------|-------------|------|--------|
| `GET /stations` | Yes | Yes | Bearer/Cookie | OK |
| `POST /stations` | Yes | Yes | admin | OK |
| `GET /stations/{id}` | Yes | Yes | Bearer/Cookie | OK |
| `PUT /stations/{id}` | Yes | Yes | admin | OK |
| `DELETE /stations/{id}` | Yes | Yes | admin | OK |
| `GET /stations/{acronym}/dashboard` | Yes | Yes | Bearer/Cookie | OK |

### Platform Endpoints

| Endpoint | OpenAPI | Implemented | Auth | Status |
|----------|---------|-------------|------|--------|
| `GET /platforms` | Yes | Yes | Bearer/Cookie | OK |
| `POST /platforms` | Yes | Yes | write | OK |
| `GET /platforms/{id}` | Yes | Yes | Bearer/Cookie | OK |
| `PUT /platforms/{id}` | Yes | Yes | write | OK |
| `DELETE /platforms/{id}` | Yes | Yes | delete | OK |
| `GET /platforms/station/{stationId}` | Yes | Yes | Bearer/Cookie | OK |
| `GET /platforms/type/{type}` | Yes | Yes | Bearer/Cookie | OK |

### Instrument Endpoints

| Endpoint | OpenAPI | Implemented | Auth | Status |
|----------|---------|-------------|------|--------|
| `GET /instruments` | Yes | Yes | Bearer/Cookie | OK |
| `POST /instruments` | Yes | Yes | write | OK |
| `GET /instruments/{id}` | Yes | Yes | Bearer/Cookie | OK |
| `PUT /instruments/{id}` | Yes | Yes | write | OK |
| `DELETE /instruments/{id}` | Yes | Yes | delete | OK |
| `GET /instruments/{id}/details` | Yes | Yes | Bearer/Cookie | OK |
| `GET /instruments/platform/{platformId}` | Yes | Yes | Bearer/Cookie | OK |
| `GET /instruments/station/{stationId}` | Yes | Yes | Bearer/Cookie | OK |

### Maintenance Endpoints

| Endpoint | OpenAPI | Implemented | Auth | Status |
|----------|---------|-------------|------|--------|
| `GET /maintenance` | Yes | Yes | Bearer/Cookie | OK |
| `POST /maintenance` | Yes | Yes | write | OK |
| `GET /maintenance/{id}` | Yes | Yes | Bearer/Cookie | OK |
| `PUT /maintenance/{id}` | Yes | Yes | write | OK |
| `DELETE /maintenance/{id}` | Yes | Yes | delete | OK |
| `GET /maintenance/timeline` | Yes | Yes | Bearer/Cookie | OK |
| `GET /maintenance/pending` | Yes | Yes | Bearer/Cookie | OK |
| `GET /maintenance/overdue` | Yes | Yes | Bearer/Cookie | OK |
| `POST /maintenance/{id}/complete` | Yes | Yes | write | OK |

### Calibration Endpoints

| Endpoint | OpenAPI | Implemented | Auth | Status |
|----------|---------|-------------|------|--------|
| `GET /calibrations` | Yes | Yes | Bearer/Cookie | OK |
| `POST /calibrations` | Yes | Yes | write | OK |
| `GET /calibrations/{id}` | Yes | Yes | Bearer/Cookie | OK |
| `PUT /calibrations/{id}` | Yes | Yes | write | OK |
| `DELETE /calibrations/{id}` | Yes | Yes | delete | OK |
| `GET /calibrations/timeline` | Yes | Yes | Bearer/Cookie | OK |
| `GET /calibrations/current` | Yes | Yes | Bearer/Cookie | OK |
| `GET /calibrations/expired` | Yes | Yes | Bearer/Cookie | OK |
| `GET /calibrations/expiring` | Yes | Yes | Bearer/Cookie | OK |
| `POST /calibrations/{id}/expire` | Yes | Yes | write | OK |

### ROI Endpoints

| Endpoint | OpenAPI | Implemented | Auth | Status |
|----------|---------|-------------|------|--------|
| `GET /rois` | Yes | Yes | Bearer/Cookie | OK |
| `POST /rois` | Yes | Yes | write | OK |
| `GET /rois/{id}` | Yes | Yes | Bearer/Cookie | OK |
| `PUT /rois/{id}` | Yes | Yes | write | OK |
| `DELETE /rois/{id}` | Yes | Yes | delete | OK |

### System Endpoints

| Endpoint | OpenAPI | Implemented | Auth | Status |
|----------|---------|-------------|------|--------|
| `GET /health` | Yes | Yes | None | OK |
| `GET /info` | Yes | Yes | None | OK |
| `GET /version` | No | Yes | None | MISSING FROM OPENAPI |

### New v15 Endpoints (NOT IN OPENAPI)

| Endpoint | OpenAPI | Implemented | Auth | Status |
|----------|---------|-------------|------|--------|
| `POST /magic-links/create` | No | Yes (NOT ROUTED) | admin roles | BROKEN |
| `GET /magic-links/validate` | No | Yes (NOT ROUTED) | None | BROKEN |
| `POST /magic-links/revoke` | No | Yes (NOT ROUTED) | admin roles | BROKEN |
| `GET /magic-links/list` | No | Yes (NOT ROUTED) | admin roles | BROKEN |
| `GET /public/stations` | No | Yes (NOT ROUTED) | None | BROKEN |
| `GET /public/station/{id}` | No | Yes (NOT ROUTED) | None | BROKEN |
| `GET /public/health` | No | Yes (NOT ROUTED) | None | BROKEN |
| `GET /public/metrics` | No | Yes (NOT ROUTED) | None | BROKEN |

### Additional Implemented Endpoints (NOT IN OPENAPI)

| Endpoint | OpenAPI | Implemented | Auth | Status |
|----------|---------|-------------|------|--------|
| `GET/POST/PUT/DELETE /aois/*` | No | Yes | varies | MISSING FROM OPENAPI |
| `GET/POST/PUT/DELETE /campaigns/*` | No | Yes | varies | MISSING FROM OPENAPI |
| `GET/POST/PUT/DELETE /products/*` | No | Yes | varies | MISSING FROM OPENAPI |
| `GET /analytics/*` | No | Yes | admin | MISSING FROM OPENAPI |
| `GET /export/*` | No | Yes | Bearer/Cookie | MISSING FROM OPENAPI |
| `GET/POST/PUT/DELETE /users/*` | No | Yes | admin | MISSING FROM OPENAPI |
| `GET /admin/*` | No | Yes | admin | MISSING FROM OPENAPI |
| `GET /values/*` | No | Yes | Bearer/Cookie | MISSING FROM OPENAPI |
| `GET /research-programs` | No | Yes | Bearer/Cookie | MISSING FROM OPENAPI |
| `GET /ecosystems` | No | Yes | Bearer/Cookie | MISSING FROM OPENAPI |
| `GET /status-codes` | No | Yes | Bearer/Cookie | MISSING FROM OPENAPI |

---

## Authentication Gaps

### 1. Magic Link Session (Partial Implementation)

The magic link handler creates a JWT with `auth_provider: 'magic_link'`, but:
- Session is limited to 8 hours (appropriate for magic links)
- Role is limited to `readonly` or `station-internal` (correct)
- **Gap:** No rate limiting on magic link validation endpoint

### 2. UAV Pilot Role

The authentication module defines `uav-pilot` role with `['read', 'flight-log']` permissions, but:
- No UAV endpoints exist to use these permissions
- No controller implements the `flight-log` permission check

---

## OpenAPI Specification Issues

### Version Mismatch

- **package.json:** `"version": "15.0.0"`
- **OpenAPI spec:** `version: 13.4.0`

### Missing Endpoint Documentation

The following implemented endpoints are NOT documented in OpenAPI:

1. **AOI Endpoints** - Full CRUD + GeoJSON/KML import/export
2. **Campaign Endpoints** - Full CRUD + start/complete actions
3. **Product Endpoints** - Full CRUD + quality scoring
4. **User Management Endpoints** - Full CRUD
5. **Analytics Endpoints** - Activity logs, user sessions, station stats
6. **Export Endpoints** - Station data export
7. **Admin Endpoints** - Admin-specific operations
8. **Lookup Value Endpoints** - Research programs, ecosystems, status codes

### Outdated Schema References

The OpenAPI spec references `MountTypeCode` with legacy codes (TWR, BLD, GND) - this is correct for v12.0.0+ but the spec shows version 13.4.0 while app is 15.0.0.

---

## Recommendations

### Critical (Must Fix Before Production)

1. **Wire magic-links handler to router**
   - Add import and route case in `router.js` or `api-handler.js`
   - This blocks passwordless authentication for station internal users

2. **Wire public API handler to router**
   - Add import and route case in `api-handler.js`
   - This blocks the public dashboard functionality

3. **Update OpenAPI spec version to 15.0.0**
   - Align spec version with application version

### High Priority

4. **Document new v15 endpoints in OpenAPI**
   - Add magic-links endpoints
   - Add public API endpoints
   - Add missing AOI, Campaign, Product endpoints

5. **Implement UAV API layer**
   - Create `UAVController.js`
   - Create `D1UAVRepository.js`
   - Wire routes in router
   - Document in OpenAPI

### Medium Priority

6. **Add rate limiting to magic link validation**
   - Prevent brute-force token guessing

7. **Document all lookup endpoints in OpenAPI**
   - `/research-programs`, `/ecosystems`, `/status-codes`, `/values/*`

8. **Document admin and analytics endpoints**
   - These are functional but undocumented

---

## File References

| File | Path | Status |
|------|------|--------|
| OpenAPI Spec | `/docs/openapi/openapi.yaml` | Outdated (13.4.0) |
| Worker Entry | `/src/worker.js` | OK |
| API Handler | `/src/api-handler.js` | Missing magic-links, public routes |
| Router | `/src/infrastructure/http/router.js` | Missing magic-links route |
| Magic Links Handler | `/src/handlers/magic-links.js` | Complete, NOT WIRED |
| Public API Handler | `/src/handlers/public.js` | Complete, NOT WIRED |
| UAV Domain - Pilot | `/src/domain/uav/Pilot.js` | Entity only, no API |
| UAV Domain - Mission | `/src/domain/uav/Mission.js` | Entity only, no API |
| UAV Domain - FlightLog | `/src/domain/uav/FlightLog.js` | Entity only, no API |

---

## Test Coverage Impact

The broken routing means integration tests for magic-links and public API will fail with 404 errors. Unit tests for the handlers themselves should pass, but end-to-end tests will not.

**Recommended test commands after fix:**
```bash
npm run test:integration -- --grep "magic-links"
npm run test:integration -- --grep "public"
```

---

## Conclusion

SITES Spectral webapp v15.0.0 has three critical API gaps that prevent key v15 features from functioning:

1. **Magic links** - Handler complete, not routed
2. **Public API** - Handler complete, not routed
3. **UAV management** - Domain entities only, no API layer

The OpenAPI specification is significantly outdated (13.4.0 vs 15.0.0) and missing documentation for approximately 40% of implemented endpoints.

**Priority Action Items:**
1. Wire magic-links handler (5 minutes)
2. Wire public API handler (5 minutes)
3. Update OpenAPI version and add missing endpoint documentation (2-4 hours)
4. Implement UAV API layer (1-2 days)

---

*Audit completed by @spectrum - API Expert*
*SITES Spectral Infrastructure Team*
