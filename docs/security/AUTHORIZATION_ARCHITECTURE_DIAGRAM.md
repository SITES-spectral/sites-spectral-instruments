# SITES Spectral Authorization Architecture Diagram

**Version:** 1.0
**Date:** 2025-12-09
**Purpose:** Visual representation of enhanced station-admin permission system

---

## System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SITES SPECTRAL API GATEWAY                          â”‚
â”‚                         (Cloudflare Workers + D1)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AUTHENTICATION LAYER                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  JWT Token Verification (HMAC-SHA256)                              â”‚    â”‚
â”‚  â”‚  â€¢ Validate signature                                              â”‚    â”‚
â”‚  â”‚  â€¢ Check expiration                                                â”‚    â”‚
â”‚  â”‚  â€¢ Extract user claims: { username, role, station_id, ... }       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AUTHORIZATION DECISION LAYER                            â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  isGlobalAdmin(user)                                             â”‚      â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚      â”‚
â”‚  â”‚  IF user.role == 'admin' AND                                     â”‚      â”‚
â”‚  â”‚     user.username IN ['admin', 'sites-admin']                    â”‚      â”‚
â”‚  â”‚  THEN: Global Admin (unrestricted)                               â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  isStationAdmin(user)                                            â”‚      â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚      â”‚
â”‚  â”‚  IF user.role == 'station-admin' OR                              â”‚      â”‚
â”‚  â”‚     (user.role == 'admin' AND user.username ENDS WITH '-admin')  â”‚      â”‚
â”‚  â”‚  THEN: Station Admin (station-scoped)                            â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  validateStationAccess(user, stationId)                          â”‚      â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚      â”‚
â”‚  â”‚  IF isGlobalAdmin(user): Allow ALL stations                      â”‚      â”‚
â”‚  â”‚  IF isStationAdmin(user): Allow ONLY user.station_id            â”‚      â”‚
â”‚  â”‚  IF role == 'station': Allow ONLY user.station_id               â”‚      â”‚
â”‚  â”‚  IF role == 'readonly': Allow ALL stations (read-only)          â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                     â”‚
                    â–¼                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GLOBAL ADMIN ENDPOINTS          â”‚   â”‚   STATION-SCOPED ENDPOINTS         â”‚
â”‚   (requireGlobalAdmin)            â”‚   â”‚   (requireStationAdminAccess)      â”‚
â”‚                                   â”‚   â”‚                                    â”‚
â”‚  â€¢ /api/admin/user-sessions       â”‚   â”‚  â€¢ /api/platforms (station-scoped) â”‚
â”‚  â€¢ /api/admin/station-stats       â”‚   â”‚  â€¢ /api/instruments (station-scopedâ”‚
â”‚  â€¢ /api/users/list                â”‚   â”‚  â€¢ /api/rois (station-scoped)      â”‚
â”‚  â€¢ /api/users/create              â”‚   â”‚  â€¢ /api/export/station/{id}        â”‚
â”‚  â€¢ /api/analytics/system-wide     â”‚   â”‚                                    â”‚
â”‚                                   â”‚   â”‚  Validation:                       â”‚
â”‚  Authorization:                   â”‚   â”‚  IF stationId != user.station_id:  â”‚
â”‚  âœ… admin (username: "admin")     â”‚   â”‚     âŒ DENY (403 Forbidden)        â”‚
â”‚  âœ… sites-admin (username:        â”‚   â”‚     ğŸ“Š LOG: STATION_BOUNDARY_       â”‚
â”‚     "sites-admin")                â”‚   â”‚           VIOLATION                 â”‚
â”‚  âŒ svb-admin (station-scoped)    â”‚   â”‚                                    â”‚
â”‚  âŒ ans-admin (station-scoped)    â”‚   â”‚                                    â”‚
â”‚                                   â”‚   â”‚                                    â”‚
â”‚  If DENIED:                       â”‚   â”‚                                    â”‚
â”‚  ğŸ“Š LOG: UNAUTHORIZED_GLOBAL_     â”‚   â”‚                                    â”‚
â”‚         ADMIN_ACCESS               â”‚   â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## User Role Classification Flow

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  User Authenticated â”‚
                              â”‚  (JWT Token Valid)  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  Check user.role    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                          â”‚                          â”‚
              â–¼                          â–¼                          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ role == 'admin'â”‚       â”‚ role == 'station-  â”‚      â”‚ role == 'station'â”‚
     â”‚                â”‚       â”‚      admin'        â”‚      â”‚  or 'readonly'  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                         â”‚                           â”‚
              â–¼                         â–¼                           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Check username      â”‚   â”‚ Always STATION ADMIN â”‚   â”‚ Regular User     â”‚
   â”‚ pattern             â”‚   â”‚ (station-scoped)     â”‚   â”‚ (limited access) â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                              â”‚
          â–¼                              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ username IN     â”‚         â”‚ Station Scoped:  â”‚
   â”‚ ['admin',       â”‚         â”‚ â€¢ Full edit/del  â”‚
   â”‚  'sites-admin'] â”‚         â”‚   within station â”‚
   â”‚ ?               â”‚         â”‚ â€¢ No user mgmt   â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ â€¢ No global      â”‚
          â”‚                    â”‚   endpoints      â”‚
     â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚         â”‚
   YES       NO
     â”‚         â”‚
     â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GLOBAL  â”‚ â”‚  STATION   â”‚
â”‚  ADMIN  â”‚ â”‚   ADMIN    â”‚
â”‚         â”‚ â”‚            â”‚
â”‚ â€¢ ALL   â”‚ â”‚ â€¢ Assigned â”‚
â”‚   stationsâ”‚ â”‚   station â”‚
â”‚ â€¢ User  â”‚ â”‚   ONLY    â”‚
â”‚   mgmt  â”‚ â”‚ â€¢ No user â”‚
â”‚ â€¢ Systemâ”‚ â”‚   mgmt    â”‚
â”‚   admin â”‚ â”‚ â€¢ No      â”‚
â”‚         â”‚ â”‚   global  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Permission Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  â”‚   GLOBAL    â”‚   STATION    â”‚   STATION   â”‚  READONLY   â”‚
â”‚   RESOURCE       â”‚    ADMIN    â”‚    ADMIN     â”‚    USER     â”‚    USER     â”‚
â”‚                  â”‚ (admin,     â”‚ (svb-admin,  â”‚ (svb-user)  â”‚ (viewer)    â”‚
â”‚                  â”‚ sites-admin)â”‚  ans-admin)  â”‚             â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stations         â”‚             â”‚              â”‚             â”‚             â”‚
â”‚  â€¢ List All      â”‚     âœ…      â”‚      âŒ      â”‚     âŒ      â”‚     âœ…      â”‚
â”‚  â€¢ View Own      â”‚     âœ…      â”‚      âœ…      â”‚     âœ…      â”‚     âœ…      â”‚
â”‚  â€¢ Edit Metadata â”‚     âœ…      â”‚      âŒ      â”‚     âŒ      â”‚     âŒ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Platforms        â”‚             â”‚              â”‚             â”‚             â”‚
â”‚  â€¢ List All      â”‚     âœ…      â”‚      âŒ      â”‚     âŒ      â”‚     âœ…      â”‚
â”‚  â€¢ List Own      â”‚     âœ…      â”‚      âœ…      â”‚     âœ…      â”‚     âœ…      â”‚
â”‚  â€¢ Create        â”‚     âœ…      â”‚      âœ…*     â”‚     âŒ      â”‚     âŒ      â”‚
â”‚  â€¢ Edit          â”‚     âœ…      â”‚      âœ…*     â”‚     âœ…*     â”‚     âŒ      â”‚
â”‚  â€¢ Delete        â”‚     âœ…      â”‚      âœ…*     â”‚     âŒ      â”‚     âŒ      â”‚
â”‚                  â”‚             â”‚   * Own      â”‚   * Own     â”‚             â”‚
â”‚                  â”‚             â”‚   station    â”‚   station   â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Instruments      â”‚             â”‚              â”‚             â”‚             â”‚
â”‚  â€¢ List All      â”‚     âœ…      â”‚      âŒ      â”‚     âŒ      â”‚     âœ…      â”‚
â”‚  â€¢ List Own      â”‚     âœ…      â”‚      âœ…      â”‚     âœ…      â”‚     âœ…      â”‚
â”‚  â€¢ Create        â”‚     âœ…      â”‚      âœ…*     â”‚     âŒ      â”‚     âŒ      â”‚
â”‚  â€¢ Edit          â”‚     âœ…      â”‚      âœ…*     â”‚     âœ…*     â”‚     âŒ      â”‚
â”‚  â€¢ Delete        â”‚     âœ…      â”‚      âœ…*     â”‚     âŒ      â”‚     âŒ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ROIs             â”‚             â”‚              â”‚             â”‚             â”‚
â”‚  â€¢ View All      â”‚     âœ…      â”‚      âŒ      â”‚     âŒ      â”‚     âœ…      â”‚
â”‚  â€¢ View Own      â”‚     âœ…      â”‚      âœ…      â”‚     âœ…      â”‚     âœ…      â”‚
â”‚  â€¢ Create        â”‚     âœ…      â”‚      âœ…*     â”‚     âœ…*     â”‚     âŒ      â”‚
â”‚  â€¢ Edit (new)    â”‚     âœ…      â”‚      âœ…*     â”‚     âœ…*     â”‚     âŒ      â”‚
â”‚  â€¢ Override Edit â”‚     âœ…      â”‚      âœ…**    â”‚     âŒ      â”‚     âŒ      â”‚
â”‚  â€¢ Delete        â”‚     âœ…      â”‚      âœ…*     â”‚     âŒ      â”‚     âŒ      â”‚
â”‚                  â”‚             â”‚  ** Legacy   â”‚ * New ROI   â”‚             â”‚
â”‚                  â”‚             â”‚   warning    â”‚   creation  â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Users            â”‚             â”‚              â”‚             â”‚             â”‚
â”‚  â€¢ List          â”‚     âœ…      â”‚      âŒ      â”‚     âŒ      â”‚     âŒ      â”‚
â”‚  â€¢ Create        â”‚     âœ…      â”‚      âŒ      â”‚     âŒ      â”‚     âŒ      â”‚
â”‚  â€¢ Edit          â”‚     âœ…      â”‚      âŒ      â”‚     âŒ      â”‚     âŒ      â”‚
â”‚  â€¢ Delete        â”‚     âœ…      â”‚      âŒ      â”‚     âŒ      â”‚     âŒ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Admin Panel      â”‚             â”‚              â”‚             â”‚             â”‚
â”‚  â€¢ User Sessions â”‚     âœ…      â”‚      âŒ      â”‚     âŒ      â”‚     âŒ      â”‚
â”‚  â€¢ Station Stats â”‚     âœ…      â”‚      âŒ      â”‚     âŒ      â”‚     âŒ      â”‚
â”‚  â€¢ Activity Logs â”‚     âœ…      â”‚      âŒ      â”‚     âŒ      â”‚     âŒ      â”‚
â”‚  â€¢ System Health â”‚     âœ…      â”‚      âŒ      â”‚     âŒ      â”‚     âŒ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Analytics        â”‚             â”‚              â”‚             â”‚             â”‚
â”‚  â€¢ System-wide   â”‚     âœ…      â”‚      âŒ      â”‚     âŒ      â”‚     âŒ      â”‚
â”‚  â€¢ Own Station   â”‚     âœ…      â”‚      âœ…      â”‚     âœ…      â”‚     âœ…      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Export           â”‚             â”‚              â”‚             â”‚             â”‚
â”‚  â€¢ All Stations  â”‚     âœ…      â”‚      âŒ      â”‚     âŒ      â”‚     âœ…      â”‚
â”‚  â€¢ Own Station   â”‚     âœ…      â”‚      âœ…      â”‚     âœ…      â”‚     âœ…      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Request Flow Example: Station Admin Accessing Global Endpoint

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. User "svb-admin" attempts to access /api/admin/user-sessions       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. API Gateway validates JWT token                                    â”‚
â”‚    Token payload: {                                                   â”‚
â”‚      username: "svb-admin",                                           â”‚
â”‚      role: "station-admin",                                           â”‚
â”‚      station_id: 7,                                                   â”‚
â”‚      station_acronym: "SVB"                                           â”‚
â”‚    }                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Controller calls requireGlobalAdmin(request, env)                  â”‚
â”‚    â€¢ requireAuthentication() âœ… PASS (token valid)                   â”‚
â”‚    â€¢ isGlobalAdmin(user)     âŒ FAIL                                 â”‚
â”‚      - user.role == 'admin'? âŒ NO (role is 'station-admin')         â”‚
â”‚      - Returns: FALSE                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Authorization DENIED                                               â”‚
â”‚    â€¢ Log security event:                                              â”‚
â”‚      logSecurityEvent('UNAUTHORIZED_GLOBAL_ADMIN_ACCESS', {          â”‚
â”‚        username: 'svb-admin',                                         â”‚
â”‚        role: 'station-admin',                                         â”‚
â”‚        station: 'SVB',                                                â”‚
â”‚        endpoint: '/api/admin/user-sessions',                          â”‚
â”‚        reason: 'Station admin cannot access global endpoint'          â”‚
â”‚      })                                                               â”‚
â”‚    â€¢ Return response:                                                 â”‚
â”‚      HTTP 403 Forbidden                                               â”‚
â”‚      { error: "Global admin privileges required. Station admins       â”‚
â”‚                cannot access this endpoint." }                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Request Flow Example: Station Admin Accessing Own Station

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. User "svb-admin" attempts to DELETE /api/platforms/SVB_FOR_PL01    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. API Gateway validates JWT token                                    â”‚
â”‚    Token payload: {                                                   â”‚
â”‚      username: "svb-admin",                                           â”‚
â”‚      role: "station-admin",                                           â”‚
â”‚      station_id: 7,                                                   â”‚
â”‚      station_acronym: "SVB"                                           â”‚
â”‚    }                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Handler resolves stationId from platform                           â”‚
â”‚    â€¢ Query: SELECT station_id FROM platforms WHERE id = 'SVB_FOR_PL01'â”‚
â”‚    â€¢ Result: station_id = 7 (Svartberget)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Call requireStationAdminAccess(request, env, stationId=7)          â”‚
â”‚    â€¢ requireAuthentication() âœ… PASS (token valid)                   â”‚
â”‚    â€¢ validateStationAdminAccess(user, stationId=7)                    â”‚
â”‚      - isGlobalAdmin(user)? âŒ NO                                    â”‚
â”‚      - isStationAdmin(user)? âœ… YES (role is 'station-admin')        â”‚
â”‚      - validateStationAccess(user, stationId=7)                       â”‚
â”‚        â€¢ user.station_id (7) == stationId (7)? âœ… YES                â”‚
â”‚      - Returns: { allowed: true, reason: 'Station admin access' }    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Authorization GRANTED                                              â”‚
â”‚    â€¢ Perform platform deletion                                        â”‚
â”‚    â€¢ Log security event:                                              â”‚
â”‚      logSecurityEvent('PLATFORM_DELETED', {                           â”‚
â”‚        username: 'svb-admin',                                         â”‚
â”‚        role: 'station-admin',                                         â”‚
â”‚        station: 'SVB',                                                â”‚
â”‚        platform_id: 'SVB_FOR_PL01',                                   â”‚
â”‚        action: 'delete'                                               â”‚
â”‚      })                                                               â”‚
â”‚    â€¢ Return response:                                                 â”‚
â”‚      HTTP 200 OK                                                      â”‚
â”‚      { success: true, message: 'Platform deleted' }                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Request Flow Example: Station Admin Accessing Other Station (DENIED)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. User "svb-admin" attempts to DELETE /api/platforms/ANS_FOR_PL01    â”‚
â”‚    (Abisko platform, not Svartberget)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. API Gateway validates JWT token                                    â”‚
â”‚    Token payload: {                                                   â”‚
â”‚      username: "svb-admin",                                           â”‚
â”‚      role: "station-admin",                                           â”‚
â”‚      station_id: 7,        â† User is assigned to SVB (id=7)           â”‚
â”‚      station_acronym: "SVB"                                           â”‚
â”‚    }                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Handler resolves stationId from platform                           â”‚
â”‚    â€¢ Query: SELECT station_id FROM platforms WHERE id = 'ANS_FOR_PL01'â”‚
â”‚    â€¢ Result: station_id = 1 (Abisko)    â† Platform is at ANS (id=1)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Call requireStationAdminAccess(request, env, stationId=1)          â”‚
â”‚    â€¢ requireAuthentication() âœ… PASS (token valid)                   â”‚
â”‚    â€¢ validateStationAdminAccess(user, stationId=1)                    â”‚
â”‚      - isGlobalAdmin(user)? âŒ NO                                    â”‚
â”‚      - isStationAdmin(user)? âœ… YES (role is 'station-admin')        â”‚
â”‚      - validateStationAccess(user, stationId=1)                       â”‚
â”‚        â€¢ user.station_id (7) == stationId (1)? âŒ NO                 â”‚
â”‚        â€¢ user.station_acronym (SVB) == stationId (1)? âŒ NO          â”‚
â”‚      - Returns: {                                                     â”‚
â”‚          allowed: false,                                              â”‚
â”‚          reason: "Station admin svb-admin cannot access station 1"    â”‚
â”‚        }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Authorization DENIED                                               â”‚
â”‚    â€¢ Log security event:                                              â”‚
â”‚      logSecurityEvent('STATION_BOUNDARY_VIOLATION', {                 â”‚
â”‚        username: 'svb-admin',                                         â”‚
â”‚        role: 'station-admin',                                         â”‚
â”‚        user_station: 'SVB',                                           â”‚
â”‚        target_station: 'ANS',                                         â”‚
â”‚        endpoint: '/api/platforms/ANS_FOR_PL01',                       â”‚
â”‚        action: 'delete',                                              â”‚
â”‚        reason: 'Station admin cannot access other station'            â”‚
â”‚      })                                                               â”‚
â”‚    â€¢ Return response:                                                 â”‚
â”‚      HTTP 403 Forbidden                                               â”‚
â”‚      { error: "Station admin svb-admin cannot access station ANS.    â”‚
â”‚                Assigned station: SVB" }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Event Logging Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Security Event Types                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Authentication Events                                              â”‚
â”‚  â”œâ”€ SUCCESSFUL_LOGIN                                               â”‚
â”‚  â”œâ”€ FAILED_LOGIN                                                   â”‚
â”‚  â””â”€ TOKEN_EXPIRED                                                  â”‚
â”‚                                                                     â”‚
â”‚  Authorization Events (NEW)                                         â”‚
â”‚  â”œâ”€ UNAUTHORIZED_GLOBAL_ADMIN_ACCESS  â† Station admin â†’ Global     â”‚
â”‚  â”œâ”€ UNAUTHORIZED_STATION_ADMIN_ACCESS â† Station admin â†’ Other stn  â”‚
â”‚  â”œâ”€ STATION_BOUNDARY_VIOLATION        â† Cross-station access       â”‚
â”‚  â””â”€ PRIVILEGE_ESCALATION_ATTEMPT      â† Role violation             â”‚
â”‚                                                                     â”‚
â”‚  Resource Events                                                    â”‚
â”‚  â”œâ”€ PLATFORM_CREATED                                               â”‚
â”‚  â”œâ”€ PLATFORM_DELETED        (with station context)                 â”‚
â”‚  â”œâ”€ INSTRUMENT_MODIFIED     (with station context)                 â”‚
â”‚  â””â”€ ROI_OVERRIDE            (super admin override)                 â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              logSecurityEvent(event, details, request, env)        â”‚
â”‚                                                                     â”‚
â”‚  Enrichment:                                                       â”‚
â”‚  â€¢ Extract IP address (CF-Connecting-IP header)                    â”‚
â”‚  â€¢ Extract User-Agent                                              â”‚
â”‚  â€¢ Add timestamp (ISO 8601)                                        â”‚
â”‚  â€¢ Add station context:                                            â”‚
â”‚    - user_station: User's assigned station                         â”‚
â”‚    - target_station: Target resource's station                     â”‚
â”‚    - cross_station_access: Boolean flag                            â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Database: activity_log table                          â”‚
â”‚                                                                     â”‚
â”‚  INSERT INTO activity_log (                                        â”‚
â”‚    user_id,              -- username                               â”‚
â”‚    action,               -- event type                             â”‚
â”‚    resource_type,        -- 'security_event'                       â”‚
â”‚    resource_id,          -- optional resource ID                   â”‚
â”‚    details,              -- JSON with full context                 â”‚
â”‚    ip_address,           -- client IP                              â”‚
â”‚    user_agent,           -- client UA                              â”‚
â”‚    created_at            -- timestamp                              â”‚
â”‚  )                                                                 â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Audit Trail (Queryable)                           â”‚
â”‚                                                                     â”‚
â”‚  SELECT * FROM activity_log                                        â”‚
â”‚  WHERE action = 'STATION_BOUNDARY_VIOLATION'                       â”‚
â”‚  ORDER BY created_at DESC;                                         â”‚
â”‚                                                                     â”‚
â”‚  Example output:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ username     â”‚ action                 â”‚ details             â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ svb-admin    â”‚ STATION_BOUNDARY_      â”‚ {"user_station":    â”‚  â”‚
â”‚  â”‚              â”‚ VIOLATION              â”‚  "SVB", "target":   â”‚  â”‚
â”‚  â”‚              â”‚                        â”‚  "ANS", ...}        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Credential Structure (Cloudflare Secrets)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CLOUDFLARE SECRETS                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  ADMIN_CREDENTIALS (Global Admin #1)                               â”‚
â”‚  {                                                                 â”‚
â”‚    "username": "admin",          â† SUPER_ADMIN_ROLES[0]            â”‚
â”‚    "password": "[REDACTED]",                                       â”‚
â”‚    "role": "admin"                                                 â”‚
â”‚  }                                                                 â”‚
â”‚                                                                     â”‚
â”‚  SITES_ADMIN_CREDENTIALS (Global Admin #2)                         â”‚
â”‚  {                                                                 â”‚
â”‚    "username": "sites-admin",    â† SUPER_ADMIN_ROLES[1]            â”‚
â”‚    "password": "[REDACTED]",                                       â”‚
â”‚    "role": "admin",                                                â”‚
â”‚    "permissions": ["read", "write", "edit", "delete", "admin"]     â”‚
â”‚  }                                                                 â”‚
â”‚                                                                     â”‚
â”‚  STATION_SVARTBERGET_ADMIN_CREDENTIALS (Station Admin)             â”‚
â”‚  {                                                                 â”‚
â”‚    "username": "svb-admin",      â† Ends with "-admin"              â”‚
â”‚    "password": "[REDACTED]",                                       â”‚
â”‚    "role": "station-admin",      â† Station-scoped role             â”‚
â”‚    "station_id": "svartberget",                                    â”‚
â”‚    "permissions": ["read", "write", "edit", "delete"]              â”‚
â”‚  }                                                                 â”‚
â”‚                                                                     â”‚
â”‚  STATION_SVARTBERGET_CREDENTIALS (Station User)                    â”‚
â”‚  {                                                                 â”‚
â”‚    "username": "svb-user",                                         â”‚
â”‚    "password": "[REDACTED]",                                       â”‚
â”‚    "role": "station",            â† Limited station user            â”‚
â”‚    "station_id": "svartberget",                                    â”‚
â”‚    "edit_privileges": false,                                       â”‚
â”‚    "permissions": ["read"]                                         â”‚
â”‚  }                                                                 â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Implementation File Structure

```
src/
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ authentication.js         # JWT token generation/validation
â”‚   â”œâ”€â”€ permissions.js             # Authorization logic (ENHANCED)
â”‚   â”‚   â”œâ”€â”€ SUPER_ADMIN_ROLES     # ['admin', 'sites-admin']
â”‚   â”‚   â”œâ”€â”€ isGlobalAdmin()       # NEW: Global admin check
â”‚   â”‚   â”œâ”€â”€ isStationAdmin()      # NEW: Station admin check
â”‚   â”‚   â”œâ”€â”€ validateAdminPermission()  # UPDATED: Uses isGlobalAdmin()
â”‚   â”‚   â”œâ”€â”€ validateStationAccess()    # UPDATED: Uses new admin checks
â”‚   â”‚   â”œâ”€â”€ validateStationAdminAccess()  # NEW: Station-scoped admin check
â”‚   â”‚   â”œâ”€â”€ requireGlobalAdmin()   # NEW: Global admin middleware
â”‚   â”‚   â””â”€â”€ requireStationAdminAccess()  # NEW: Station admin middleware
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ handlers/
â”‚   â”œâ”€â”€ users.js                   # UPDATED: Use requireGlobalAdmin()
â”‚   â”œâ”€â”€ rois.js                    # UPDATED: Use requireStationAdminAccess()
â”‚   â”œâ”€â”€ export.js                  # UPDATED: Add station boundary check
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ infrastructure/
â”‚   â””â”€â”€ http/
â”‚       â””â”€â”€ controllers/
â”‚           â””â”€â”€ AdminController.js # UPDATED: Use isGlobalAdmin() check
â”‚
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ auth-middleware.js         # UPDATED: Add withGlobalAdmin()
â”‚
â””â”€â”€ utils/
    â””â”€â”€ logging.js                 # ENHANCED: Add station context logging
```

---

**Prepared By**: Shield (Security Architecture Agent)
**Version**: 1.0
**Last Updated**: 2025-12-09
**Purpose**: Visual guide for implementing enhanced station-admin permissions
