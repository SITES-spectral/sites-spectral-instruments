
 ▐▛███▜▌   Claude Code v2.1.17
▝▜█████▛▘  Opus 4.5 · Claude Max
  ▘▘ ▝▝    /…/Spectral/apps/sites-spectral-manager/apps/webapp-instruments

❯ Implement the following plan:                                             
                                                                            
  # SITES Spectral Subdomain Architecture with Cloudflare Access            
                                                                            
  > **Architecture Credit**: This subdomain-based architecture design is    
  based on architectural knowledge shared by **Flights for Biodiversity     
  Sweden AB** (https://github.com/flightsforbiodiversity). All architecture 
  documentation files must include this credit attribution.                 
                                                                            
  ---                                                                       
                                                                            
  ## Executive Summary                                                      
                                                                            
  Migration from single-domain (`sitesspectral.work`) to subdomain-based    
  architecture with Cloudflare Access authentication.                       
                                                                            
  | Current State | Target State |                                          
  |---------------|--------------|                                          
  | Single domain, all features | `sitesspectral.work` - Public only |      
  | Database password auth | `admin.sitesspectral.work` - Global admins (CF 
  Access) |                                                                 
  | 5 roles mixed | `{station}.sitesspectral.work` - Station portals (CF    
  Access) |                                                                 
                                                                            
  ---                                                                       
                                                                            
  ## 1. Architecture Decision: Single Worker with Subdomain Routing         
                                                                            
  **Rationale**: Single Worker avoids code duplication, simplifies          
  deployment, and maintains single D1 binding.                              
                                                                            
  The Worker detects subdomain from `Host` header and routes accordingly:   
  - `sitesspectral.work` → Public dashboard (no auth)                       
  - `admin.sitesspectral.work` → Admin portal (CF Access required)          
  - `{station}.sitesspectral.work` → Station portal (CF Access required)    
                                                                            
  ---                                                                       
                                                                            
  ## 2. User Model                                                          
                                                                            
  | User Type | Authentication | Access |                                   
  |-----------|----------------|--------|                                   
  | **Global Admins** | CF Access passwordless (jose.beltran@mgeo.lu.se,    
  lars.eklundh@nateko.lu.se) | Full system access |                         
  | **Station Admins** | CF Access passwordless by email | Their station    
  only |                                                                    
  | **UAV Pilots** | CF Access by email (per station) | Mission/flight      
  logging |                                                                 
  | **Station Internal** | Magic links (generated by admins) | Read-only    
  station view |                                                            
  | **Public** | None | Public metrics only |                               
                                                                            
  ---                                                                       
                                                                            
  ## 3. Implementation Phases                                               
                                                                            
  ### Phase 1: Cloudflare Configuration (Day 1-2)                           
                                                                            
  1. **DNS Configuration**                                                  
  - Add wildcard CNAME: `* →                                                
  sites-spectral-instruments.jose-beltran.workers.dev`                      
  - Add admin CNAME: `admin →                                               
  sites-spectral-instruments.jose-beltran.workers.dev`                      
                                                                            
  2. **Update wrangler.toml**                                               
  ```toml                                                                   
  [[routes]]                                                                
  pattern = "*.sitesspectral.work/*"                                        
  zone_id = "98a6b8637a4cc674eea24819d8f72b07"                              
                                                                            
  [[routes]]                                                                
  pattern = "*.sitesspectral.work"                                          
  zone_id = "98a6b8637a4cc674eea24819d8f72b07"                              
  ```                                                                       
                                                                            
  3. **Create CF Access Applications**                                      
  - Admin Portal: `admin.sitesspectral.work` (emails: josé, lars)           
  - Station Wildcard: `*.sitesspectral.work` (station admin emails +        
  pilot groups)                                                             
                                                                            
  ### Phase 2: Backend Auth (Day 3-5)                                       
                                                                            
  1. **Create `src/infrastructure/auth/CloudflareAccessAdapter.js`**        
  - Verify CF Access JWT from `Cf-Access-Jwt-Assertion` header              
  - Use jose library's `createRemoteJWKSet` for key rotation                
  - Map CF Access email to user role                                        
                                                                            
  2. **Update `src/auth/authentication.js`**                                
  - Add dual-auth: CF Access JWT (primary) + legacy httpOnly cookie         
  (fallback)                                                                
  - Modify `getUserFromRequest()` to check CF Access first                  
                                                                            
  3. **Database Migration `0045_subdomain_auth_uav_missions.sql`**          
  - Add `auth_provider`, `cf_access_email` columns to users                 
  - Create `magic_link_tokens` table                                        
  - Create UAV tables: `uav_pilots`, `uav_missions`, `mission_pilots`,      
  `uav_flight_logs`, `uav_batteries`                                        
                                                                            
  ### Phase 3: Subdomain Routing (Day 6-8)                                  
                                                                            
  1. **Update `src/worker.js`**                                             
  ```javascript                                                             
  function getSubdomain(request) {                                          
  const host = request.headers.get('Host') || '';                           
  const parts = host.split('.');                                            
  if (parts.length === 3 && parts[1] === 'sitesspectral') {                 
  return parts[0];                                                          
  }                                                                         
  return null;                                                              
  }                                                                         
  ```                                                                       
                                                                            
  2. **Create portal handlers**                                             
  - `handlePublicDashboard()` - No auth, public metrics                     
  - `handleAdminPortal()` - CF Access required, full admin                  
  - `handleStationPortal()` - CF Access required, station-scoped            
                                                                            
  3. **Update CORS for subdomains**                                         
  - Add all station subdomains to allowed origins                           
  - Add dynamic subdomain pattern matching                                  
                                                                            
  ### Phase 4: Magic Links (Day 9-10)                                       
                                                                            
  1. **Create `src/handlers/magic-links.js`**                               
  - `POST /api/v11/magic-links/create` - Station admin creates link         
  - `GET /api/v11/magic-links/validate` - Validate token, issue session     
  - `POST /api/v11/magic-links/revoke` - Revoke token                       
                                                                            
  2. **Token specification**                                                
  - 256-bit cryptographic token                                             
  - 7-day default expiry                                                    
  - Single-use optional                                                     
  - Station-scoped                                                          
                                                                            
  ### Phase 5: Public Dashboard (Day 11-12)                                 
                                                                            
  1. **Create `public/public-dashboard.html`**                              
  - Station map (Leaflet)                                                   
  - Station status indicators                                               
  - Platform/instrument counts                                              
  - No authentication required                                              
                                                                            
  2. **Create public API endpoints**                                        
  - `GET /api/public/stations` - Station list with status                   
  - `GET /api/public/health` - System health metrics                        
                                                                            
  ### Phase 6: UAV Pilot Features (Day 13-15)                               
                                                                            
  1. **Create domain entities**                                             
  - `src/domain/uav/Pilot.js`                                               
  - `src/domain/uav/Mission.js`                                             
  - `src/domain/uav/FlightLog.js`                                           
                                                                            
  2. **Create repositories and controllers**                                
  - Pilot registration                                                      
  - Mission planning/logging                                                
  - Flight log entry                                                        
  - Battery tracking                                                        
                                                                            
  ---                                                                       
                                                                            
  ## 4. Critical Files to Modify                                            
                                                                            
  | File | Changes |                                                        
  |------|---------|                                                        
  | `src/worker.js` | Subdomain detection and routing |                     
  | `src/auth/authentication.js` | CF Access JWT verification |             
  | `src/domain/authorization/Role.js` | Add `uav-pilot` role |             
  | `wrangler.toml` | Wildcard subdomain routes |                           
  | `src/config/allowed-origins.js` | Subdomain CORS |                      
  | `public/index.html` | Redirect to public dashboard |                    
                                                                            
  ## 5. New Files to Create                                                 
                                                                            
  | File | Purpose |                                                        
  |------|---------|                                                        
  | `src/infrastructure/auth/CloudflareAccessAdapter.js` | CF Access JWT    
  verification |                                                            
  | `src/handlers/magic-links.js` | Magic link CRUD |                       
  | `src/handlers/public.js` | Public API endpoints |                       
  | `src/domain/uav/Pilot.js` | UAV pilot entity |                          
  | `src/domain/uav/Mission.js` | Mission entity |                          
  | `migrations/0045_subdomain_auth_uav_missions.sql` | Schema changes |    
  | `public/public-dashboard.html` | Public dashboard |                     
  | `docs/architecture/SUBDOMAIN_ARCHITECTURE.md` | Architecture docs (with 
  FBS credit) |                                                             
                                                                            
  ---                                                                       
                                                                            
  ## 6. Credit Attribution                                                  
                                                                            
  All new architecture documentation files must include:                    
                                                                            
  ```markdown                                                               
  > **Architecture Credit**: This subdomain-based architecture design is    
  based on                                                                  
  > architectural knowledge shared by **Flights for Biodiversity Sweden     
  AB**                                                                      
  > (https://github.com/flightsforbiodiversity).                            
  ```                                                                       
                                                                            
  Files requiring this credit:                                              
  - `docs/architecture/SUBDOMAIN_ARCHITECTURE.md`                           
  - `docs/security/CLOUDFLARE_ACCESS_INTEGRATION.md`                        
  - `docs/MAGIC_LINK_SYSTEM.md`                                             
  - `docs/UAV_PILOT_SYSTEM.md`                                              
                                                                            
  ---                                                                       
                                                                            
  ## 7. Verification                                                        
                                                                            
  ### Manual Testing                                                        
  1. Visit `sitesspectral.work` - Should show public dashboard without      
  login                                                                     
  2. Visit `admin.sitesspectral.work` - Should trigger CF Access OTP        
  3. Visit `svartberget.sitesspectral.work` - Should require station-level  
  auth                                                                      
  4. Create magic link as station admin - Verify email delivery             
  5. Use magic link - Verify read-only access                               
                                                                            
  ### Automated Tests                                                       
  ```bash                                                                   
  npm run test:unit    # Unit tests for CF Access adapter                   
  npm run test:integration  # Subdomain routing tests                       
  ```                                                                       
                                                                            
  ---                                                                       
                                                                            
  ## 8. Rollback Plan                                                       
                                                                            
  If issues arise:                                                          
  1. Revert wrangler.toml routes to single domain                           
  2. Disable CF Access applications                                         
  3. Re-enable legacy password authentication                               
  4. DNS changes can remain (no impact without Access policies)             
                                                                            
  ---                                                                       
                                                                            
  ## Timeline Estimate                                                      
                                                                            
  | Phase | Duration | Deliverable |                                        
  |-------|----------|-------------|                                        
  | Phase 1: CF Config | 2 days | DNS + Access apps configured |            
  | Phase 2: Backend Auth | 3 days | CF Access JWT working |                
  | Phase 3: Routing | 3 days | Subdomains functional |                     
  | Phase 4: Magic Links | 2 days | Token system working |                  
  | Phase 5: Public Dashboard | 2 days | Public view deployed |             
  | Phase 6: UAV Features | 3 days | Pilot/mission system |                 
  | **Total** | **~15 days** | Full implementation |                        
                                                                            
                                                                            
  If you need specific details from before exiting plan mode (like exact    
  code snippets, error messages, or content you generated), read the full   
  transcript at: /home/jobelund/.claude/projects/-lunarc-nobackup-projects- 
  sitesspec-SITES-Spectral-apps-sites-spectral-manager-apps-webapp-instrume 
  nts/9a0056c6-fe1b-40e8-aeff-d0c23f348b1c.jsonl                            

● I'll implement this subdomain architecture plan. Let me start by exploring the
   current codebase structure to understand the existing implementation, then
  proceed with each phase.

● Search(pattern: "**/*.{js,toml,sql}", path: "/lunarc/nobackup/projects/sitessp
        ec/SITES/Spectral/apps/sites-spectral-manager/apps/webapp-instruments")
  ⎿  Found 100 files (ctrl+o to expand)

● Read(wrangler.toml)
  ⎿  Read 49 lines

● Read(package.json)
  ⎿  Read 68 lines

● Read(src/worker.js)
  ⎿  Read 120 lines

● Search(pattern: "src/auth/**/*.js", path: "/lunarc/nobackup/projects/sitesspec
        /SITES/Spectral/apps/sites-spectral-manager/apps/webapp-instruments")
  ⎿  Found 4 files (ctrl+o to expand)

● Search(pattern: "src/domain/**/*.js", path: "/lunarc/nobackup/projects/sitessp
        ec/SITES/Spectral/apps/sites-spectral-manager/apps/webapp-instruments")
  ⎿  Found 81 files (ctrl+o to expand)

● Read(src/auth/authentication.js)
  ⎿  Read 444 lines

● Read(src/domain/authorization/Role.js)
  ⎿  Read 112 lines

● Read(src/cors.js)
  ⎿  Read 66 lines

● Read(src/config/allowed-origins.js)
  ⎿  Read 47 lines

● Read(src/api-handler.js)
  ⎿  Read 276 lines

● Search(pattern: "migrations/*.sql", path: "/lunarc/nobackup/projects/sitesspec
        /SITES/Spectral/apps/sites-spectral-manager/apps/webapp-instruments")
  ⎿  Found 14 files (ctrl+o to expand)

● Now I have a good understanding of the codebase. Let me create tasks to track
  progress and implement this systematically.
✔ Task #1 created: Create database migration for subdomain auth and UAV
✔ Task #2 created: Create Cloudflare Access adapter
✔ Task #3 created: Update worker.js for subdomain routing
✔ Task #4 created: Update CORS for subdomains
✔ Task #5 created: Update wrangler.toml for wildcard routes
✔ Task #6 created: Add UAV pilot role to Role.js
✔ Task #7 created: Create magic links handler
✔ Task #8 created: Create public API endpoints
✔ Task #9 created: Create UAV domain entities
✔ Task #10 created: Create architecture documentation
✔ Task #11 created: Update authentication.js for dual-auth

❯ /rename refactor-auth-logic-stations-subdomains 
✔ Task #1 updated: status → in progress

● Write(migrations/0045_subdomain_auth_uav_missions.sql)
  ⎿  Wrote 406 lines to migrations/0045_subdomain_auth_uav_missions.sql
       1 -- Migration: 0045_subdomain_auth_uav_missions.sql
       2 -- SITES Spectral v15.0.0 - Subdomain Architecture with Cloudfla
         re Access
       3 --
       4 -- This migration adds support for:
       5 -- 1. Cloudflare Access authentication (passwordless via email O
         TP)
       6 -- 2. Magic link tokens for station internal users
       7 -- 3. UAV pilot registration and mission tracking
       8 -- 4. Flight logs and battery tracking
       9 --
      10 -- Architecture Credit: This subdomain-based architecture design
          is based on
     … +396 lines (ctrl+o to expand)
✔ Task #1 updated: status → completed
✔ Task #2 updated: status → in progress

● Bash(mkdir -p /lunarc/nobackup/projects/sitesspec/SITES/Spectral/apps/sites-sp
      ectral-manager/apps/webapp-instruments/src/infrastructure/auth)
  ⎿  (No content)

● Write(src/infrastructure/auth/CloudflareAccessAdapter.js)
  ⎿  Wrote 452 lines to src/infrastructure/auth/CloudflareAccessAdapter.js
       1 /**
       2  * Cloudflare Access Adapter
       3  * Verifies Cloudflare Access JWT tokens for passwordless authen
         tication
       4  *
       5  * Architecture Credit: This subdomain-based architecture design
          is based on
       6  * architectural knowledge shared by Flights for Biodiversity Sw
         eden AB
       7  * (https://github.com/flightsforbiodiversity)
       8  *
       9  * @module infrastructure/auth/CloudflareAccessAdapter
      10  * @version 15.0.0
     … +442 lines (ctrl+o to expand)

● Write(src/infrastructure/auth/index.js)
  ⎿  Wrote 9 lines to src/infrastructure/auth/index.js
      1 /**
      2  * Infrastructure Auth Module Exports
      3  *
      4  * @module infrastructure/auth
      5  * @version 15.0.0
      6  */
      7 export { CloudflareAccessAdapter } from './CloudflareAccessAdapte
        r.js';
✔ Task #2 updated: status → completed
✔ Task #3 updated: status → in progress

● Read(src/worker.js)
  ⎿  Read 120 lines

● Write(src/worker.js)
  ⎿  Added 251 lines, removed 39 lines
        1 -// SITES Spectral Stations & Instruments - Main Worker v11.0.0
        2 -// Hexagonal Architecture with Cloudflare Workers + API Versio
          -n Aliases                                                     
        3 -// Handles both static assets and API routes                  
        1 +// SITES Spectral Stations & Instruments - Main Worker v15.0.0
        2 +// Hexagonal Architecture with Cloudflare Workers + Subdomain 
          +Routing                                                       
        3 +// Handles both static assets and API routes with Cloudflare A
          +ccess authentication                                          
        4 +//                                                            
        5 +// Architecture Credit: This subdomain-based architecture desi
          +gn is based on                                                
        6 +// architectural knowledge shared by Flights for Biodiversity 
          +Sweden AB                                                     
        7 +// (https://github.com/flightsforbiodiversity)                
        8  
        9  import { createCors, validateCorsOrigin, createCorsErrorRespon
           se } from './cors';
       10  import { handleApiRequest } from './api-handler';
       11 +import { CloudflareAccessAdapter } from './infrastructure/auth
          +/CloudflareAccessAdapter.js';                                 
       12  
       13 +/**                                                           
       14 + * Get subdomain from Host header                             
       15 + *                                                            
       16 + * @param {Request} request - Incoming request                
       17 + * @returns {string|null} Subdomain or null for root domain   
       18 + */                                                           
       19 +function getSubdomain(request) {                              
       20 +  const host = request.headers.get('Host') || '';             
       21 +  const parts = host.split('.');                              
       22 +                                                              
       23 +  // Expected formats:                                        
       24 +  // - sitesspectral.work (root domain)                       
       25 +  // - admin.sitesspectral.work (admin subdomain)             
       26 +  // - svartberget.sitesspectral.work (station subdomain)     
       27 +  if (parts.length === 3 && parts[1] === 'sitesspectral' && pa
          +rts[2] === 'work') {                                          
       28 +    return parts[0];                                          
       29 +  }                                                           
       30 +                                                              
       31 +  // For Workers dev URL, use X-Subdomain header (testing) or 
          +query param                                                   
       32 +  if (host.includes('workers.dev')) {                         
       33 +    const subdomainHeader = request.headers.get('X-Subdomain')
          +;                                                             
       34 +    if (subdomainHeader) {                                    
       35 +      return subdomainHeader;                                 
       36 +    }                                                         
       37 +                                                              
       38 +    // Check query param for testing                          
       39 +    const url = new URL(request.url);                         
       40 +    const subdomainParam = url.searchParams.get('subdomain'); 
       41 +    if (subdomainParam) {                                     
       42 +      return subdomainParam;                                  
       43 +    }                                                         
       44 +  }                                                           
       45 +                                                              
       46 +  return null;                                                
       47 +}                                                             
       48 +                                                              
       49 +/**                                                           
       50 + * Determine portal type from subdomain                       
       51 + *                                                            
       52 + * @param {string|null} subdomain - Subdomain from request    
       53 + * @returns {'public'|'admin'|'station'} Portal type          
       54 + */                                                           
       55 +function getPortalType(subdomain) {                           
       56 +  if (!subdomain || subdomain === 'www') {                    
       57 +    return 'public';                                          
       58 +  }                                                           
       59 +                                                              
       60 +  if (subdomain === 'admin') {                                
       61 +    return 'admin';                                           
       62 +  }                                                           
       63 +                                                              
       64 +  // Any other subdomain is treated as a station portal       
       65 +  return 'station';                                           
       66 +}                                                             
       67 +                                                              
       68 +/**                                                           
       69 + * Create unauthorized response for portal access             
       70 + *                                                            
       71 + * @param {string} portalType - Portal type                   
       72 + * @param {string|null} subdomain - Subdomain                 
       73 + * @returns {Response}                                        
       74 + */                                                           
       75 +function createPortalUnauthorizedResponse(portalType, subdomai
          +n) {                                                          
       76 +  if (portalType === 'admin') {                               
       77 +    return new Response(JSON.stringify({                      
       78 +      error: 'Unauthorized',                                  
       79 +      message: 'Admin portal requires Cloudflare Access authen
          +tication',                                                    
       80 +      portal: 'admin',                                        
       81 +      hint: 'Please authenticate via Cloudflare Access'       
       82 +    }), {                                                     
       83 +      status: 401,                                            
       84 +      headers: { 'Content-Type': 'application/json' }         
       85 +    });                                                       
       86 +  }                                                           
       87 +                                                              
       88 +  if (portalType === 'station') {                             
       89 +    return new Response(JSON.stringify({                      
       90 +      error: 'Unauthorized',                                  
       91 +      message: `Station portal (${subdomain}) requires authent
          +ication`,                                                     
       92 +      portal: 'station',                                      
       93 +      station: subdomain,                                     
       94 +      hint: 'Please authenticate via Cloudflare Access or magi
          +c link'                                                       
       95 +    }), {                                                     
       96 +      status: 401,                                            
       97 +      headers: { 'Content-Type': 'application/json' }         
       98 +    });                                                       
       99 +  }                                                           
      100 +                                                              
      101 +  return new Response('Unauthorized', { status: 401 });       
      102 +}                                                             
      103 +                                                              
      104 +/**                                                           
      105 + * Create forbidden response for portal access                
      106 + *                                                            
      107 + * @param {string} portalType - Portal type                   
      108 + * @param {string|null} subdomain - Subdomain                 
      109 + * @param {Object} user - Authenticated user                  
      110 + * @returns {Response}                                        
      111 + */                                                           
      112 +function createPortalForbiddenResponse(portalType, subdomain, 
          +user) {                                                       
      113 +  return new Response(JSON.stringify({                        
      114 +    error: 'Forbidden',                                       
      115 +    message: `You do not have access to this ${portalType} por
          +tal`,                                                         
      116 +    portal: portalType,                                       
      117 +    station: subdomain,                                       
      118 +    user_role: user?.role,                                    
      119 +    user_station: user?.station_acronym                       
      120 +  }), {                                                       
      121 +    status: 403,                                              
      122 +    headers: { 'Content-Type': 'application/json' }           
      123 +  });                                                         
      124 +}                                                             
      125 +                                                              
      126  export default {
      127    async fetch(request, env, ctx) {
      128      const url = new URL(request.url);
       11 -    // Pass request to createCors for proper origin validation
          - (security fix v12.0.3)                                       
      129 +    const subdomain = getSubdomain(request);                  
      130 +    const portalType = getPortalType(subdomain);              
      131 +                                                              
      132 +    // Pass request to createCors for proper origin validation
      133      const { corsHeaders, handleCors } = createCors(request);
      134  
      135      // HTTPS Enforcement - Redirect HTTP to HTTPS
       15 -    // Note: Cloudflare typically handles this at edge, but we
          - ensure it here                                               
      136      if (url.protocol === 'http:' && !url.hostname.includes('lo
           calhost') && !url.hostname.includes('127.0.0.1')) {
      137        const httpsUrl = new URL(request.url);
      138        httpsUrl.protocol = 'https:';
     ...
      145      }
      146  
      147      try {
       28 -      // API Routes                                           
       29 -      if (url.pathname.startsWith('/api/')) {                 
       30 -        const response = await handleApiRequest(request, env, 
          -ctx);                                                         
       31 -                                                              
       32 -        // Add CORS headers to API responses                  
       33 -        Object.entries(corsHeaders).forEach(([key, value]) => 
          -{                                                             
       34 -          response.headers.set(key, value);                   
       35 -        });                                                   
       36 -                                                              
       37 -        return response;                                      
      148 +      // === PUBLIC PORTAL ===                                
      149 +      // No authentication required for public portal         
      150 +      if (portalType === 'public') {                          
      151 +        // API Routes for public portal                       
      152 +        if (url.pathname.startsWith('/api/')) {               
      153 +          // Public API endpoints don't require auth          
      154 +          // But standard API endpoints will check auth as usu
          +al                                                            
      155 +          const response = await handleApiRequest(request, env
          +, ctx);                                                       
      156 +                                                              
      157 +          Object.entries(corsHeaders).forEach(([key, value]) =
          +> {                                                           
      158 +            response.headers.set(key, value);                 
      159 +          });                                                 
      160 +                                                              
      161 +          return response;                                    
      162 +        }                                                     
      163 +                                                              
      164 +        // Static Asset Serving for public portal             
      165 +        return await handleStaticAssets(request, env, corsHead
          +ers, portalType);                                             
      166        }
      167  
       40 -      // Static Asset Serving                                 
       41 -      return await handleStaticAssets(request, env, corsHeader
          -s);                                                           
       42 -                                                              
      168 +      // === ADMIN and STATION PORTALS ===                    
      169 +      // Require Cloudflare Access authentication             
      170 +                                                              
      171 +      // Try to get user from CF Access JWT                   
      172 +      const cfAdapter = new CloudflareAccessAdapter(env);     
      173 +      let user = await cfAdapter.verifyAccessToken(request);  
      174 +                                                              
      175 +      // If no CF Access token, API endpoints may still use le
          +gacy auth                                                     
      176 +      // This is handled in handleApiRequest via getUserFromRe
          +quest                                                         
      177 +                                                              
      178 +      // For static assets on protected portals, require CF Ac
          +cess                                                          
      179 +      if (!url.pathname.startsWith('/api/')) {                
      180 +        if (!user) {                                          
      181 +          // No CF Access token - redirect to CF Access login 
      182 +          // Cloudflare Access handles this automatically via 
          +the WAF rules                                                 
      183 +          // If we reach here, it means CF Access is not confi
          +gured or bypassed                                             
      184 +          return createPortalUnauthorizedResponse(portalType, 
          +subdomain);                                                   
      185 +        }                                                     
      186 +                                                              
      187 +        // Check if user can access this portal               
      188 +        const canAccess = CloudflareAccessAdapter.canAccessPor
          +tal(user, portalType, subdomain);                             
      189 +        if (!canAccess) {                                     
      190 +          return createPortalForbiddenResponse(portalType, sub
          +domain, user);                                                
      191 +        }                                                     
      192 +                                                              
      193 +        // Serve static assets for authenticated portal       
      194 +        return await handleStaticAssets(request, env, corsHead
          +ers, portalType, subdomain, user);                            
      195 +      }                                                       
      196 +                                                              
      197 +      // === API ROUTES ===                                   
      198 +      // Add subdomain and portal context to request for downs
          +tream handlers                                                
      199 +      request.subdomain = subdomain;                          
      200 +      request.portalType = portalType;                        
      201 +      request.cfAccessUser = user;                            
      202 +                                                              
      203 +      const response = await handleApiRequest(request, env, ct
          +x);                                                           
      204 +                                                              
      205 +      // Add CORS headers to API responses                    
      206 +      Object.entries(corsHeaders).forEach(([key, value]) => { 
      207 +        response.headers.set(key, value);                     
      208 +      });                                                     
      209 +                                                              
      210 +      // Add portal context headers                           
      211 +      response.headers.set('X-Portal-Type', portalType);      
      212 +      if (subdomain) {                                        
      213 +        response.headers.set('X-Subdomain', subdomain);       
      214 +      }                                                       
      215 +                                                              
      216 +      return response;                                        
      217 +                                                              
      218      } catch (error) {
      219        console.error('Worker error:', error);
       45 -      return new Response(JSON.stringify({                    
      220 +      return new Response(JSON.stringify({                    
      221          error: 'Internal server error',
       47 -        message: error.message                                
      222 +        message: error.message                                
      223        }), {
      224          status: 500,
      225          headers: {
     ...
      231    }
      232  };
      233  
       59 -async function handleStaticAssets(request, env, corsHeaders) {
      234 +/**                                                           
      235 + * Handle static asset serving                                
      236 + *                                                            
      237 + * @param {Request} request - Incoming request                
      238 + * @param {Object} env - Cloudflare Worker environment        
      239 + * @param {Object} corsHeaders - CORS headers                 
      240 + * @param {string} portalType - Portal type                   
      241 + * @param {string|null} subdomain - Subdomain                 
      242 + * @param {Object|null} user - Authenticated user             
      243 + * @returns {Promise<Response>}                               
      244 + */                                                           
      245 +async function handleStaticAssets(request, env, corsHeaders, p
          +ortalType = 'public', subdomain = null, user = null) {        
      246    const url = new URL(request.url);
       61 -                                                              
       62 -  // Default to index.html for SPA routing                    
      247 +                                                              
      248 +  // Portal-specific asset paths                              
      249 +  const portalAssetMappings = {                               
      250 +    public: {                                                 
      251 +      '/': '/public-dashboard.html',                          
      252 +      default: '/public-dashboard.html'                       
      253 +    },                                                        
      254 +    admin: {                                                  
      255 +      '/': '/sites-dashboard.html',                           
      256 +      default: '/sites-dashboard.html'                        
      257 +    },                                                        
      258 +    station: {                                                
      259 +      '/': '/station-dashboard.html',                         
      260 +      default: '/station-dashboard.html'                      
      261 +    }                                                         
      262 +  };                                                          
      263 +                                                              
      264 +  // Known HTML pages                                         
      265    const assetPaths = [
      266      '/stations.html',
      267      '/instruments.html',
      268      '/export.html',
      269      '/station-dashboard.html',
      270      '/sites-dashboard.html',
       69 -    '/instrument.html'                                        
      271 +    '/public-dashboard.html',                                 
      272 +    '/instrument.html',                                       
      273 +    '/login.html',                                            
      274 +    '/admin.html'                                             
      275    ];
       71 -                                                              
      276 +                                                              
      277    let assetPath = url.pathname;
       73 -                                                              
       74 -  // Handle SPA routing - serve index.html for app routes     
      278 +                                                              
      279 +  // Handle SPA routing - determine default page based on port
          +al type                                                       
      280    if (assetPaths.some(path => url.pathname.startsWith(path.rep
           lace('.html', '')))) {
      281      assetPath = url.pathname + '.html';
      282    } else if (url.pathname === '/') {
       78 -    assetPath = '/index.html';                                
      283 +    // Use portal-specific default page                       
      284 +    const portalMapping = portalAssetMappings[portalType] || p
          +ortalAssetMappings.public;                                    
      285 +    assetPath = portalMapping['/'] || '/index.html';          
      286    }
       80 -                                                              
      287 +                                                              
      288    // Try to get the asset from the static assets binding
      289    try {
      290      const asset = await env.ASSETS.fetch(new URL(assetPath, re
           quest.url).toString());
       84 -                                                              
      291 +                                                              
      292      if (asset.status === 404) {
       86 -      // For unmatched routes, serve index.html (SPA fallback)
       87 -      const indexAsset = await env.ASSETS.fetch(new URL('/inde
          -x.html', request.url).toString());                            
       88 -      if (indexAsset.ok) {                                    
       89 -        const response = new Response(indexAsset.body, {      
      293 +      // For unmatched routes, serve portal-specific fallback 
      294 +      const portalMapping = portalAssetMappings[portalType] ||
          + portalAssetMappings.public;                                  
      295 +      const fallbackPath = portalMapping.default || '/index.ht
          +ml';                                                          
      296 +      const fallbackAsset = await env.ASSETS.fetch(new URL(fal
          +lbackPath, request.url).toString());                          
      297 +                                                              
      298 +      if (fallbackAsset.ok) {                                 
      299 +        const response = new Response(fallbackAsset.body, {   
      300            status: 200,
      301            headers: {
      302              'Content-Type': 'text/html',
      303 +            'X-Portal-Type': portalType,                      
      304              ...corsHeaders
      305            }
      306          });
      307          return response;
      308        }
      309      }
       99 -                                                              
      310 +                                                              
      311      if (asset.ok) {
      312        const response = new Response(asset.body, {
      313          status: asset.status,
      314          headers: {
      315            ...asset.headers,
      316 +          'X-Portal-Type': portalType,                        
      317            ...corsHeaders
      318          }
      319        });
      320        return response;
      321      }
      110 -                                                              
      322 +                                                              
      323    } catch (error) {
      324      console.error('Static asset error:', error);
      325    }
      114 -                                                              
      326 +                                                              
      327    // 404 fallback
      116 -  return new Response('Not Found', {                          
      328 +  return new Response('Not Found', {                          
      329      status: 404,
      330      headers: corsHeaders
      331    });
      120 -}                                                             
      332   No newline at end of file
      333 +}                                                             
✔ Task #3 updated: status → completed
✔ Task #4 updated: status → in progress
✔ Task #5 updated: status → in progress

● Write(src/config/allowed-origins.js)
  ⎿  Added 118 lines, removed 3 lines
       1  // Allowed origins for CORS
       2  // Only these origins can make cross-origin requests to the API
       3 +//                                                             
       4 +// v15.0.0: Added subdomain support for station portals        
       5 +//                                                             
       6 +// Architecture Credit: This subdomain-based architecture desig
         +n is based on                                                  
       7 +// architectural knowledge shared by Flights for Biodiversity S
         +weden AB                                                       
       8 +// (https://github.com/flightsforbiodiversity)                 
       9  
      10 +/**                                                            
      11 + * Static list of explicitly allowed origins                   
      12 + * Includes production domains, dev URLs, and local development
      13 + */                                                            
      14  export const ALLOWED_ORIGINS = [
       5 -  // Production - MGeo/Lund University account                 
      15 +  // Production - Root domain (public portal)                  
      16    'https://sitesspectral.work',
      17  
      18 +  // Production - Admin portal                                 
      19 +  'https://admin.sitesspectral.work',                          
      20 +                                                               
      21    // Production - Legacy jobelab account
      22    'https://sites.jobelab.com',
      23  
     ...
      33  ];
      34  
      35  /**
      36 + * Station acronyms for dynamic subdomain matching             
      37 + * These are used to generate allowed origins for station porta
         +ls                                                             
      38 + */                                                            
      39 +const STATION_ACRONYMS = [                                     
      40 +  'abisko',                                                    
      41 +  'ans',        // Abisko alternate                            
      42 +  'asa',                                                       
      43 +  'bolmen',                                                    
      44 +  'erken',                                                     
      45 +  'grimso',                                                    
      46 +  'gri',        // Grimso alternate                            
      47 +  'lonnstorp',                                                 
      48 +  'lon',        // Lonnstorp alternate                         
      49 +  'robacksdalen',                                              
      50 +  'rob',        // Robacksdalen alternate                      
      51 +  'skogaryd',                                                  
      52 +  'sko',        // Skogaryd alternate                          
      53 +  'svartberget',                                               
      54 +  'svb',        // Svartberget alternate                       
      55 +  // New stations (v14.1.0)                                    
      56 +  'alnarp',                                                    
      57 +  'aln',        // Alnarp alternate                            
      58 +  'hyltemossa',                                                
      59 +  'hyl',        // Hyltemossa alternate                        
      60 +];                                                             
      61 +                                                               
      62 +/**                                                            
      63 + * Generate dynamic station portal origins                     
      64 + *                                                             
      65 + * @returns {string[]} Array of station portal origins         
      66 + */                                                            
      67 +function generateStationOrigins() {                            
      68 +  return STATION_ACRONYMS.map(acronym =>                       
      69 +    `https://${acronym}.sitesspectral.work`                    
      70 +  );                                                           
      71 +}                                                              
      72 +                                                               
      73 +/**                                                            
      74 + * All allowed origins including dynamically generated station 
         +portals                                                        
      75 + */                                                            
      76 +const ALL_ALLOWED_ORIGINS = [                                  
      77 +  ...ALLOWED_ORIGINS,                                          
      78 +  ...generateStationOrigins()                                  
      79 +];                                                             
      80 +                                                               
      81 +/**                                                            
      82   * Check if an origin is allowed for CORS
      83 + * Supports both static list and dynamic subdomain patterns    
      84 + *                                                             
      85   * @param {string|null} origin - The origin header from the req
          uest
      86   * @returns {boolean} - True if origin is allowed
      87   */
     ...
       90      // No origin header - could be same-origin request or serv
           er-to-server
       91      return true;
       92    }
       32 -  return ALLOWED_ORIGINS.includes(origin);                    
       93 +                                                              
       94 +  // Check static list first                                  
       95 +  if (ALL_ALLOWED_ORIGINS.includes(origin)) {                 
       96 +    return true;                                              
       97 +  }                                                           
       98 +                                                              
       99 +  // Check dynamic subdomain pattern for sitesspectral.work   
      100 +  try {                                                       
      101 +    const url = new URL(origin);                              
      102 +    const host = url.hostname;                                
      103 +                                                              
      104 +    // Allow any subdomain of sitesspectral.work              
      105 +    if (host.endsWith('.sitesspectral.work')) {               
      106 +      // Extract subdomain                                    
      107 +      const subdomain = host.replace('.sitesspectral.work', ''
          +);                                                            
      108 +                                                              
      109 +      // Validate subdomain format (alphanumeric and hyphens o
          +nly)                                                          
      110 +      if (/^[a-z0-9-]+$/.test(subdomain)) {                   
      111 +        return true;                                          
      112 +      }                                                       
      113 +    }                                                         
      114 +                                                              
      115 +    // Allow workers.dev subdomains for development           
      116 +    if (host.endsWith('.workers.dev')) {                      
      117 +      return true;                                            
      118 +    }                                                         
      119 +                                                              
      120 +  } catch (e) {                                               
      121 +    // Invalid URL, fall through to false                     
      122 +  }                                                           
      123 +                                                              
      124 +  return false;                                               
      125  }
      126  
      127  /**
      128   * Get the appropriate Access-Control-Allow-Origin value
      129 + *                                                            
      130   * @param {string|null} origin - The origin header from the re
           quest
      131   * @returns {string} - The allowed origin or the first allowed
            origin as fallback
      132   */
      133  export function getAllowedOrigin(origin) {
       41 -  if (origin && ALLOWED_ORIGINS.includes(origin)) {           
      134 +  // If origin is allowed, return it (for dynamic origin suppo
          +rt)                                                           
      135 +  if (origin && isAllowedOrigin(origin)) {                    
      136      return origin;
      137    }
      138 +                                                              
      139    // Return first allowed origin as fallback (for error respon
           ses)
      140    return ALLOWED_ORIGINS[0];
      141  }
      142 +                                                              
      143 +/**                                                           
      144 + * Get list of station acronyms for validation                
      145 + *                                                            
      146 + * @returns {string[]} Array of valid station acronyms        
      147 + */                                                           
      148 +export function getStationAcronyms() {                        
      149 +  return [...STATION_ACRONYMS];                               
      150 +}                                                             
      151 +                                                              
      152 +/**                                                           
      153 + * Check if a subdomain corresponds to a valid station        
      154 + *                                                            
      155 + * @param {string} subdomain - Subdomain to check             
      156 + * @returns {boolean} True if subdomain is a valid station    
      157 + */                                                           
      158 +export function isValidStationSubdomain(subdomain) {          
      159 +  if (!subdomain) return false;                               
      160 +  return STATION_ACRONYMS.includes(subdomain.toLowerCase());  
      161 +}                                                             

● Write(wrangler.toml)
  ⎿  Added 74 lines, removed 7 lines
      10  # Enable auto-deployment from GitHub when commits are pushed to
           main branch
      11  
      12  # Project metadata
      13 -# Version: 11.0.0-alpha.33                                     
      14 -# Release: 2025-12-09                                          
      15 -# Database Schema: v12 (36 migrations) - ROI Legacy System + He
         -xagonal Architecture                                           
      13 +# Version: 15.0.0                                              
      14 +# Release: 2026-01-24                                          
      15 +# Database Schema: v15 (45 migrations) - Subdomain Architecture
         + + Cloudflare Access                                           
      16 +#                                                              
      17 +# Architecture Credit: This subdomain-based architecture design
         + is based on                                                   
      18 +# architectural knowledge shared by Flights for Biodiversity Sw
         +eden AB                                                        
      19 +# (https://github.com/flightsforbiodiversity)                  
      20  
      21  # Static Assets Configuration
      22  # v13.14.0: Vanilla JS frontend with design system
     ...
       37  [vars]
       38  ENVIRONMENT = "production"
       39  APP_NAME = "SITES Spectral Stations & Instruments"
       36 -APP_VERSION = "14.2.0"                                        
       40 +APP_VERSION = "15.0.0"                                        
       41  USE_CLOUDFLARE_SECRETS = "true"
       42  
       39 -# Custom domain routing                                       
       40 -# Accessible at: sitesspectral.work                           
       43 +# Cloudflare Access team domain for JWT verification          
       44 +CF_ACCESS_TEAM_DOMAIN = "sitesspectral.cloudflareaccess.com"  
       45 +                                                              
       46 +# ============================================================
          +==================                                            
       47 +# Custom Domain Routing (v15.0.0 - Subdomain Architecture)    
       48 +# ============================================================
          +==================                                            
       49 +#                                                             
       50 +# Portal Architecture:                                        
       51 +# - sitesspectral.work           → Public dashboard (no auth) 
       52 +# - admin.sitesspectral.work     → Admin portal (CF Access req
          +uired)                                                        
       53 +# - {station}.sitesspectral.work → Station portals (CF Access 
          +required)                                                     
       54 +#                                                             
       55 +# Examples:                                                   
       56 +# - svartberget.sitesspectral.work → Svartberget station porta
          +l                                                             
       57 +# - abisko.sitesspectral.work      → Abisko station portal    
       58 +# - lonnstorp.sitesspectral.work   → Lonnstorp station portal 
       59 +#                                                             
       60  # Workers.dev subdomain: sites-spectral-instruments.jose-beltr
           an.workers.dev
       61  
       62 +# Root domain routes                                          
       63  [[routes]]
       64  pattern = "sitesspectral.work/*"
       65  zone_id = "98a6b8637a4cc674eea24819d8f72b07"
       66  
       67  [[routes]]
       68  pattern = "sitesspectral.work"
       49 -zone_id = "98a6b8637a4cc674eea24819d8f72b07"                  
       69   No newline at end of file
       70 +zone_id = "98a6b8637a4cc674eea24819d8f72b07"                  
       71 +                                                              
       72 +# Wildcard subdomain routes (admin, station portals)          
       73 +[[routes]]                                                    
       74 +pattern = "*.sitesspectral.work/*"                            
       75 +zone_id = "98a6b8637a4cc674eea24819d8f72b07"                  
       76 +                                                              
       77 +[[routes]]                                                    
       78 +pattern = "*.sitesspectral.work"                              
       79 +zone_id = "98a6b8637a4cc674eea24819d8f72b07"                  
       80 +                                                              
       81 +# ============================================================
          +==================                                            
       82 +# Environment-specific Configuration                          
       83 +# ============================================================
          +==================                                            
       84 +                                                              
       85 +# Development environment                                     
       86 +[env.development]                                             
       87 +vars = { ENVIRONMENT = "development" }                        
       88 +                                                              
       89 +# Staging environment                                         
       90 +[env.staging]                                                 
       91 +vars = { ENVIRONMENT = "staging" }                            
       92 +                                                              
       93 +# ============================================================
          +==================                                            
       94 +# Notes on DNS Configuration                                  
       95 +# ============================================================
          +==================                                            
       96 +#                                                             
       97 +# Required DNS records (configure in Cloudflare Dashboard):   
       98 +#                                                             
       99 +# Type  | Name      | Target                                  
          +        | Proxied                                             
      100 +# ------|-----------|-----------------------------------------
          +-------|--------                                              
      101 +# CNAME | @         | sites-spectral-instruments.jose-e5f.work
          +ers.dev | Yes                                                 
      102 +# CNAME | admin     | sites-spectral-instruments.jose-e5f.work
          +ers.dev | Yes                                                 
      103 +# CNAME | *         | sites-spectral-instruments.jose-e5f.work
          +ers.dev | Yes                                                 
      104 +#                                                             
      105 +# Note: Wildcard CNAME requires Cloudflare Pro plan or higher 
          +for SSL coverage.                                             
      106 +# Alternative: Create individual CNAME records for each statio
          +n subdomain.                                                  
      107 +#                                                             
      108 +# Required Cloudflare Access Applications:                    
      109 +#                                                             
      110 +# 1. Admin Portal (admin.sitesspectral.work)                  
      111 +#    - Policies: Allow specific email addresses (jose.beltran@
          +mgeo.lu.se, lars.eklundh@nateko.lu.se)                        
      112 +#    - Session duration: 24 hours                             
      113 +#                                                             
      114 +# 2. Station Wildcard (*.sitesspectral.work)                  
      115 +#    - Policies: Allow station admin emails + UAV pilot groups
      116 +#    - Session duration: 24 hours                             
      117 +#    - Bypass rules: Exclude public assets (/api/public/*, /cs
          +s/*, /js/*, etc.)                                             
✔ Task #4 updated: status → completed
✔ Task #5 updated: status → completed
✔ Task #6 updated: status → in progress

● Update(src/domain/authorization/Role.js)
  ⎿  Added 7 lines, removed 1 line
       3   * Represents user's authorization role with type-safe constant
          s
       4   *
       5   * @module domain/authorization/Role
       6 - * @version 11.0.0-alpha.30                                    
       6 + * @version 15.0.0                                             
       7 + *                                                             
       8 + * Architecture Credit: This subdomain-based architecture desig
         +n is based on                                                  
       9 + * architectural knowledge shared by Flights for Biodiversity S
         +weden AB                                                       
      10 + * (https://github.com/flightsforbiodiversity)                 
      11   */
      12  
      13  export class Role {
     ...
      16    static SITES_ADMIN = 'sites-admin';      // New global admin 
          standard
      17    static STATION_ADMIN = 'station-admin';  // Station-specific 
          admin
      18    static STATION_USER = 'station';         // Regular station u
          ser
      19 +  static UAV_PILOT = 'uav-pilot';          // UAV pilot with mi
         +ssion/flight logging                                           
      20 +  static STATION_INTERNAL = 'station-internal'; // Internal rea
         +d-only via magic link                                          
      21    static READONLY = 'readonly';            // Read-only access
      22  
      23    // Global admin usernames (explicit whitelist)

● Update(src/domain/authorization/Role.js)
  ⎿  Added 2 lines
      43        Role.SITES_ADMIN,
      44        Role.STATION_ADMIN,
      45        Role.STATION_USER,
      46 +      Role.UAV_PILOT,                                          
      47 +      Role.STATION_INTERNAL,                                   
      48        Role.READONLY
      49      ];
      50      if (!validRoles.includes(value)) {

● Read(src/domain/authorization/Role.js)
  ⎿  Read 120 lines

● Update(src/domain/authorization/Role.js)
  ⎿  Added 33 lines, removed 1 line
       81     * @returns {boolean}
       82     */
       83    isReadOnly() {
       84 -    return this.value === Role.READONLY;                      
       84 +    return this.value === Role.READONLY || this.value === Role
          +.STATION_INTERNAL;                                            
       85    }
       86  
       87    /**
       88 +   * Check if this role represents a UAV pilot                
       89 +   * @returns {boolean}                                       
       90 +   */                                                         
       91 +  isUAVPilot() {                                              
       92 +    return this.value === Role.UAV_PILOT;                     
       93 +  }                                                           
       94 +                                                              
       95 +  /**                                                         
       96 +   * Check if this role represents a station internal user    
       97 +   * @returns {boolean}                                       
       98 +   */                                                         
       99 +  isStationInternal() {                                       
      100 +    return this.value === Role.STATION_INTERNAL;              
      101 +  }                                                           
      102 +                                                              
      103 +  /**                                                         
      104 +   * Check if this role can access flight logs                
      105 +   * @returns {boolean}                                       
      106 +   */                                                         
      107 +  canAccessFlightLogs() {                                     
      108 +    return this.isGlobalAdmin() || this.isStationAdmin() || th
          +is.isUAVPilot();                                              
      109 +  }                                                           
      110 +                                                              
      111 +  /**                                                         
      112 +   * Check if this role can create flight logs                
      113 +   * @returns {boolean}                                       
      114 +   */                                                         
      115 +  canCreateFlightLogs() {                                     
      116 +    return this.isGlobalAdmin() || this.isUAVPilot();         
      117 +  }                                                           
      118 +                                                              
      119 +  /**                                                         
      120     * Check if this role can edit station records
      121     * @returns {boolean}
      122     */
✔ Task #6 updated: status → completed
✔ Task #7 updated: status → in progress

● Write(src/handlers/magic-links.js)
  ⎿  Wrote 482 lines to src/handlers/magic-links.js
       1 /**
       2  * Magic Links Handler
       3  * Token-based authentication for station internal users
       4  *
       5  * Provides passwordless, time-limited access for internal stati
         on users
       6  * who need read-only access to station data.
       7  *
       8  * Architecture Credit: This subdomain-based architecture design
          is based on
       9  * architectural knowledge shared by Flights for Biodiversity Sw
         eden AB
      10  * (https://github.com/flightsforbiodiversity)
     … +472 lines (ctrl+o to expand)
✔ Task #7 updated: status → completed
✔ Task #8 updated: status → in progress

● Write(src/handlers/public.js)
  ⎿  Wrote 359 lines to src/handlers/public.js
       1 /**
       2  * Public API Handler
       3  * No-authentication endpoints for public dashboard and status
       4  *
       5  * Provides read-only access to station status, platform counts,
       6  * and system health without requiring authentication.
       7  *
       8  * Architecture Credit: This subdomain-based architecture design
          is based on
       9  * architectural knowledge shared by Flights for Biodiversity Sw
         eden AB
      10  * (https://github.com/flightsforbiodiversity)
     … +349 lines (ctrl+o to expand)
✔ Task #8 updated: status → completed
✔ Task #9 updated: status → in progress

● Bash(mkdir -p /lunarc/nobackup/projects/sitesspec/SITES/Spectral/apps/sites-sp
      ectral-manager/apps/webapp-instruments/src/domain/uav)
  ⎿  (No content)

● Write(src/domain/uav/Pilot.js)
  ⎿  Wrote 256 lines to src/domain/uav/Pilot.js
       1 /**
       2  * UAV Pilot Entity
       3  * Represents a certified UAV pilot with authorization to fly at
          SITES stations
       4  *
       5  * Architecture Credit: This subdomain-based architecture design
          is based on
       6  * architectural knowledge shared by Flights for Biodiversity Sw
         eden AB
       7  * (https://github.com/flightsforbiodiversity)
       8  *
       9  * @module domain/uav/Pilot
      10  * @version 15.0.0
     … +246 lines (ctrl+o to expand)

● Write(src/domain/uav/Mission.js)
  ⎿  Wrote 364 lines to src/domain/uav/Mission.js
       1 /**
       2  * UAV Mission Entity
       3  * Represents a planned or executed UAV data collection mission
       4  *
       5  * Architecture Credit: This subdomain-based architecture design
          is based on
       6  * architectural knowledge shared by Flights for Biodiversity Sw
         eden AB
       7  * (https://github.com/flightsforbiodiversity)
       8  *
       9  * @module domain/uav/Mission
      10  * @version 15.0.0
     … +354 lines (ctrl+o to expand)

● Write(src/domain/uav/FlightLog.js)
  ⎿  Wrote 282 lines to src/domain/uav/FlightLog.js
       1 /**
       2  * UAV Flight Log Entity
       3  * Represents an individual flight within a mission (each batter
         y swap = new flight)
       4  *
       5  * Architecture Credit: This subdomain-based architecture design
          is based on
       6  * architectural knowledge shared by Flights for Biodiversity Sw
         eden AB
       7  * (https://github.com/flightsforbiodiversity)
       8  *
       9  * @module domain/uav/FlightLog
      10  * @version 15.0.0
     … +272 lines (ctrl+o to expand)

● Write(src/domain/uav/index.js)
  ⎿  Wrote 15 lines to src/domain/uav/index.js
       1 /**
       2  * UAV Domain Module Exports
       3  *
       4  * Architecture Credit: This subdomain-based architecture design
          is based on
       5  * architectural knowledge shared by Flights for Biodiversity Sw
         eden AB
       6  * (https://github.com/flightsforbiodiversity)
       7  *
       8  * @module domain/uav
       9  * @version 15.0.0
      10  */
     … +5 lines (ctrl+o to expand)
✔ Task #9 updated: status → completed
✔ Task #10 updated: status → in progress

● Bash(mkdir -p /lunarc/nobackup/projects/sitesspec/SITES/Spectral/apps/sites-sp
      ectral-manager/apps/webapp-instruments/docs/architecture
      /lunarc/nobackup/projects/site…)
  ⎿  (No content)

● Write(docs/architecture/SUBDOMAIN_ARCHITECTURE.md)
  ⎿  Wrote 299 lines to docs/architecture/SUBDOMAIN_ARCHITECTURE.md
      1 # SITES Spectral Subdomain Architecture
      2 > **Architecture Credit**: This subdomain-based architecture desi
        gn is based on
      3 > architectural knowledge shared by **Flights for Biodiversity Sw
        eden AB**
      4 > (https://github.com/flightsforbiodiversity).
      5 ## Version History
      6 | Version | Date | Author | Description |
      7 |---------|------|--------|-------------|
     … +289 lines (ctrl+o to expand)

● Write(docs/security/CLOUDFLARE_ACCESS_INTEGRATION.md)
  ⎿  Wrote 253 lines to docs/security/CLOUDFLARE_ACCESS_INTEGRATION.md
      1 # Cloudflare Access Integration
      2 > **Architecture Credit**: This subdomain-based architecture desi
        gn is based on
      3 > architectural knowledge shared by **Flights for Biodiversity Sw
        eden AB**
      4 > (https://github.com/flightsforbiodiversity).
      5 ## Overview
      6 SITES Spectral uses Cloudflare Access for passwordless authentica
        tion via email OTP. This replaces the traditional username/passwo
        rd authentication for admin and station portals.
     … +243 lines (ctrl+o to expand)

● Write(docs/MAGIC_LINK_SYSTEM.md)
  ⎿  Wrote 276 lines to docs/MAGIC_LINK_SYSTEM.md
      1 # Magic Link System
      2 > **Architecture Credit**: This subdomain-based architecture desi
        gn is based on
      3 > architectural knowledge shared by **Flights for Biodiversity Sw
        eden AB**
      4 > (https://github.com/flightsforbiodiversity).
      5 ## Overview
      6 Magic links provide passwordless, time-limited access for station
         internal users who need read-only access to station data without
         requiring a full user account or Cloudflare Access.
     … +266 lines (ctrl+o to expand)

● Write(docs/UAV_PILOT_SYSTEM.md)
  ⎿  Wrote 353 lines to docs/UAV_PILOT_SYSTEM.md
      1 # UAV Pilot System
      2 > **Architecture Credit**: This subdomain-based architecture desi
        gn is based on
      3 > architectural knowledge shared by **Flights for Biodiversity Sw
        eden AB**
      4 > (https://github.com/flightsforbiodiversity).
      5 ## Overview
      6 The UAV Pilot System provides comprehensive management for UAV op
        erations at SITES Spectral stations, including pilot certificatio
        n tracking, mission planning, flight logging, and battery managem
        ent.
     … +343 lines (ctrl+o to expand)
✔ Task #10 updated: status → completed
✔ Task #11 updated: status → in progress

● Read(src/auth/authentication.js)
  ⎿  Read 444 lines

● Update(src/auth/authentication.js)
  ⎿  Added 6 lines, removed 1 line
       1  // Authentication Module
       2  // JWT authentication with HMAC-SHA256 signing, user verificati
          on, session management
       3 -// v12.0.8: Added rate limiting for brute force protection     
       3 +// v15.0.0: Added Cloudflare Access JWT verification for subdom
         +ain architecture                                               
       4 +//                                                             
       5 +// Architecture Credit: This subdomain-based architecture desig
         +n is based on                                                  
       6 +// architectural knowledge shared by Flights for Biodiversity S
         +weden AB                                                       
       7 +// (https://github.com/flightsforbiodiversity)                 
       8  
       9  import { SignJWT, jwtVerify } from 'jose';
      10  import { createErrorResponse, createUnauthorizedResponse } from
           '../utils/responses.js';
     ...
      16    recordAuthAttempt,
      17    getRateLimitHeaders
      18  } from '../middleware/auth-rate-limiter.js';
      19 +import { CloudflareAccessAdapter } from '../infrastructure/auth
         +/CloudflareAccessAdapter.js';                                  
      20  
      21  /**
      22   * Handle authentication endpoints

● Update(src/auth/authentication.js)
  ⎿  Added 74 lines, removed 3 lines
      293  
      294  /**
      295   * Extract and validate user from request
      296 - * Checks httpOnly cookie first, then falls back to Authorizat
          -ion header                                                    
      297 - * Uses proper JWT verification with HMAC-SHA256              
      296 + *                                                            
      297 + * Authentication priority (v15.0.0):                         
      298 + * 1. Cloudflare Access JWT (Cf-Access-Jwt-Assertion header)  
      299 + * 2. Request context (cfAccessUser set by worker)            
      300 + * 3. httpOnly cookie (legacy password auth)                  
      301 + * 4. Authorization header (legacy API access)                
      302 + *                                                            
      303   * @param {Request} request - The request object
      304   * @param {Object} env - Environment variables and bindings
      305   * @returns {Object|null} User object or null if invalid
      306   */
      307  export async function getUserFromRequest(request, env) {
      308    try {
      309 +    // Priority 1: Check for Cloudflare Access JWT (passwordle
          +ss auth)                                                      
      310 +    const cfAccessUser = await getUserFromCFAccess(request, en
          +v);                                                           
      311 +    if (cfAccessUser) {                                       
      312 +      return cfAccessUser;                                    
      313 +    }                                                         
      314 +                                                              
      315 +    // Priority 2: Check request context (set by worker subdom
          +ain routing)                                                  
      316 +    if (request.cfAccessUser) {                               
      317 +      return request.cfAccessUser;                            
      318 +    }                                                         
      319 +                                                              
      320 +    // Priority 3-4: Legacy authentication (cookie or Bearer t
          +oken)                                                         
      321 +    return await getUserFromLegacyAuth(request, env);         
      322 +                                                              
      323 +  } catch (error) {                                           
      324 +    console.error('Authentication error:', error);            
      325 +    return null;                                              
      326 +  }                                                           
      327 +}                                                             
      328 +                                                              
      329 +/**                                                           
      330 + * Get user from Cloudflare Access JWT                        
      331 + *                                                            
      332 + * @param {Request} request - The request object              
      333 + * @param {Object} env - Environment variables and bindings   
      334 + * @returns {Object|null} User object or null if not CF Access
          + auth                                                         
      335 + */                                                           
      336 +async function getUserFromCFAccess(request, env) {            
      337 +  try {                                                       
      338 +    // Check for CF Access JWT header                         
      339 +    const cfAccessJwt = request.headers.get('Cf-Access-Jwt-Ass
          +ertion');                                                     
      340 +    if (!cfAccessJwt) {                                       
      341 +      return null;                                            
      342 +    }                                                         
      343 +                                                              
      344 +    // Use CloudflareAccessAdapter to verify and map user     
      345 +    const cfAdapter = new CloudflareAccessAdapter(env);       
      346 +    const user = await cfAdapter.verifyAccessToken(request);  
      347 +                                                              
      348 +    if (user) {                                               
      349 +      // Add auth provider for tracking                       
      350 +      user.auth_provider = 'cloudflare_access';               
      351 +    }                                                         
      352 +                                                              
      353 +    return user;                                              
      354 +                                                              
      355 +  } catch (error) {                                           
      356 +    console.error('CF Access verification error:', error);    
      357 +    return null;                                              
      358 +  }                                                           
      359 +}                                                             
      360 +                                                              
      361 +/**                                                           
      362 + * Get user from legacy authentication (cookie or Bearer token
          +)                                                             
      363 + *                                                            
      364 + * @param {Request} request - The request object              
      365 + * @param {Object} env - Environment variables and bindings   
      366 + * @returns {Object|null} User object or null if invalid      
      367 + */                                                           
      368 +async function getUserFromLegacyAuth(request, env) {          
      369 +  try {                                                       
      370      // First, try to get token from httpOnly cookie (preferred
            method)
      371      let token = getTokenFromCookie(request);
      372  
     ...
      403        return null;
      404      }
      405  
      406 +    // Determine auth provider from payload                   
      407 +    const authProvider = payload.auth_provider || 'database'; 
      408 +                                                              
      409      // Token validated successfully
      410      return {
      411        username: payload.username,
     ...
      414        station_normalized_name: payload.station_normalized_name
           ,
      415        station_id: payload.station_id,
      416        edit_privileges: payload.edit_privileges,
      348 -      permissions: payload.permissions                        
      417 +      permissions: payload.permissions,                       
      418 +      auth_provider: authProvider,                            
      419 +      magic_link_id: payload.magic_link_id                    
      420      };
      421    } catch (error) {
      422      // Handle specific JWT errors

● Update(src/auth/authentication.js)
  ⎿  Added 2 lines
      223        'sites-admin': ['read', 'write', 'edit', 'delete', 'admi
           n'],
      224        'station-admin': ['read', 'write', 'edit', 'delete'],
      225        'station': ['read'],
      226 +      'uav-pilot': ['read', 'flight-log'],                    
      227 +      'station-internal': ['read'],                           
      228        'readonly': ['read']
      229      };
      230  
✔ Task #11 updated: status → completed
11 tasks (11 done, 0 open)

✔ #11 Update authentication.js for dual-auth
✔ #10 Create architecture documentation
✔ #6 Add UAV pilot role to Role.js
✔ #1 Create database migration for subdomain auth and UAV
✔ #7 Create magic links handler
✔ #2 Create Cloudflare Access adapter
✔ #8 Create public API endpoints
✔ #3 Update worker.js for subdomain routing
✔ #9 Create UAV domain entities
✔ #4 Update CORS for subdomains
✔ #5 Update wrangler.toml for wildcard routes

● All 11 tasks completed. Now let me update the package.json version and
  CHANGELOG.

● Update(package.json)
  ⎿  Added 2 lines, removed 2 lines
      1  {
      2    "name": "sites-spectral-stations-instruments",
      3 -  "version": "14.2.0",                                          
      4 -  "description": "SITES Spectral v14.2.0 - Stations & Instrument
        -s Registry",                                                    
      3 +  "version": "15.0.0",                                          
      4 +  "description": "SITES Spectral v15.0.0 - Subdomain Architectur
        +e with Cloudflare Access",                                      
      5    "main": "src/worker.js",
      6    "scripts": {
      7      "dev": "wrangler dev --local --persist-to=.wrangler/state",

● Search(pattern: "CHANGELOG.md", path: "/lunarc/nobackup/projects/sitesspec/SIT
        ES/Spectral/apps/sites-spectral-manager/apps/webapp-instruments")
  ⎿  Found 20 files (ctrl+o to expand)

● Read(CHANGELOG.md)
  ⎿  Read 100 lines

● Update(CHANGELOG.md)
  ⎿  Added 85 lines
       13  
       14  ---
       15  
       16 +## [15.0.0] - 2026-01-24                                      
       17 +                                                              
       18 +### Feature: Subdomain Architecture with Cloudflare Access    
       19 +                                                              
       20 +> **Architecture Credit**: This subdomain-based architecture d
          +esign is based on                                             
       21 +> architectural knowledge shared by **Flights for Biodiversity
          + Sweden AB**                                                  
       22 +> (https://github.com/flightsforbiodiversity).                
       23 +                                                              
       24 +Migration from single-domain to subdomain-based architecture w
          +ith Cloudflare Access authentication.                         
       25 +                                                              
       26 +#### Portal Architecture                                      
       27 +                                                              
       28 +| Portal | Domain | Authentication | Purpose |                
       29 +|--------|--------|----------------|---------|                
       30 +| **Public** | `sitesspectral.work` | None | Public dashboard,
          + status |                                                     
       31 +| **Admin** | `admin.sitesspectral.work` | CF Access OTP | Glo
          +bal admin access |                                            
       32 +| **Station** | `{station}.sitesspectral.work` | CF Access / M
          +agic Link | Station-specific access |                         
       33 +                                                              
       34 +#### New Authentication Methods                               
       35 +                                                              
       36 +- **Cloudflare Access JWT**: Passwordless authentication via e
          +mail OTP                                                      
       37 +- **Magic Links**: Time-limited, single-use tokens for station
          + internal users                                               
       38 +- **Dual-Auth Support**: CF Access takes priority, falls back 
          +to legacy httpOnly cookies                                    
       39 +                                                              
       40 +#### New User Roles                                           
       41 +                                                              
       42 +| Role | Permissions | Use Case |                             
       43 +|------|-------------|----------|                             
       44 +| `uav-pilot` | read, flight-log | UAV operators with mission 
          +logging |                                                     
       45 +| `station-internal` | read | Internal users via magic link | 
       46 +                                                              
       47 +#### UAV Management System                                    
       48 +                                                              
       49 +- **Pilot Registry**: Track certifications, insurance, authori
          +zed stations                                                  
       50 +- **Mission Planning**: Plan, approve, and execute UAV mission
          +s                                                             
       51 +- **Flight Logging**: Record individual flights with telemetry
          + data                                                         
       52 +- **Battery Tracking**: Manage battery inventory and health   
       53 +                                                              
       54 +#### New Files                                                
       55 +                                                              
       56 +| File | Purpose |                                            
       57 +|------|---------|                                            
       58 +| `src/infrastructure/auth/CloudflareAccessAdapter.js` | CF Ac
          +cess JWT verification |                                       
       59 +| `src/handlers/magic-links.js` | Magic link CRUD operations |
       60 +| `src/handlers/public.js` | Public API endpoints (no auth) | 
       61 +| `src/domain/uav/Pilot.js` | UAV pilot entity |              
       62 +| `src/domain/uav/Mission.js` | Mission planning entity |     
       63 +| `src/domain/uav/FlightLog.js` | Flight log entity |         
       64 +| `migrations/0045_subdomain_auth_uav_missions.sql` | Schema c
          +hanges |                                                      
       65 +                                                              
       66 +#### Modified Files                                           
       67 +                                                              
       68 +| File | Changes |                                            
       69 +|------|---------|                                            
       70 +| `src/worker.js` | Subdomain detection and portal routing |  
       71 +| `src/auth/authentication.js` | Dual-auth with CF Access prio
          +rity |                                                        
       72 +| `src/domain/authorization/Role.js` | Added `uav-pilot`, `sta
          +tion-internal` roles |                                        
       73 +| `src/config/allowed-origins.js` | Dynamic subdomain CORS sup
          +port |                                                        
       74 +| `wrangler.toml` | Wildcard subdomain routes |               
       75 +                                                              
       76 +#### Documentation                                            
       77 +                                                              
       78 +- `docs/architecture/SUBDOMAIN_ARCHITECTURE.md` - Architecture
          + overview                                                     
       79 +- `docs/security/CLOUDFLARE_ACCESS_INTEGRATION.md` - CF Access
          + setup                                                        
       80 +- `docs/MAGIC_LINK_SYSTEM.md` - Magic link implementation     
       81 +- `docs/UAV_PILOT_SYSTEM.md` - UAV pilot and mission managemen
          +t                                                             
       82 +                                                              
       83 +#### Database Migration (0045)                                
       84 +                                                              
       85 +New tables:                                                   
       86 +- `magic_link_tokens` - Token storage and lifecycle           
       87 +- `uav_pilots` - Pilot registry with certifications           
       88 +- `uav_missions` - Mission planning and execution             
       89 +- `mission_pilots` - Pilot-mission assignments                
       90 +- `uav_flight_logs` - Individual flight records               
       91 +- `uav_batteries` - Battery inventory                         
       92 +                                                              
       93 +New columns on `users`:                                       
       94 +- `auth_provider` - 'database', 'cloudflare_access', or 'magic
          +_link'                                                        
       95 +- `cf_access_email` - Email from CF Access identity           
       96 +- `cf_access_identity_id` - CF Access subject ID              
       97 +- `last_cf_access_login` - Last CF Access login timestamp     
       98 +                                                              
       99 +---                                                           
      100 +                                                              
      101  ## [14.2.0] - 2026-01-24
      102  
      103  ### Feature: New Production Domain & Database Authentication

● Read(CLAUDE.md)
  ⎿  Read 100 lines

● Update(CLAUDE.md)
  ⎿  Added 36 lines, removed 5 lines
       60  
       61  ---
       62  
       63 -## Current Version: 14.1.0 - Alnarp & Hyltemossa Stations (202
          -6-01-23)                                                      
       63 +## Current Version: 15.0.0 - Subdomain Architecture with Cloud
          +flare Access (2026-01-24)                                     
       64  
       65 +> **Architecture Credit**: This subdomain-based architecture d
          +esign is based on                                             
       66 +> architectural knowledge shared by **Flights for Biodiversity
          + Sweden AB**                                                  
       67 +> (https://github.com/flightsforbiodiversity).                
       68 +                                                              
       69  **✅ STATUS: PRODUCTION READY**
       66 -**🌐 Production URL:** https://sites.jobelab.com              
       67 -**🔗 Worker URL:** https://sites-spectral-instruments.jose-e5f
          -.workers.dev                                                  
       68 -**📅 Last Updated:** 2026-01-23                               
       70 +**🌐 Public Portal:** https://sitesspectral.work              
       71 +**🔐 Admin Portal:** https://admin.sitesspectral.work         
       72 +**📍 Station Portals:** https://{station}.sitesspectral.work  
       73 +**🔗 Worker URL:** https://sites-spectral-instruments.jose-bel
          +tran.workers.dev                                              
       74 +**📅 Last Updated:** 2026-01-24                               
       75  **🚀 API Version:** V11 (via `/api/latest` alias)
       70 -**🔒 Security Features:** CORS Whitelist, PBKDF2 Password Hash
          -ing, httpOnly Cookies, CSRF Protection, Input Sanitization, JW
          -T HMAC-SHA256, XSS-Safe DOM Methods                           
       76 +**🔒 Auth Methods:** Cloudflare Access OTP, Magic Links, httpO
          +nly Cookies                                                   
       77  **♿ Accessibility:** WCAG 2.4.3 Modal Focus Trap
       78  **📚 Standard Vocabularies:** Darwin Core, ICOS, Copernicus al
           igned
       79  **🧪 Test Coverage:** 653 tests across 36 test files
       80  **📍 Stations:** 9 SITES member stations (7 original + ALN, HY
           L)
       81  
       82 +### What's New in v15.0.0                                     
       83 +                                                              
       84 +**Subdomain-Based Portal Architecture** - Migration from singl
          +e-domain to subdomain-based architecture with Cloudflare Acces
          +s authentication:                                             
       85 +                                                              
       86 +| Portal | Domain | Authentication |                          
       87 +|--------|--------|----------------|                          
       88 +| Public | `sitesspectral.work` | None (public dashboard) |   
       89 +| Admin | `admin.sitesspectral.work` | CF Access OTP |        
       90 +| Station | `{station}.sitesspectral.work` | CF Access / Magic
          + Link |                                                       
       91 +                                                              
       92 +**New Authentication Methods:**                               
       93 +- **Cloudflare Access JWT**: Passwordless email OTP           
       94 +- **Magic Links**: Time-limited tokens for internal users     
       95 +- **Dual-Auth**: CF Access priority, falls back to legacy cook
          +ies                                                           
       96 +                                                              
       97 +**New Roles:**                                                
       98 +- `uav-pilot` - UAV operators with mission/flight logging     
       99 +- `station-internal` - Internal read-only via magic link      
      100 +                                                              
      101 +**UAV Management System:**                                    
      102 +- Pilot registry with certifications                          
      103 +- Mission planning and execution                              
      104 +- Flight logging with telemetry                               
      105 +- Battery inventory tracking                                  
      106 +                                                              
      107  ### What's New in v14.1.0
      108  
      109  **Alnarp & Hyltemossa Stations with Management Tracking** - Ad
           ded two new SITES stations with enhanced platform management t
           racking:

● Implementation complete. Here's a summary of all changes made:

  Summary - SITES Spectral v15.0.0 Subdomain Architecture

  New Files Created
  File: migrations/0045_subdomain_auth_uav_missions.sql
  Purpose: Database schema for auth, magic links, UAV system
  ────────────────────────────────────────
  File: src/infrastructure/auth/CloudflareAccessAdapter.js
  Purpose: CF Access JWT verification adapter
  ────────────────────────────────────────
  File: src/infrastructure/auth/index.js
  Purpose: Module exports
  ────────────────────────────────────────
  File: src/handlers/magic-links.js
  Purpose: Magic link CRUD endpoints
  ────────────────────────────────────────
  File: src/handlers/public.js
  Purpose: Public API endpoints (no auth)
  ────────────────────────────────────────
  File: src/domain/uav/Pilot.js
  Purpose: UAV pilot entity
  ────────────────────────────────────────
  File: src/domain/uav/Mission.js
  Purpose: UAV mission entity
  ────────────────────────────────────────
  File: src/domain/uav/FlightLog.js
  Purpose: UAV flight log entity
  ────────────────────────────────────────
  File: src/domain/uav/index.js
  Purpose: UAV module exports
  ────────────────────────────────────────
  File: docs/architecture/SUBDOMAIN_ARCHITECTURE.md
  Purpose: Architecture overview
  ────────────────────────────────────────
  File: docs/security/CLOUDFLARE_ACCESS_INTEGRATION.md
  Purpose: CF Access setup guide
  ────────────────────────────────────────
  File: docs/MAGIC_LINK_SYSTEM.md
  Purpose: Magic link documentation
  ────────────────────────────────────────
  File: docs/UAV_PILOT_SYSTEM.md
  Purpose: UAV system documentation
  Modified Files
  File: src/worker.js
  Changes: Added subdomain detection, portal routing, CF Access integration
  ────────────────────────────────────────
  File: src/auth/authentication.js
  Changes: Dual-auth support (CF Access priority, legacy fallback)
  ────────────────────────────────────────
  File: src/domain/authorization/Role.js
  Changes: Added uav-pilot, station-internal roles
  ────────────────────────────────────────
  File: src/config/allowed-origins.js
  Changes: Dynamic subdomain CORS support
  ────────────────────────────────────────
  File: wrangler.toml
  Changes: Wildcard subdomain routes, updated version
  ────────────────────────────────────────
  File: package.json
  Changes: Updated to v15.0.0
  ────────────────────────────────────────
  File: CHANGELOG.md
  Changes: Added v15.0.0 entry
  ────────────────────────────────────────
  File: CLAUDE.md
  Changes: Updated current version section
  Key Features

  1. Three Portal Types:
    - Public: sitesspectral.work - No auth, public dashboard
    - Admin: admin.sitesspectral.work - CF Access for global admins
    - Station: {station}.sitesspectral.work - CF Access or magic links
  2. Authentication Priority:
    - Cloudflare Access JWT (primary)
    - Request context (from worker routing)
    - httpOnly cookie (legacy)
    - Bearer token (API access)
  3. UAV Management: Complete system for pilot registration, mission planning,
  flight logging, and battery tracking
  4. Magic Links: Secure, time-limited tokens for internal station access

  Next Steps (Manual Configuration)

  1. DNS Setup: Add wildcard CNAME records in Cloudflare
  2. CF Access Apps: Create admin and station wildcard applications
  3. Database Migration: Run npm run db:migrate to apply migration 0045
  4. User Setup: Register users with cf_access_email for passwordless auth

✻ Worked for 15m 58s

❯ please show me briefly how to set those manually 

● Manual Configuration Steps

  1. DNS Setup (Cloudflare Dashboard)

  Dashboard → DNS → Records → Add Record

  Type: CNAME | Name: admin | Target:
  sites-spectral-instruments.jose-beltran.workers.dev | Proxied: Yes
  Type: CNAME | Name: *     | Target:
  sites-spectral-instruments.jose-beltran.workers.dev | Proxied: Yes

  Note: Wildcard CNAME requires Cloudflare Pro for SSL. Alternative: create 
  individual CNAMEs for each station (svartberget, abisko, lonnstorp, etc.)

  2. Cloudflare Access Applications

  Zero Trust Dashboard → Access → Applications → Add Application → Self-hosted

  # App 1: Admin Portal
  Name: SITES Spectral Admin Portal
  Domain: admin.sitesspectral.work
  Session Duration: 24 hours

  Policy: Allow Global Admins
    - Include → Emails: jose.beltran@mgeo.lu.se
    - Include → Emails: lars.eklundh@nateko.lu.se

  # App 2: Station Portals
  Name: SITES Spectral Station Portals
  Domain: *.sitesspectral.work
  Session Duration: 24 hours

  Policy: Allow Station Users
    - Include → Emails ending in: @slu.se
    - Include → Emails ending in: @nateko.lu.se
    - Include → Emails ending in: @mgeo.lu.se

  Bypass Rule (for public assets):
    - Path starts with: /api/public/
    - Path starts with: /css/
    - Path starts with: /js/

  3. Database Migration

  cd /lunarc/nobackup/projects/sitesspec/SITES/Spectral/apps/sites-spectral-mana
  ger/apps/webapp-instruments

  # Apply migration to remote D1
  npm run db:migrate

  4. Register CF Access Users

  # Via wrangler d1 execute
  npx wrangler d1 execute spectral_stations_db --remote --command="
  INSERT INTO users (username, email, role, station_id, auth_provider, 
  cf_access_email, active)
  VALUES 
    ('svb-admin', 'user@slu.se', 'station-admin', 7, 'cloudflare_access', 
  'user@slu.se', 1);
  "

  5. Set CF Access AUD (Optional but recommended)

  # Get AUD from CF Access Application details, then:
  npx wrangler secret put CF_ACCESS_AUD
  # Paste the Application Audience value

  6. Deploy

  npm run deploy

  Verification

  # Test public portal (should work without auth)
  curl https://sitesspectral.work/api/public/health

  # Test admin portal (should require CF Access)
  curl https://admin.sitesspectral.work/api/health
  # Expected: 401 or redirect to CF Access login

  # Test station portal
  curl https://svartberget.sitesspectral.work/api/health
  # Expected: 401 or redirect to CF Access login

❯ can I use as target the domain and not the worker? 

● No, you can't CNAME a subdomain to the apex domain within the same zone. But
  since you're using Cloudflare Workers with routes, you can use a placeholder A
   record instead:

  Dashboard → DNS → Records → Add Record

  Type: A | Name: admin | Content: 192.0.2.1 | Proxied: Yes (orange cloud)
  Type: A | Name: *     | Content: 192.0.2.1 | Proxied: Yes (orange cloud)

  The IP 192.0.2.1 is a documentation IP that goes nowhere, but it doesn't
  matter because:

  1. The orange cloud (Proxied) means traffic goes through Cloudflare
  2. Your Worker routes in wrangler.toml catch *.sitesspectral.work/*
  3. Cloudflare routes the request to your Worker, not the IP

  This is actually the standard pattern when using Workers with custom domains -
   the DNS target is just a placeholder to enable the proxy.

  Alternative: Individual A Records

  If wildcard doesn't work on your plan:

  Type: A | Name: admin       | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: svartberget | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: abisko      | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: lonnstorp   | Content: 192.0.2.1 | Proxied: Yes
  ... (one per station)

❯ give me all the normalized names of the stations for the Type A records   
  to be produced                                                            

● Here are all station subdomains for the A records:

  # Primary station names (recommended)
  Type: A | Name: admin       | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: abisko      | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: asa         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: bolmen      | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: erken       | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: grimso      | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: lonnstorp   | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: robacksdalen| Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: skogaryd    | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: svartberget | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: alnarp      | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: hyltemossa  | Content: 192.0.2.1 | Proxied: Yes

  # Short acronyms (optional aliases)
  Type: A | Name: ans         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: gri         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: lon         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: rob         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: sko         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: svb         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: aln         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: hyl         | Content: 192.0.2.1 | Proxied: Yes

  Summary: 21 total records (1 admin + 12 primary stations + 8 acronym aliases)

  Or if you just want the essentials (admin + primary names only): 13 records
 ▐▛███▜▌   Claude Code v2.1.17
▝▜█████▛▘  Opus 4.5 · Claude Max
  ▘▘ ▝▝    /…/Spectral/apps/sites-spectral-manager/apps/webapp-instruments

❯ Implement the following plan:                                             
                                                                            
  # SITES Spectral Subdomain Architecture with Cloudflare Access            
                                                                            
  > **Architecture Credit**: This subdomain-based architecture design is    
  based on architectural knowledge shared by **Flights for Biodiversity     
  Sweden AB** (https://github.com/flightsforbiodiversity). All architecture 
  documentation files must include this credit attribution.                 
                                                                            
  ---                                                                       
                                                                            
  ## Executive Summary                                                      
                                                                            
  Migration from single-domain (`sitesspectral.work`) to subdomain-based    
  architecture with Cloudflare Access authentication.                       
                                                                            
  | Current State | Target State |                                          
  |---------------|--------------|                                          
  | Single domain, all features | `sitesspectral.work` - Public only |      
  | Database password auth | `admin.sitesspectral.work` - Global admins (CF 
  Access) |                                                                 
  | 5 roles mixed | `{station}.sitesspectral.work` - Station portals (CF    
  Access) |                                                                 
                                                                            
  ---                                                                       
                                                                            
  ## 1. Architecture Decision: Single Worker with Subdomain Routing         
                                                                            
  **Rationale**: Single Worker avoids code duplication, simplifies          
  deployment, and maintains single D1 binding.                              
                                                                            
  The Worker detects subdomain from `Host` header and routes accordingly:   
  - `sitesspectral.work` → Public dashboard (no auth)                       
  - `admin.sitesspectral.work` → Admin portal (CF Access required)          
  - `{station}.sitesspectral.work` → Station portal (CF Access required)    
                                                                            
  ---                                                                       
                                                                            
  ## 2. User Model                                                          
                                                                            
  | User Type | Authentication | Access |                                   
  |-----------|----------------|--------|                                   
  | **Global Admins** | CF Access passwordless (jose.beltran@mgeo.lu.se,    
  lars.eklundh@nateko.lu.se) | Full system access |                         
  | **Station Admins** | CF Access passwordless by email | Their station    
  only |                                                                    
  | **UAV Pilots** | CF Access by email (per station) | Mission/flight      
  logging |                                                                 
  | **Station Internal** | Magic links (generated by admins) | Read-only    
  station view |                                                            
  | **Public** | None | Public metrics only |                               
                                                                            
  ---                                                                       
                                                                            
  ## 3. Implementation Phases                                               
                                                                            
  ### Phase 1: Cloudflare Configuration (Day 1-2)                           
                                                                            
  1. **DNS Configuration**                                                  
  - Add wildcard CNAME: `* →                                                
  sites-spectral-instruments.jose-beltran.workers.dev`                      
  - Add admin CNAME: `admin →                                               
  sites-spectral-instruments.jose-beltran.workers.dev`                      
                                                                            
  2. **Update wrangler.toml**                                               
  ```toml                                                                   
  [[routes]]                                                                
  pattern = "*.sitesspectral.work/*"                                        
  zone_id = "98a6b8637a4cc674eea24819d8f72b07"                              
                                                                            
  [[routes]]                                                                
  pattern = "*.sitesspectral.work"                                          
  zone_id = "98a6b8637a4cc674eea24819d8f72b07"                              
  ```                                                                       
                                                                            
  3. **Create CF Access Applications**                                      
  - Admin Portal: `admin.sitesspectral.work` (emails: josé, lars)           
  - Station Wildcard: `*.sitesspectral.work` (station admin emails +        
  pilot groups)                                                             
                                                                            
  ### Phase 2: Backend Auth (Day 3-5)                                       
                                                                            
  1. **Create `src/infrastructure/auth/CloudflareAccessAdapter.js`**        
  - Verify CF Access JWT from `Cf-Access-Jwt-Assertion` header              
  - Use jose library's `createRemoteJWKSet` for key rotation                
  - Map CF Access email to user role                                        
                                                                            
  2. **Update `src/auth/authentication.js`**                                
  - Add dual-auth: CF Access JWT (primary) + legacy httpOnly cookie         
  (fallback)                                                                
  - Modify `getUserFromRequest()` to check CF Access first                  
                                                                            
  3. **Database Migration `0045_subdomain_auth_uav_missions.sql`**          
  - Add `auth_provider`, `cf_access_email` columns to users                 
  - Create `magic_link_tokens` table                                        
  - Create UAV tables: `uav_pilots`, `uav_missions`, `mission_pilots`,      
  `uav_flight_logs`, `uav_batteries`                                        
                                                                            
  ### Phase 3: Subdomain Routing (Day 6-8)                                  
                                                                            
  1. **Update `src/worker.js`**                                             
  ```javascript                                                             
  function getSubdomain(request) {                                          
  const host = request.headers.get('Host') || '';                           
  const parts = host.split('.');                                            
  if (parts.length === 3 && parts[1] === 'sitesspectral') {                 
  return parts[0];                                                          
  }                                                                         
  return null;                                                              
  }                                                                         
  ```                                                                       
                                                                            
  2. **Create portal handlers**                                             
  - `handlePublicDashboard()` - No auth, public metrics                     
  - `handleAdminPortal()` - CF Access required, full admin                  
  - `handleStationPortal()` - CF Access required, station-scoped            
                                                                            
  3. **Update CORS for subdomains**                                         
  - Add all station subdomains to allowed origins                           
  - Add dynamic subdomain pattern matching                                  
                                                                            
  ### Phase 4: Magic Links (Day 9-10)                                       
                                                                            
  1. **Create `src/handlers/magic-links.js`**                               
  - `POST /api/v11/magic-links/create` - Station admin creates link         
  - `GET /api/v11/magic-links/validate` - Validate token, issue session     
  - `POST /api/v11/magic-links/revoke` - Revoke token                       
                                                                            
  2. **Token specification**                                                
  - 256-bit cryptographic token                                             
  - 7-day default expiry                                                    
  - Single-use optional                                                     
  - Station-scoped                                                          
                                                                            
  ### Phase 5: Public Dashboard (Day 11-12)                                 
                                                                            
  1. **Create `public/public-dashboard.html`**                              
  - Station map (Leaflet)                                                   
  - Station status indicators                                               
  - Platform/instrument counts                                              
  - No authentication required                                              
                                                                            
  2. **Create public API endpoints**                                        
  - `GET /api/public/stations` - Station list with status                   
  - `GET /api/public/health` - System health metrics                        
                                                                            
  ### Phase 6: UAV Pilot Features (Day 13-15)                               
                                                                            
  1. **Create domain entities**                                             
  - `src/domain/uav/Pilot.js`                                               
  - `src/domain/uav/Mission.js`                                             
  - `src/domain/uav/FlightLog.js`                                           
                                                                            
  2. **Create repositories and controllers**                                
  - Pilot registration                                                      
  - Mission planning/logging                                                
  - Flight log entry                                                        
  - Battery tracking                                                        
                                                                            
  ---                                                                       
                                                                            
  ## 4. Critical Files to Modify                                            
                                                                            
  | File | Changes |                                                        
  |------|---------|                                                        
  | `src/worker.js` | Subdomain detection and routing |                     
  | `src/auth/authentication.js` | CF Access JWT verification |             
  | `src/domain/authorization/Role.js` | Add `uav-pilot` role |             
  | `wrangler.toml` | Wildcard subdomain routes |                           
  | `src/config/allowed-origins.js` | Subdomain CORS |                      
  | `public/index.html` | Redirect to public dashboard |                    
                                                                            
  ## 5. New Files to Create                                                 
                                                                            
  | File | Purpose |                                                        
  |------|---------|                                                        
  | `src/infrastructure/auth/CloudflareAccessAdapter.js` | CF Access JWT    
  verification |                                                            
  | `src/handlers/magic-links.js` | Magic link CRUD |                       
  | `src/handlers/public.js` | Public API endpoints |                       
  | `src/domain/uav/Pilot.js` | UAV pilot entity |                          
  | `src/domain/uav/Mission.js` | Mission entity |                          
  | `migrations/0045_subdomain_auth_uav_missions.sql` | Schema changes |    
  | `public/public-dashboard.html` | Public dashboard |                     
  | `docs/architecture/SUBDOMAIN_ARCHITECTURE.md` | Architecture docs (with 
  FBS credit) |                                                             
                                                                            
  ---                                                                       
                                                                            
  ## 6. Credit Attribution                                                  
                                                                            
  All new architecture documentation files must include:                    
                                                                            
  ```markdown                                                               
  > **Architecture Credit**: This subdomain-based architecture design is    
  based on                                                                  
  > architectural knowledge shared by **Flights for Biodiversity Sweden     
  AB**                                                                      
  > (https://github.com/flightsforbiodiversity).                            
  ```                                                                       
                                                                            
  Files requiring this credit:                                              
  - `docs/architecture/SUBDOMAIN_ARCHITECTURE.md`                           
  - `docs/security/CLOUDFLARE_ACCESS_INTEGRATION.md`                        
  - `docs/MAGIC_LINK_SYSTEM.md`                                             
  - `docs/UAV_PILOT_SYSTEM.md`                                              
                                                                            
  ---                                                                       
                                                                            
  ## 7. Verification                                                        
                                                                            
  ### Manual Testing                                                        
  1. Visit `sitesspectral.work` - Should show public dashboard without      
  login                                                                     
  2. Visit `admin.sitesspectral.work` - Should trigger CF Access OTP        
  3. Visit `svartberget.sitesspectral.work` - Should require station-level  
  auth                                                                      
  4. Create magic link as station admin - Verify email delivery             
  5. Use magic link - Verify read-only access                               
                                                                            
  ### Automated Tests                                                       
  ```bash                                                                   
  npm run test:unit    # Unit tests for CF Access adapter                   
  npm run test:integration  # Subdomain routing tests                       
  ```                                                                       
                                                                            
  ---                                                                       
                                                                            
  ## 8. Rollback Plan                                                       
                                                                            
  If issues arise:                                                          
  1. Revert wrangler.toml routes to single domain                           
  2. Disable CF Access applications                                         
  3. Re-enable legacy password authentication                               
  4. DNS changes can remain (no impact without Access policies)             
                                                                            
  ---                                                                       
                                                                            
  ## Timeline Estimate                                                      
                                                                            
  | Phase | Duration | Deliverable |                                        
  |-------|----------|-------------|                                        
  | Phase 1: CF Config | 2 days | DNS + Access apps configured |            
  | Phase 2: Backend Auth | 3 days | CF Access JWT working |                
  | Phase 3: Routing | 3 days | Subdomains functional |                     
  | Phase 4: Magic Links | 2 days | Token system working |                  
  | Phase 5: Public Dashboard | 2 days | Public view deployed |             
  | Phase 6: UAV Features | 3 days | Pilot/mission system |                 
  | **Total** | **~15 days** | Full implementation |                        
                                                                            
                                                                            
  If you need specific details from before exiting plan mode (like exact    
  code snippets, error messages, or content you generated), read the full   
  transcript at: /home/jobelund/.claude/projects/-lunarc-nobackup-projects- 
  sitesspec-SITES-Spectral-apps-sites-spectral-manager-apps-webapp-instrume 
  nts/9a0056c6-fe1b-40e8-aeff-d0c23f348b1c.jsonl                            

● I'll implement this subdomain architecture plan. Let me start by exploring the
   current codebase structure to understand the existing implementation, then
  proceed with each phase.

● Search(pattern: "**/*.{js,toml,sql}", path: "/lunarc/nobackup/projects/sitessp
        ec/SITES/Spectral/apps/sites-spectral-manager/apps/webapp-instruments")
  ⎿  Found 100 files (ctrl+o to expand)

● Read(wrangler.toml)
  ⎿  Read 49 lines

● Read(package.json)
  ⎿  Read 68 lines

● Read(src/worker.js)
  ⎿  Read 120 lines

● Search(pattern: "src/auth/**/*.js", path: "/lunarc/nobackup/projects/sitesspec
        /SITES/Spectral/apps/sites-spectral-manager/apps/webapp-instruments")
  ⎿  Found 4 files (ctrl+o to expand)

● Search(pattern: "src/domain/**/*.js", path: "/lunarc/nobackup/projects/sitessp
        ec/SITES/Spectral/apps/sites-spectral-manager/apps/webapp-instruments")
  ⎿  Found 81 files (ctrl+o to expand)

● Read(src/auth/authentication.js)
  ⎿  Read 444 lines

● Read(src/domain/authorization/Role.js)
  ⎿  Read 112 lines

● Read(src/cors.js)
  ⎿  Read 66 lines

● Read(src/config/allowed-origins.js)
  ⎿  Read 47 lines

● Read(src/api-handler.js)
  ⎿  Read 276 lines

● Search(pattern: "migrations/*.sql", path: "/lunarc/nobackup/projects/sitesspec
        /SITES/Spectral/apps/sites-spectral-manager/apps/webapp-instruments")
  ⎿  Found 14 files (ctrl+o to expand)

● Now I have a good understanding of the codebase. Let me create tasks to track
  progress and implement this systematically.
✔ Task #1 created: Create database migration for subdomain auth and UAV
✔ Task #2 created: Create Cloudflare Access adapter
✔ Task #3 created: Update worker.js for subdomain routing
✔ Task #4 created: Update CORS for subdomains
✔ Task #5 created: Update wrangler.toml for wildcard routes
✔ Task #6 created: Add UAV pilot role to Role.js
✔ Task #7 created: Create magic links handler
✔ Task #8 created: Create public API endpoints
✔ Task #9 created: Create UAV domain entities
✔ Task #10 created: Create architecture documentation
✔ Task #11 created: Update authentication.js for dual-auth

❯ /rename refactor-auth-logic-stations-subdomains 
✔ Task #1 updated: status → in progress

● Write(migrations/0045_subdomain_auth_uav_missions.sql)
  ⎿  Wrote 406 lines to migrations/0045_subdomain_auth_uav_missions.sql
       1 -- Migration: 0045_subdomain_auth_uav_missions.sql
       2 -- SITES Spectral v15.0.0 - Subdomain Architecture with Cloudfla
         re Access
       3 --
       4 -- This migration adds support for:
       5 -- 1. Cloudflare Access authentication (passwordless via email O
         TP)
       6 -- 2. Magic link tokens for station internal users
       7 -- 3. UAV pilot registration and mission tracking
       8 -- 4. Flight logs and battery tracking
       9 --
      10 -- Architecture Credit: This subdomain-based architecture design
          is based on
     … +396 lines (ctrl+o to expand)
✔ Task #1 updated: status → completed
✔ Task #2 updated: status → in progress

● Bash(mkdir -p /lunarc/nobackup/projects/sitesspec/SITES/Spectral/apps/sites-sp
      ectral-manager/apps/webapp-instruments/src/infrastructure/auth)
  ⎿  (No content)

● Write(src/infrastructure/auth/CloudflareAccessAdapter.js)
  ⎿  Wrote 452 lines to src/infrastructure/auth/CloudflareAccessAdapter.js
       1 /**
       2  * Cloudflare Access Adapter
       3  * Verifies Cloudflare Access JWT tokens for passwordless authen
         tication
       4  *
       5  * Architecture Credit: This subdomain-based architecture design
          is based on
       6  * architectural knowledge shared by Flights for Biodiversity Sw
         eden AB
       7  * (https://github.com/flightsforbiodiversity)
       8  *
       9  * @module infrastructure/auth/CloudflareAccessAdapter
      10  * @version 15.0.0
     … +442 lines (ctrl+o to expand)

● Write(src/infrastructure/auth/index.js)
  ⎿  Wrote 9 lines to src/infrastructure/auth/index.js
      1 /**
      2  * Infrastructure Auth Module Exports
      3  *
      4  * @module infrastructure/auth
      5  * @version 15.0.0
      6  */
      7 export { CloudflareAccessAdapter } from './CloudflareAccessAdapte
        r.js';
✔ Task #2 updated: status → completed
✔ Task #3 updated: status → in progress

● Read(src/worker.js)
  ⎿  Read 120 lines

● Write(src/worker.js)
  ⎿  Added 251 lines, removed 39 lines
        1 -// SITES Spectral Stations & Instruments - Main Worker v11.0.0
        2 -// Hexagonal Architecture with Cloudflare Workers + API Versio
          -n Aliases                                                     
        3 -// Handles both static assets and API routes                  
        1 +// SITES Spectral Stations & Instruments - Main Worker v15.0.0
        2 +// Hexagonal Architecture with Cloudflare Workers + Subdomain 
          +Routing                                                       
        3 +// Handles both static assets and API routes with Cloudflare A
          +ccess authentication                                          
        4 +//                                                            
        5 +// Architecture Credit: This subdomain-based architecture desi
          +gn is based on                                                
        6 +// architectural knowledge shared by Flights for Biodiversity 
          +Sweden AB                                                     
        7 +// (https://github.com/flightsforbiodiversity)                
        8  
        9  import { createCors, validateCorsOrigin, createCorsErrorRespon
           se } from './cors';
       10  import { handleApiRequest } from './api-handler';
       11 +import { CloudflareAccessAdapter } from './infrastructure/auth
          +/CloudflareAccessAdapter.js';                                 
       12  
       13 +/**                                                           
       14 + * Get subdomain from Host header                             
       15 + *                                                            
       16 + * @param {Request} request - Incoming request                
       17 + * @returns {string|null} Subdomain or null for root domain   
       18 + */                                                           
       19 +function getSubdomain(request) {                              
       20 +  const host = request.headers.get('Host') || '';             
       21 +  const parts = host.split('.');                              
       22 +                                                              
       23 +  // Expected formats:                                        
       24 +  // - sitesspectral.work (root domain)                       
       25 +  // - admin.sitesspectral.work (admin subdomain)             
       26 +  // - svartberget.sitesspectral.work (station subdomain)     
       27 +  if (parts.length === 3 && parts[1] === 'sitesspectral' && pa
          +rts[2] === 'work') {                                          
       28 +    return parts[0];                                          
       29 +  }                                                           
       30 +                                                              
       31 +  // For Workers dev URL, use X-Subdomain header (testing) or 
          +query param                                                   
       32 +  if (host.includes('workers.dev')) {                         
       33 +    const subdomainHeader = request.headers.get('X-Subdomain')
          +;                                                             
       34 +    if (subdomainHeader) {                                    
       35 +      return subdomainHeader;                                 
       36 +    }                                                         
       37 +                                                              
       38 +    // Check query param for testing                          
       39 +    const url = new URL(request.url);                         
       40 +    const subdomainParam = url.searchParams.get('subdomain'); 
       41 +    if (subdomainParam) {                                     
       42 +      return subdomainParam;                                  
       43 +    }                                                         
       44 +  }                                                           
       45 +                                                              
       46 +  return null;                                                
       47 +}                                                             
       48 +                                                              
       49 +/**                                                           
       50 + * Determine portal type from subdomain                       
       51 + *                                                            
       52 + * @param {string|null} subdomain - Subdomain from request    
       53 + * @returns {'public'|'admin'|'station'} Portal type          
       54 + */                                                           
       55 +function getPortalType(subdomain) {                           
       56 +  if (!subdomain || subdomain === 'www') {                    
       57 +    return 'public';                                          
       58 +  }                                                           
       59 +                                                              
       60 +  if (subdomain === 'admin') {                                
       61 +    return 'admin';                                           
       62 +  }                                                           
       63 +                                                              
       64 +  // Any other subdomain is treated as a station portal       
       65 +  return 'station';                                           
       66 +}                                                             
       67 +                                                              
       68 +/**                                                           
       69 + * Create unauthorized response for portal access             
       70 + *                                                            
       71 + * @param {string} portalType - Portal type                   
       72 + * @param {string|null} subdomain - Subdomain                 
       73 + * @returns {Response}                                        
       74 + */                                                           
       75 +function createPortalUnauthorizedResponse(portalType, subdomai
          +n) {                                                          
       76 +  if (portalType === 'admin') {                               
       77 +    return new Response(JSON.stringify({                      
       78 +      error: 'Unauthorized',                                  
       79 +      message: 'Admin portal requires Cloudflare Access authen
          +tication',                                                    
       80 +      portal: 'admin',                                        
       81 +      hint: 'Please authenticate via Cloudflare Access'       
       82 +    }), {                                                     
       83 +      status: 401,                                            
       84 +      headers: { 'Content-Type': 'application/json' }         
       85 +    });                                                       
       86 +  }                                                           
       87 +                                                              
       88 +  if (portalType === 'station') {                             
       89 +    return new Response(JSON.stringify({                      
       90 +      error: 'Unauthorized',                                  
       91 +      message: `Station portal (${subdomain}) requires authent
          +ication`,                                                     
       92 +      portal: 'station',                                      
       93 +      station: subdomain,                                     
       94 +      hint: 'Please authenticate via Cloudflare Access or magi
          +c link'                                                       
       95 +    }), {                                                     
       96 +      status: 401,                                            
       97 +      headers: { 'Content-Type': 'application/json' }         
       98 +    });                                                       
       99 +  }                                                           
      100 +                                                              
      101 +  return new Response('Unauthorized', { status: 401 });       
      102 +}                                                             
      103 +                                                              
      104 +/**                                                           
      105 + * Create forbidden response for portal access                
      106 + *                                                            
      107 + * @param {string} portalType - Portal type                   
      108 + * @param {string|null} subdomain - Subdomain                 
      109 + * @param {Object} user - Authenticated user                  
      110 + * @returns {Response}                                        
      111 + */                                                           
      112 +function createPortalForbiddenResponse(portalType, subdomain, 
          +user) {                                                       
      113 +  return new Response(JSON.stringify({                        
      114 +    error: 'Forbidden',                                       
      115 +    message: `You do not have access to this ${portalType} por
          +tal`,                                                         
      116 +    portal: portalType,                                       
      117 +    station: subdomain,                                       
      118 +    user_role: user?.role,                                    
      119 +    user_station: user?.station_acronym                       
      120 +  }), {                                                       
      121 +    status: 403,                                              
      122 +    headers: { 'Content-Type': 'application/json' }           
      123 +  });                                                         
      124 +}                                                             
      125 +                                                              
      126  export default {
      127    async fetch(request, env, ctx) {
      128      const url = new URL(request.url);
       11 -    // Pass request to createCors for proper origin validation
          - (security fix v12.0.3)                                       
      129 +    const subdomain = getSubdomain(request);                  
      130 +    const portalType = getPortalType(subdomain);              
      131 +                                                              
      132 +    // Pass request to createCors for proper origin validation
      133      const { corsHeaders, handleCors } = createCors(request);
      134  
      135      // HTTPS Enforcement - Redirect HTTP to HTTPS
       15 -    // Note: Cloudflare typically handles this at edge, but we
          - ensure it here                                               
      136      if (url.protocol === 'http:' && !url.hostname.includes('lo
           calhost') && !url.hostname.includes('127.0.0.1')) {
      137        const httpsUrl = new URL(request.url);
      138        httpsUrl.protocol = 'https:';
     ...
      145      }
      146  
      147      try {
       28 -      // API Routes                                           
       29 -      if (url.pathname.startsWith('/api/')) {                 
       30 -        const response = await handleApiRequest(request, env, 
          -ctx);                                                         
       31 -                                                              
       32 -        // Add CORS headers to API responses                  
       33 -        Object.entries(corsHeaders).forEach(([key, value]) => 
          -{                                                             
       34 -          response.headers.set(key, value);                   
       35 -        });                                                   
       36 -                                                              
       37 -        return response;                                      
      148 +      // === PUBLIC PORTAL ===                                
      149 +      // No authentication required for public portal         
      150 +      if (portalType === 'public') {                          
      151 +        // API Routes for public portal                       
      152 +        if (url.pathname.startsWith('/api/')) {               
      153 +          // Public API endpoints don't require auth          
      154 +          // But standard API endpoints will check auth as usu
          +al                                                            
      155 +          const response = await handleApiRequest(request, env
          +, ctx);                                                       
      156 +                                                              
      157 +          Object.entries(corsHeaders).forEach(([key, value]) =
          +> {                                                           
      158 +            response.headers.set(key, value);                 
      159 +          });                                                 
      160 +                                                              
      161 +          return response;                                    
      162 +        }                                                     
      163 +                                                              
      164 +        // Static Asset Serving for public portal             
      165 +        return await handleStaticAssets(request, env, corsHead
          +ers, portalType);                                             
      166        }
      167  
       40 -      // Static Asset Serving                                 
       41 -      return await handleStaticAssets(request, env, corsHeader
          -s);                                                           
       42 -                                                              
      168 +      // === ADMIN and STATION PORTALS ===                    
      169 +      // Require Cloudflare Access authentication             
      170 +                                                              
      171 +      // Try to get user from CF Access JWT                   
      172 +      const cfAdapter = new CloudflareAccessAdapter(env);     
      173 +      let user = await cfAdapter.verifyAccessToken(request);  
      174 +                                                              
      175 +      // If no CF Access token, API endpoints may still use le
          +gacy auth                                                     
      176 +      // This is handled in handleApiRequest via getUserFromRe
          +quest                                                         
      177 +                                                              
      178 +      // For static assets on protected portals, require CF Ac
          +cess                                                          
      179 +      if (!url.pathname.startsWith('/api/')) {                
      180 +        if (!user) {                                          
      181 +          // No CF Access token - redirect to CF Access login 
      182 +          // Cloudflare Access handles this automatically via 
          +the WAF rules                                                 
      183 +          // If we reach here, it means CF Access is not confi
          +gured or bypassed                                             
      184 +          return createPortalUnauthorizedResponse(portalType, 
          +subdomain);                                                   
      185 +        }                                                     
      186 +                                                              
      187 +        // Check if user can access this portal               
      188 +        const canAccess = CloudflareAccessAdapter.canAccessPor
          +tal(user, portalType, subdomain);                             
      189 +        if (!canAccess) {                                     
      190 +          return createPortalForbiddenResponse(portalType, sub
          +domain, user);                                                
      191 +        }                                                     
      192 +                                                              
      193 +        // Serve static assets for authenticated portal       
      194 +        return await handleStaticAssets(request, env, corsHead
          +ers, portalType, subdomain, user);                            
      195 +      }                                                       
      196 +                                                              
      197 +      // === API ROUTES ===                                   
      198 +      // Add subdomain and portal context to request for downs
          +tream handlers                                                
      199 +      request.subdomain = subdomain;                          
      200 +      request.portalType = portalType;                        
      201 +      request.cfAccessUser = user;                            
      202 +                                                              
      203 +      const response = await handleApiRequest(request, env, ct
          +x);                                                           
      204 +                                                              
      205 +      // Add CORS headers to API responses                    
      206 +      Object.entries(corsHeaders).forEach(([key, value]) => { 
      207 +        response.headers.set(key, value);                     
      208 +      });                                                     
      209 +                                                              
      210 +      // Add portal context headers                           
      211 +      response.headers.set('X-Portal-Type', portalType);      
      212 +      if (subdomain) {                                        
      213 +        response.headers.set('X-Subdomain', subdomain);       
      214 +      }                                                       
      215 +                                                              
      216 +      return response;                                        
      217 +                                                              
      218      } catch (error) {
      219        console.error('Worker error:', error);
       45 -      return new Response(JSON.stringify({                    
      220 +      return new Response(JSON.stringify({                    
      221          error: 'Internal server error',
       47 -        message: error.message                                
      222 +        message: error.message                                
      223        }), {
      224          status: 500,
      225          headers: {
     ...
      231    }
      232  };
      233  
       59 -async function handleStaticAssets(request, env, corsHeaders) {
      234 +/**                                                           
      235 + * Handle static asset serving                                
      236 + *                                                            
      237 + * @param {Request} request - Incoming request                
      238 + * @param {Object} env - Cloudflare Worker environment        
      239 + * @param {Object} corsHeaders - CORS headers                 
      240 + * @param {string} portalType - Portal type                   
      241 + * @param {string|null} subdomain - Subdomain                 
      242 + * @param {Object|null} user - Authenticated user             
      243 + * @returns {Promise<Response>}                               
      244 + */                                                           
      245 +async function handleStaticAssets(request, env, corsHeaders, p
          +ortalType = 'public', subdomain = null, user = null) {        
      246    const url = new URL(request.url);
       61 -                                                              
       62 -  // Default to index.html for SPA routing                    
      247 +                                                              
      248 +  // Portal-specific asset paths                              
      249 +  const portalAssetMappings = {                               
      250 +    public: {                                                 
      251 +      '/': '/public-dashboard.html',                          
      252 +      default: '/public-dashboard.html'                       
      253 +    },                                                        
      254 +    admin: {                                                  
      255 +      '/': '/sites-dashboard.html',                           
      256 +      default: '/sites-dashboard.html'                        
      257 +    },                                                        
      258 +    station: {                                                
      259 +      '/': '/station-dashboard.html',                         
      260 +      default: '/station-dashboard.html'                      
      261 +    }                                                         
      262 +  };                                                          
      263 +                                                              
      264 +  // Known HTML pages                                         
      265    const assetPaths = [
      266      '/stations.html',
      267      '/instruments.html',
      268      '/export.html',
      269      '/station-dashboard.html',
      270      '/sites-dashboard.html',
       69 -    '/instrument.html'                                        
      271 +    '/public-dashboard.html',                                 
      272 +    '/instrument.html',                                       
      273 +    '/login.html',                                            
      274 +    '/admin.html'                                             
      275    ];
       71 -                                                              
      276 +                                                              
      277    let assetPath = url.pathname;
       73 -                                                              
       74 -  // Handle SPA routing - serve index.html for app routes     
      278 +                                                              
      279 +  // Handle SPA routing - determine default page based on port
          +al type                                                       
      280    if (assetPaths.some(path => url.pathname.startsWith(path.rep
           lace('.html', '')))) {
      281      assetPath = url.pathname + '.html';
      282    } else if (url.pathname === '/') {
       78 -    assetPath = '/index.html';                                
      283 +    // Use portal-specific default page                       
      284 +    const portalMapping = portalAssetMappings[portalType] || p
          +ortalAssetMappings.public;                                    
      285 +    assetPath = portalMapping['/'] || '/index.html';          
      286    }
       80 -                                                              
      287 +                                                              
      288    // Try to get the asset from the static assets binding
      289    try {
      290      const asset = await env.ASSETS.fetch(new URL(assetPath, re
           quest.url).toString());
       84 -                                                              
      291 +                                                              
      292      if (asset.status === 404) {
       86 -      // For unmatched routes, serve index.html (SPA fallback)
       87 -      const indexAsset = await env.ASSETS.fetch(new URL('/inde
          -x.html', request.url).toString());                            
       88 -      if (indexAsset.ok) {                                    
       89 -        const response = new Response(indexAsset.body, {      
      293 +      // For unmatched routes, serve portal-specific fallback 
      294 +      const portalMapping = portalAssetMappings[portalType] ||
          + portalAssetMappings.public;                                  
      295 +      const fallbackPath = portalMapping.default || '/index.ht
          +ml';                                                          
      296 +      const fallbackAsset = await env.ASSETS.fetch(new URL(fal
          +lbackPath, request.url).toString());                          
      297 +                                                              
      298 +      if (fallbackAsset.ok) {                                 
      299 +        const response = new Response(fallbackAsset.body, {   
      300            status: 200,
      301            headers: {
      302              'Content-Type': 'text/html',
      303 +            'X-Portal-Type': portalType,                      
      304              ...corsHeaders
      305            }
      306          });
      307          return response;
      308        }
      309      }
       99 -                                                              
      310 +                                                              
      311      if (asset.ok) {
      312        const response = new Response(asset.body, {
      313          status: asset.status,
      314          headers: {
      315            ...asset.headers,
      316 +          'X-Portal-Type': portalType,                        
      317            ...corsHeaders
      318          }
      319        });
      320        return response;
      321      }
      110 -                                                              
      322 +                                                              
      323    } catch (error) {
      324      console.error('Static asset error:', error);
      325    }
      114 -                                                              
      326 +                                                              
      327    // 404 fallback
      116 -  return new Response('Not Found', {                          
      328 +  return new Response('Not Found', {                          
      329      status: 404,
      330      headers: corsHeaders
      331    });
      120 -}                                                             
      332   No newline at end of file
      333 +}                                                             
✔ Task #3 updated: status → completed
✔ Task #4 updated: status → in progress
✔ Task #5 updated: status → in progress

● Write(src/config/allowed-origins.js)
  ⎿  Added 118 lines, removed 3 lines
       1  // Allowed origins for CORS
       2  // Only these origins can make cross-origin requests to the API
       3 +//                                                             
       4 +// v15.0.0: Added subdomain support for station portals        
       5 +//                                                             
       6 +// Architecture Credit: This subdomain-based architecture desig
         +n is based on                                                  
       7 +// architectural knowledge shared by Flights for Biodiversity S
         +weden AB                                                       
       8 +// (https://github.com/flightsforbiodiversity)                 
       9  
      10 +/**                                                            
      11 + * Static list of explicitly allowed origins                   
      12 + * Includes production domains, dev URLs, and local development
      13 + */                                                            
      14  export const ALLOWED_ORIGINS = [
       5 -  // Production - MGeo/Lund University account                 
      15 +  // Production - Root domain (public portal)                  
      16    'https://sitesspectral.work',
      17  
      18 +  // Production - Admin portal                                 
      19 +  'https://admin.sitesspectral.work',                          
      20 +                                                               
      21    // Production - Legacy jobelab account
      22    'https://sites.jobelab.com',
      23  
     ...
      33  ];
      34  
      35  /**
      36 + * Station acronyms for dynamic subdomain matching             
      37 + * These are used to generate allowed origins for station porta
         +ls                                                             
      38 + */                                                            
      39 +const STATION_ACRONYMS = [                                     
      40 +  'abisko',                                                    
      41 +  'ans',        // Abisko alternate                            
      42 +  'asa',                                                       
      43 +  'bolmen',                                                    
      44 +  'erken',                                                     
      45 +  'grimso',                                                    
      46 +  'gri',        // Grimso alternate                            
      47 +  'lonnstorp',                                                 
      48 +  'lon',        // Lonnstorp alternate                         
      49 +  'robacksdalen',                                              
      50 +  'rob',        // Robacksdalen alternate                      
      51 +  'skogaryd',                                                  
      52 +  'sko',        // Skogaryd alternate                          
      53 +  'svartberget',                                               
      54 +  'svb',        // Svartberget alternate                       
      55 +  // New stations (v14.1.0)                                    
      56 +  'alnarp',                                                    
      57 +  'aln',        // Alnarp alternate                            
      58 +  'hyltemossa',                                                
      59 +  'hyl',        // Hyltemossa alternate                        
      60 +];                                                             
      61 +                                                               
      62 +/**                                                            
      63 + * Generate dynamic station portal origins                     
      64 + *                                                             
      65 + * @returns {string[]} Array of station portal origins         
      66 + */                                                            
      67 +function generateStationOrigins() {                            
      68 +  return STATION_ACRONYMS.map(acronym =>                       
      69 +    `https://${acronym}.sitesspectral.work`                    
      70 +  );                                                           
      71 +}                                                              
      72 +                                                               
      73 +/**                                                            
      74 + * All allowed origins including dynamically generated station 
         +portals                                                        
      75 + */                                                            
      76 +const ALL_ALLOWED_ORIGINS = [                                  
      77 +  ...ALLOWED_ORIGINS,                                          
      78 +  ...generateStationOrigins()                                  
      79 +];                                                             
      80 +                                                               
      81 +/**                                                            
      82   * Check if an origin is allowed for CORS
      83 + * Supports both static list and dynamic subdomain patterns    
      84 + *                                                             
      85   * @param {string|null} origin - The origin header from the req
          uest
      86   * @returns {boolean} - True if origin is allowed
      87   */
     ...
       90      // No origin header - could be same-origin request or serv
           er-to-server
       91      return true;
       92    }
       32 -  return ALLOWED_ORIGINS.includes(origin);                    
       93 +                                                              
       94 +  // Check static list first                                  
       95 +  if (ALL_ALLOWED_ORIGINS.includes(origin)) {                 
       96 +    return true;                                              
       97 +  }                                                           
       98 +                                                              
       99 +  // Check dynamic subdomain pattern for sitesspectral.work   
      100 +  try {                                                       
      101 +    const url = new URL(origin);                              
      102 +    const host = url.hostname;                                
      103 +                                                              
      104 +    // Allow any subdomain of sitesspectral.work              
      105 +    if (host.endsWith('.sitesspectral.work')) {               
      106 +      // Extract subdomain                                    
      107 +      const subdomain = host.replace('.sitesspectral.work', ''
          +);                                                            
      108 +                                                              
      109 +      // Validate subdomain format (alphanumeric and hyphens o
          +nly)                                                          
      110 +      if (/^[a-z0-9-]+$/.test(subdomain)) {                   
      111 +        return true;                                          
      112 +      }                                                       
      113 +    }                                                         
      114 +                                                              
      115 +    // Allow workers.dev subdomains for development           
      116 +    if (host.endsWith('.workers.dev')) {                      
      117 +      return true;                                            
      118 +    }                                                         
      119 +                                                              
      120 +  } catch (e) {                                               
      121 +    // Invalid URL, fall through to false                     
      122 +  }                                                           
      123 +                                                              
      124 +  return false;                                               
      125  }
      126  
      127  /**
      128   * Get the appropriate Access-Control-Allow-Origin value
      129 + *                                                            
      130   * @param {string|null} origin - The origin header from the re
           quest
      131   * @returns {string} - The allowed origin or the first allowed
            origin as fallback
      132   */
      133  export function getAllowedOrigin(origin) {
       41 -  if (origin && ALLOWED_ORIGINS.includes(origin)) {           
      134 +  // If origin is allowed, return it (for dynamic origin suppo
          +rt)                                                           
      135 +  if (origin && isAllowedOrigin(origin)) {                    
      136      return origin;
      137    }
      138 +                                                              
      139    // Return first allowed origin as fallback (for error respon
           ses)
      140    return ALLOWED_ORIGINS[0];
      141  }
      142 +                                                              
      143 +/**                                                           
      144 + * Get list of station acronyms for validation                
      145 + *                                                            
      146 + * @returns {string[]} Array of valid station acronyms        
      147 + */                                                           
      148 +export function getStationAcronyms() {                        
      149 +  return [...STATION_ACRONYMS];                               
      150 +}                                                             
      151 +                                                              
      152 +/**                                                           
      153 + * Check if a subdomain corresponds to a valid station        
      154 + *                                                            
      155 + * @param {string} subdomain - Subdomain to check             
      156 + * @returns {boolean} True if subdomain is a valid station    
      157 + */                                                           
      158 +export function isValidStationSubdomain(subdomain) {          
      159 +  if (!subdomain) return false;                               
      160 +  return STATION_ACRONYMS.includes(subdomain.toLowerCase());  
      161 +}                                                             

● Write(wrangler.toml)
  ⎿  Added 74 lines, removed 7 lines
      10  # Enable auto-deployment from GitHub when commits are pushed to
           main branch
      11  
      12  # Project metadata
      13 -# Version: 11.0.0-alpha.33                                     
      14 -# Release: 2025-12-09                                          
      15 -# Database Schema: v12 (36 migrations) - ROI Legacy System + He
         -xagonal Architecture                                           
      13 +# Version: 15.0.0                                              
      14 +# Release: 2026-01-24                                          
      15 +# Database Schema: v15 (45 migrations) - Subdomain Architecture
         + + Cloudflare Access                                           
      16 +#                                                              
      17 +# Architecture Credit: This subdomain-based architecture design
         + is based on                                                   
      18 +# architectural knowledge shared by Flights for Biodiversity Sw
         +eden AB                                                        
      19 +# (https://github.com/flightsforbiodiversity)                  
      20  
      21  # Static Assets Configuration
      22  # v13.14.0: Vanilla JS frontend with design system
     ...
       37  [vars]
       38  ENVIRONMENT = "production"
       39  APP_NAME = "SITES Spectral Stations & Instruments"
       36 -APP_VERSION = "14.2.0"                                        
       40 +APP_VERSION = "15.0.0"                                        
       41  USE_CLOUDFLARE_SECRETS = "true"
       42  
       39 -# Custom domain routing                                       
       40 -# Accessible at: sitesspectral.work                           
       43 +# Cloudflare Access team domain for JWT verification          
       44 +CF_ACCESS_TEAM_DOMAIN = "sitesspectral.cloudflareaccess.com"  
       45 +                                                              
       46 +# ============================================================
          +==================                                            
       47 +# Custom Domain Routing (v15.0.0 - Subdomain Architecture)    
       48 +# ============================================================
          +==================                                            
       49 +#                                                             
       50 +# Portal Architecture:                                        
       51 +# - sitesspectral.work           → Public dashboard (no auth) 
       52 +# - admin.sitesspectral.work     → Admin portal (CF Access req
          +uired)                                                        
       53 +# - {station}.sitesspectral.work → Station portals (CF Access 
          +required)                                                     
       54 +#                                                             
       55 +# Examples:                                                   
       56 +# - svartberget.sitesspectral.work → Svartberget station porta
          +l                                                             
       57 +# - abisko.sitesspectral.work      → Abisko station portal    
       58 +# - lonnstorp.sitesspectral.work   → Lonnstorp station portal 
       59 +#                                                             
       60  # Workers.dev subdomain: sites-spectral-instruments.jose-beltr
           an.workers.dev
       61  
       62 +# Root domain routes                                          
       63  [[routes]]
       64  pattern = "sitesspectral.work/*"
       65  zone_id = "98a6b8637a4cc674eea24819d8f72b07"
       66  
       67  [[routes]]
       68  pattern = "sitesspectral.work"
       49 -zone_id = "98a6b8637a4cc674eea24819d8f72b07"                  
       69   No newline at end of file
       70 +zone_id = "98a6b8637a4cc674eea24819d8f72b07"                  
       71 +                                                              
       72 +# Wildcard subdomain routes (admin, station portals)          
       73 +[[routes]]                                                    
       74 +pattern = "*.sitesspectral.work/*"                            
       75 +zone_id = "98a6b8637a4cc674eea24819d8f72b07"                  
       76 +                                                              
       77 +[[routes]]                                                    
       78 +pattern = "*.sitesspectral.work"                              
       79 +zone_id = "98a6b8637a4cc674eea24819d8f72b07"                  
       80 +                                                              
       81 +# ============================================================
          +==================                                            
       82 +# Environment-specific Configuration                          
       83 +# ============================================================
          +==================                                            
       84 +                                                              
       85 +# Development environment                                     
       86 +[env.development]                                             
       87 +vars = { ENVIRONMENT = "development" }                        
       88 +                                                              
       89 +# Staging environment                                         
       90 +[env.staging]                                                 
       91 +vars = { ENVIRONMENT = "staging" }                            
       92 +                                                              
       93 +# ============================================================
          +==================                                            
       94 +# Notes on DNS Configuration                                  
       95 +# ============================================================
          +==================                                            
       96 +#                                                             
       97 +# Required DNS records (configure in Cloudflare Dashboard):   
       98 +#                                                             
       99 +# Type  | Name      | Target                                  
          +        | Proxied                                             
      100 +# ------|-----------|-----------------------------------------
          +-------|--------                                              
      101 +# CNAME | @         | sites-spectral-instruments.jose-e5f.work
          +ers.dev | Yes                                                 
      102 +# CNAME | admin     | sites-spectral-instruments.jose-e5f.work
          +ers.dev | Yes                                                 
      103 +# CNAME | *         | sites-spectral-instruments.jose-e5f.work
          +ers.dev | Yes                                                 
      104 +#                                                             
      105 +# Note: Wildcard CNAME requires Cloudflare Pro plan or higher 
          +for SSL coverage.                                             
      106 +# Alternative: Create individual CNAME records for each statio
          +n subdomain.                                                  
      107 +#                                                             
      108 +# Required Cloudflare Access Applications:                    
      109 +#                                                             
      110 +# 1. Admin Portal (admin.sitesspectral.work)                  
      111 +#    - Policies: Allow specific email addresses (jose.beltran@
          +mgeo.lu.se, lars.eklundh@nateko.lu.se)                        
      112 +#    - Session duration: 24 hours                             
      113 +#                                                             
      114 +# 2. Station Wildcard (*.sitesspectral.work)                  
      115 +#    - Policies: Allow station admin emails + UAV pilot groups
      116 +#    - Session duration: 24 hours                             
      117 +#    - Bypass rules: Exclude public assets (/api/public/*, /cs
          +s/*, /js/*, etc.)                                             
✔ Task #4 updated: status → completed
✔ Task #5 updated: status → completed
✔ Task #6 updated: status → in progress

● Update(src/domain/authorization/Role.js)
  ⎿  Added 7 lines, removed 1 line
       3   * Represents user's authorization role with type-safe constant
          s
       4   *
       5   * @module domain/authorization/Role
       6 - * @version 11.0.0-alpha.30                                    
       6 + * @version 15.0.0                                             
       7 + *                                                             
       8 + * Architecture Credit: This subdomain-based architecture desig
         +n is based on                                                  
       9 + * architectural knowledge shared by Flights for Biodiversity S
         +weden AB                                                       
      10 + * (https://github.com/flightsforbiodiversity)                 
      11   */
      12  
      13  export class Role {
     ...
      16    static SITES_ADMIN = 'sites-admin';      // New global admin 
          standard
      17    static STATION_ADMIN = 'station-admin';  // Station-specific 
          admin
      18    static STATION_USER = 'station';         // Regular station u
          ser
      19 +  static UAV_PILOT = 'uav-pilot';          // UAV pilot with mi
         +ssion/flight logging                                           
      20 +  static STATION_INTERNAL = 'station-internal'; // Internal rea
         +d-only via magic link                                          
      21    static READONLY = 'readonly';            // Read-only access
      22  
      23    // Global admin usernames (explicit whitelist)

● Update(src/domain/authorization/Role.js)
  ⎿  Added 2 lines
      43        Role.SITES_ADMIN,
      44        Role.STATION_ADMIN,
      45        Role.STATION_USER,
      46 +      Role.UAV_PILOT,                                          
      47 +      Role.STATION_INTERNAL,                                   
      48        Role.READONLY
      49      ];
      50      if (!validRoles.includes(value)) {

● Read(src/domain/authorization/Role.js)
  ⎿  Read 120 lines

● Update(src/domain/authorization/Role.js)
  ⎿  Added 33 lines, removed 1 line
       81     * @returns {boolean}
       82     */
       83    isReadOnly() {
       84 -    return this.value === Role.READONLY;                      
       84 +    return this.value === Role.READONLY || this.value === Role
          +.STATION_INTERNAL;                                            
       85    }
       86  
       87    /**
       88 +   * Check if this role represents a UAV pilot                
       89 +   * @returns {boolean}                                       
       90 +   */                                                         
       91 +  isUAVPilot() {                                              
       92 +    return this.value === Role.UAV_PILOT;                     
       93 +  }                                                           
       94 +                                                              
       95 +  /**                                                         
       96 +   * Check if this role represents a station internal user    
       97 +   * @returns {boolean}                                       
       98 +   */                                                         
       99 +  isStationInternal() {                                       
      100 +    return this.value === Role.STATION_INTERNAL;              
      101 +  }                                                           
      102 +                                                              
      103 +  /**                                                         
      104 +   * Check if this role can access flight logs                
      105 +   * @returns {boolean}                                       
      106 +   */                                                         
      107 +  canAccessFlightLogs() {                                     
      108 +    return this.isGlobalAdmin() || this.isStationAdmin() || th
          +is.isUAVPilot();                                              
      109 +  }                                                           
      110 +                                                              
      111 +  /**                                                         
      112 +   * Check if this role can create flight logs                
      113 +   * @returns {boolean}                                       
      114 +   */                                                         
      115 +  canCreateFlightLogs() {                                     
      116 +    return this.isGlobalAdmin() || this.isUAVPilot();         
      117 +  }                                                           
      118 +                                                              
      119 +  /**                                                         
      120     * Check if this role can edit station records
      121     * @returns {boolean}
      122     */
✔ Task #6 updated: status → completed
✔ Task #7 updated: status → in progress

● Write(src/handlers/magic-links.js)
  ⎿  Wrote 482 lines to src/handlers/magic-links.js
       1 /**
       2  * Magic Links Handler
       3  * Token-based authentication for station internal users
       4  *
       5  * Provides passwordless, time-limited access for internal stati
         on users
       6  * who need read-only access to station data.
       7  *
       8  * Architecture Credit: This subdomain-based architecture design
          is based on
       9  * architectural knowledge shared by Flights for Biodiversity Sw
         eden AB
      10  * (https://github.com/flightsforbiodiversity)
     … +472 lines (ctrl+o to expand)
✔ Task #7 updated: status → completed
✔ Task #8 updated: status → in progress

● Write(src/handlers/public.js)
  ⎿  Wrote 359 lines to src/handlers/public.js
       1 /**
       2  * Public API Handler
       3  * No-authentication endpoints for public dashboard and status
       4  *
       5  * Provides read-only access to station status, platform counts,
       6  * and system health without requiring authentication.
       7  *
       8  * Architecture Credit: This subdomain-based architecture design
          is based on
       9  * architectural knowledge shared by Flights for Biodiversity Sw
         eden AB
      10  * (https://github.com/flightsforbiodiversity)
     … +349 lines (ctrl+o to expand)
✔ Task #8 updated: status → completed
✔ Task #9 updated: status → in progress

● Bash(mkdir -p /lunarc/nobackup/projects/sitesspec/SITES/Spectral/apps/sites-sp
      ectral-manager/apps/webapp-instruments/src/domain/uav)
  ⎿  (No content)

● Write(src/domain/uav/Pilot.js)
  ⎿  Wrote 256 lines to src/domain/uav/Pilot.js
       1 /**
       2  * UAV Pilot Entity
       3  * Represents a certified UAV pilot with authorization to fly at
          SITES stations
       4  *
       5  * Architecture Credit: This subdomain-based architecture design
          is based on
       6  * architectural knowledge shared by Flights for Biodiversity Sw
         eden AB
       7  * (https://github.com/flightsforbiodiversity)
       8  *
       9  * @module domain/uav/Pilot
      10  * @version 15.0.0
     … +246 lines (ctrl+o to expand)

● Write(src/domain/uav/Mission.js)
  ⎿  Wrote 364 lines to src/domain/uav/Mission.js
       1 /**
       2  * UAV Mission Entity
       3  * Represents a planned or executed UAV data collection mission
       4  *
       5  * Architecture Credit: This subdomain-based architecture design
          is based on
       6  * architectural knowledge shared by Flights for Biodiversity Sw
         eden AB
       7  * (https://github.com/flightsforbiodiversity)
       8  *
       9  * @module domain/uav/Mission
      10  * @version 15.0.0
     … +354 lines (ctrl+o to expand)

● Write(src/domain/uav/FlightLog.js)
  ⎿  Wrote 282 lines to src/domain/uav/FlightLog.js
       1 /**
       2  * UAV Flight Log Entity
       3  * Represents an individual flight within a mission (each batter
         y swap = new flight)
       4  *
       5  * Architecture Credit: This subdomain-based architecture design
          is based on
       6  * architectural knowledge shared by Flights for Biodiversity Sw
         eden AB
       7  * (https://github.com/flightsforbiodiversity)
       8  *
       9  * @module domain/uav/FlightLog
      10  * @version 15.0.0
     … +272 lines (ctrl+o to expand)

● Write(src/domain/uav/index.js)
  ⎿  Wrote 15 lines to src/domain/uav/index.js
       1 /**
       2  * UAV Domain Module Exports
       3  *
       4  * Architecture Credit: This subdomain-based architecture design
          is based on
       5  * architectural knowledge shared by Flights for Biodiversity Sw
         eden AB
       6  * (https://github.com/flightsforbiodiversity)
       7  *
       8  * @module domain/uav
       9  * @version 15.0.0
      10  */
     … +5 lines (ctrl+o to expand)
✔ Task #9 updated: status → completed
✔ Task #10 updated: status → in progress

● Bash(mkdir -p /lunarc/nobackup/projects/sitesspec/SITES/Spectral/apps/sites-sp
      ectral-manager/apps/webapp-instruments/docs/architecture
      /lunarc/nobackup/projects/site…)
  ⎿  (No content)

● Write(docs/architecture/SUBDOMAIN_ARCHITECTURE.md)
  ⎿  Wrote 299 lines to docs/architecture/SUBDOMAIN_ARCHITECTURE.md
      1 # SITES Spectral Subdomain Architecture
      2 > **Architecture Credit**: This subdomain-based architecture desi
        gn is based on
      3 > architectural knowledge shared by **Flights for Biodiversity Sw
        eden AB**
      4 > (https://github.com/flightsforbiodiversity).
      5 ## Version History
      6 | Version | Date | Author | Description |
      7 |---------|------|--------|-------------|
     … +289 lines (ctrl+o to expand)

● Write(docs/security/CLOUDFLARE_ACCESS_INTEGRATION.md)
  ⎿  Wrote 253 lines to docs/security/CLOUDFLARE_ACCESS_INTEGRATION.md
      1 # Cloudflare Access Integration
      2 > **Architecture Credit**: This subdomain-based architecture desi
        gn is based on
      3 > architectural knowledge shared by **Flights for Biodiversity Sw
        eden AB**
      4 > (https://github.com/flightsforbiodiversity).
      5 ## Overview
      6 SITES Spectral uses Cloudflare Access for passwordless authentica
        tion via email OTP. This replaces the traditional username/passwo
        rd authentication for admin and station portals.
     … +243 lines (ctrl+o to expand)

● Write(docs/MAGIC_LINK_SYSTEM.md)
  ⎿  Wrote 276 lines to docs/MAGIC_LINK_SYSTEM.md
      1 # Magic Link System
      2 > **Architecture Credit**: This subdomain-based architecture desi
        gn is based on
      3 > architectural knowledge shared by **Flights for Biodiversity Sw
        eden AB**
      4 > (https://github.com/flightsforbiodiversity).
      5 ## Overview
      6 Magic links provide passwordless, time-limited access for station
         internal users who need read-only access to station data without
         requiring a full user account or Cloudflare Access.
     … +266 lines (ctrl+o to expand)

● Write(docs/UAV_PILOT_SYSTEM.md)
  ⎿  Wrote 353 lines to docs/UAV_PILOT_SYSTEM.md
      1 # UAV Pilot System
      2 > **Architecture Credit**: This subdomain-based architecture desi
        gn is based on
      3 > architectural knowledge shared by **Flights for Biodiversity Sw
        eden AB**
      4 > (https://github.com/flightsforbiodiversity).
      5 ## Overview
      6 The UAV Pilot System provides comprehensive management for UAV op
        erations at SITES Spectral stations, including pilot certificatio
        n tracking, mission planning, flight logging, and battery managem
        ent.
     … +343 lines (ctrl+o to expand)
✔ Task #10 updated: status → completed
✔ Task #11 updated: status → in progress

● Read(src/auth/authentication.js)
  ⎿  Read 444 lines

● Update(src/auth/authentication.js)
  ⎿  Added 6 lines, removed 1 line
       1  // Authentication Module
       2  // JWT authentication with HMAC-SHA256 signing, user verificati
          on, session management
       3 -// v12.0.8: Added rate limiting for brute force protection     
       3 +// v15.0.0: Added Cloudflare Access JWT verification for subdom
         +ain architecture                                               
       4 +//                                                             
       5 +// Architecture Credit: This subdomain-based architecture desig
         +n is based on                                                  
       6 +// architectural knowledge shared by Flights for Biodiversity S
         +weden AB                                                       
       7 +// (https://github.com/flightsforbiodiversity)                 
       8  
       9  import { SignJWT, jwtVerify } from 'jose';
      10  import { createErrorResponse, createUnauthorizedResponse } from
           '../utils/responses.js';
     ...
      16    recordAuthAttempt,
      17    getRateLimitHeaders
      18  } from '../middleware/auth-rate-limiter.js';
      19 +import { CloudflareAccessAdapter } from '../infrastructure/auth
         +/CloudflareAccessAdapter.js';                                  
      20  
      21  /**
      22   * Handle authentication endpoints

● Update(src/auth/authentication.js)
  ⎿  Added 74 lines, removed 3 lines
      293  
      294  /**
      295   * Extract and validate user from request
      296 - * Checks httpOnly cookie first, then falls back to Authorizat
          -ion header                                                    
      297 - * Uses proper JWT verification with HMAC-SHA256              
      296 + *                                                            
      297 + * Authentication priority (v15.0.0):                         
      298 + * 1. Cloudflare Access JWT (Cf-Access-Jwt-Assertion header)  
      299 + * 2. Request context (cfAccessUser set by worker)            
      300 + * 3. httpOnly cookie (legacy password auth)                  
      301 + * 4. Authorization header (legacy API access)                
      302 + *                                                            
      303   * @param {Request} request - The request object
      304   * @param {Object} env - Environment variables and bindings
      305   * @returns {Object|null} User object or null if invalid
      306   */
      307  export async function getUserFromRequest(request, env) {
      308    try {
      309 +    // Priority 1: Check for Cloudflare Access JWT (passwordle
          +ss auth)                                                      
      310 +    const cfAccessUser = await getUserFromCFAccess(request, en
          +v);                                                           
      311 +    if (cfAccessUser) {                                       
      312 +      return cfAccessUser;                                    
      313 +    }                                                         
      314 +                                                              
      315 +    // Priority 2: Check request context (set by worker subdom
          +ain routing)                                                  
      316 +    if (request.cfAccessUser) {                               
      317 +      return request.cfAccessUser;                            
      318 +    }                                                         
      319 +                                                              
      320 +    // Priority 3-4: Legacy authentication (cookie or Bearer t
          +oken)                                                         
      321 +    return await getUserFromLegacyAuth(request, env);         
      322 +                                                              
      323 +  } catch (error) {                                           
      324 +    console.error('Authentication error:', error);            
      325 +    return null;                                              
      326 +  }                                                           
      327 +}                                                             
      328 +                                                              
      329 +/**                                                           
      330 + * Get user from Cloudflare Access JWT                        
      331 + *                                                            
      332 + * @param {Request} request - The request object              
      333 + * @param {Object} env - Environment variables and bindings   
      334 + * @returns {Object|null} User object or null if not CF Access
          + auth                                                         
      335 + */                                                           
      336 +async function getUserFromCFAccess(request, env) {            
      337 +  try {                                                       
      338 +    // Check for CF Access JWT header                         
      339 +    const cfAccessJwt = request.headers.get('Cf-Access-Jwt-Ass
          +ertion');                                                     
      340 +    if (!cfAccessJwt) {                                       
      341 +      return null;                                            
      342 +    }                                                         
      343 +                                                              
      344 +    // Use CloudflareAccessAdapter to verify and map user     
      345 +    const cfAdapter = new CloudflareAccessAdapter(env);       
      346 +    const user = await cfAdapter.verifyAccessToken(request);  
      347 +                                                              
      348 +    if (user) {                                               
      349 +      // Add auth provider for tracking                       
      350 +      user.auth_provider = 'cloudflare_access';               
      351 +    }                                                         
      352 +                                                              
      353 +    return user;                                              
      354 +                                                              
      355 +  } catch (error) {                                           
      356 +    console.error('CF Access verification error:', error);    
      357 +    return null;                                              
      358 +  }                                                           
      359 +}                                                             
      360 +                                                              
      361 +/**                                                           
      362 + * Get user from legacy authentication (cookie or Bearer token
          +)                                                             
      363 + *                                                            
      364 + * @param {Request} request - The request object              
      365 + * @param {Object} env - Environment variables and bindings   
      366 + * @returns {Object|null} User object or null if invalid      
      367 + */                                                           
      368 +async function getUserFromLegacyAuth(request, env) {          
      369 +  try {                                                       
      370      // First, try to get token from httpOnly cookie (preferred
            method)
      371      let token = getTokenFromCookie(request);
      372  
     ...
      403        return null;
      404      }
      405  
      406 +    // Determine auth provider from payload                   
      407 +    const authProvider = payload.auth_provider || 'database'; 
      408 +                                                              
      409      // Token validated successfully
      410      return {
      411        username: payload.username,
     ...
      414        station_normalized_name: payload.station_normalized_name
           ,
      415        station_id: payload.station_id,
      416        edit_privileges: payload.edit_privileges,
      348 -      permissions: payload.permissions                        
      417 +      permissions: payload.permissions,                       
      418 +      auth_provider: authProvider,                            
      419 +      magic_link_id: payload.magic_link_id                    
      420      };
      421    } catch (error) {
      422      // Handle specific JWT errors

● Update(src/auth/authentication.js)
  ⎿  Added 2 lines
      223        'sites-admin': ['read', 'write', 'edit', 'delete', 'admi
           n'],
      224        'station-admin': ['read', 'write', 'edit', 'delete'],
      225        'station': ['read'],
      226 +      'uav-pilot': ['read', 'flight-log'],                    
      227 +      'station-internal': ['read'],                           
      228        'readonly': ['read']
      229      };
      230  
✔ Task #11 updated: status → completed
11 tasks (11 done, 0 open)

✔ #11 Update authentication.js for dual-auth
✔ #10 Create architecture documentation
✔ #6 Add UAV pilot role to Role.js
✔ #1 Create database migration for subdomain auth and UAV
✔ #7 Create magic links handler
✔ #2 Create Cloudflare Access adapter
✔ #8 Create public API endpoints
✔ #3 Update worker.js for subdomain routing
✔ #9 Create UAV domain entities
✔ #4 Update CORS for subdomains
✔ #5 Update wrangler.toml for wildcard routes

● All 11 tasks completed. Now let me update the package.json version and
  CHANGELOG.

● Update(package.json)
  ⎿  Added 2 lines, removed 2 lines
      1  {
      2    "name": "sites-spectral-stations-instruments",
      3 -  "version": "14.2.0",                                          
      4 -  "description": "SITES Spectral v14.2.0 - Stations & Instrument
        -s Registry",                                                    
      3 +  "version": "15.0.0",                                          
      4 +  "description": "SITES Spectral v15.0.0 - Subdomain Architectur
        +e with Cloudflare Access",                                      
      5    "main": "src/worker.js",
      6    "scripts": {
      7      "dev": "wrangler dev --local --persist-to=.wrangler/state",

● Search(pattern: "CHANGELOG.md", path: "/lunarc/nobackup/projects/sitesspec/SIT
        ES/Spectral/apps/sites-spectral-manager/apps/webapp-instruments")
  ⎿  Found 20 files (ctrl+o to expand)

● Read(CHANGELOG.md)
  ⎿  Read 100 lines

● Update(CHANGELOG.md)
  ⎿  Added 85 lines
       13  
       14  ---
       15  
       16 +## [15.0.0] - 2026-01-24                                      
       17 +                                                              
       18 +### Feature: Subdomain Architecture with Cloudflare Access    
       19 +                                                              
       20 +> **Architecture Credit**: This subdomain-based architecture d
          +esign is based on                                             
       21 +> architectural knowledge shared by **Flights for Biodiversity
          + Sweden AB**                                                  
       22 +> (https://github.com/flightsforbiodiversity).                
       23 +                                                              
       24 +Migration from single-domain to subdomain-based architecture w
          +ith Cloudflare Access authentication.                         
       25 +                                                              
       26 +#### Portal Architecture                                      
       27 +                                                              
       28 +| Portal | Domain | Authentication | Purpose |                
       29 +|--------|--------|----------------|---------|                
       30 +| **Public** | `sitesspectral.work` | None | Public dashboard,
          + status |                                                     
       31 +| **Admin** | `admin.sitesspectral.work` | CF Access OTP | Glo
          +bal admin access |                                            
       32 +| **Station** | `{station}.sitesspectral.work` | CF Access / M
          +agic Link | Station-specific access |                         
       33 +                                                              
       34 +#### New Authentication Methods                               
       35 +                                                              
       36 +- **Cloudflare Access JWT**: Passwordless authentication via e
          +mail OTP                                                      
       37 +- **Magic Links**: Time-limited, single-use tokens for station
          + internal users                                               
       38 +- **Dual-Auth Support**: CF Access takes priority, falls back 
          +to legacy httpOnly cookies                                    
       39 +                                                              
       40 +#### New User Roles                                           
       41 +                                                              
       42 +| Role | Permissions | Use Case |                             
       43 +|------|-------------|----------|                             
       44 +| `uav-pilot` | read, flight-log | UAV operators with mission 
          +logging |                                                     
       45 +| `station-internal` | read | Internal users via magic link | 
       46 +                                                              
       47 +#### UAV Management System                                    
       48 +                                                              
       49 +- **Pilot Registry**: Track certifications, insurance, authori
          +zed stations                                                  
       50 +- **Mission Planning**: Plan, approve, and execute UAV mission
          +s                                                             
       51 +- **Flight Logging**: Record individual flights with telemetry
          + data                                                         
       52 +- **Battery Tracking**: Manage battery inventory and health   
       53 +                                                              
       54 +#### New Files                                                
       55 +                                                              
       56 +| File | Purpose |                                            
       57 +|------|---------|                                            
       58 +| `src/infrastructure/auth/CloudflareAccessAdapter.js` | CF Ac
          +cess JWT verification |                                       
       59 +| `src/handlers/magic-links.js` | Magic link CRUD operations |
       60 +| `src/handlers/public.js` | Public API endpoints (no auth) | 
       61 +| `src/domain/uav/Pilot.js` | UAV pilot entity |              
       62 +| `src/domain/uav/Mission.js` | Mission planning entity |     
       63 +| `src/domain/uav/FlightLog.js` | Flight log entity |         
       64 +| `migrations/0045_subdomain_auth_uav_missions.sql` | Schema c
          +hanges |                                                      
       65 +                                                              
       66 +#### Modified Files                                           
       67 +                                                              
       68 +| File | Changes |                                            
       69 +|------|---------|                                            
       70 +| `src/worker.js` | Subdomain detection and portal routing |  
       71 +| `src/auth/authentication.js` | Dual-auth with CF Access prio
          +rity |                                                        
       72 +| `src/domain/authorization/Role.js` | Added `uav-pilot`, `sta
          +tion-internal` roles |                                        
       73 +| `src/config/allowed-origins.js` | Dynamic subdomain CORS sup
          +port |                                                        
       74 +| `wrangler.toml` | Wildcard subdomain routes |               
       75 +                                                              
       76 +#### Documentation                                            
       77 +                                                              
       78 +- `docs/architecture/SUBDOMAIN_ARCHITECTURE.md` - Architecture
          + overview                                                     
       79 +- `docs/security/CLOUDFLARE_ACCESS_INTEGRATION.md` - CF Access
          + setup                                                        
       80 +- `docs/MAGIC_LINK_SYSTEM.md` - Magic link implementation     
       81 +- `docs/UAV_PILOT_SYSTEM.md` - UAV pilot and mission managemen
          +t                                                             
       82 +                                                              
       83 +#### Database Migration (0045)                                
       84 +                                                              
       85 +New tables:                                                   
       86 +- `magic_link_tokens` - Token storage and lifecycle           
       87 +- `uav_pilots` - Pilot registry with certifications           
       88 +- `uav_missions` - Mission planning and execution             
       89 +- `mission_pilots` - Pilot-mission assignments                
       90 +- `uav_flight_logs` - Individual flight records               
       91 +- `uav_batteries` - Battery inventory                         
       92 +                                                              
       93 +New columns on `users`:                                       
       94 +- `auth_provider` - 'database', 'cloudflare_access', or 'magic
          +_link'                                                        
       95 +- `cf_access_email` - Email from CF Access identity           
       96 +- `cf_access_identity_id` - CF Access subject ID              
       97 +- `last_cf_access_login` - Last CF Access login timestamp     
       98 +                                                              
       99 +---                                                           
      100 +                                                              
      101  ## [14.2.0] - 2026-01-24
      102  
      103  ### Feature: New Production Domain & Database Authentication

● Read(CLAUDE.md)
  ⎿  Read 100 lines

● Update(CLAUDE.md)
  ⎿  Added 36 lines, removed 5 lines
       60  
       61  ---
       62  
       63 -## Current Version: 14.1.0 - Alnarp & Hyltemossa Stations (202
          -6-01-23)                                                      
       63 +## Current Version: 15.0.0 - Subdomain Architecture with Cloud
          +flare Access (2026-01-24)                                     
       64  
       65 +> **Architecture Credit**: This subdomain-based architecture d
          +esign is based on                                             
       66 +> architectural knowledge shared by **Flights for Biodiversity
          + Sweden AB**                                                  
       67 +> (https://github.com/flightsforbiodiversity).                
       68 +                                                              
       69  **✅ STATUS: PRODUCTION READY**
       66 -**🌐 Production URL:** https://sites.jobelab.com              
       67 -**🔗 Worker URL:** https://sites-spectral-instruments.jose-e5f
          -.workers.dev                                                  
       68 -**📅 Last Updated:** 2026-01-23                               
       70 +**🌐 Public Portal:** https://sitesspectral.work              
       71 +**🔐 Admin Portal:** https://admin.sitesspectral.work         
       72 +**📍 Station Portals:** https://{station}.sitesspectral.work  
       73 +**🔗 Worker URL:** https://sites-spectral-instruments.jose-bel
          +tran.workers.dev                                              
       74 +**📅 Last Updated:** 2026-01-24                               
       75  **🚀 API Version:** V11 (via `/api/latest` alias)
       70 -**🔒 Security Features:** CORS Whitelist, PBKDF2 Password Hash
          -ing, httpOnly Cookies, CSRF Protection, Input Sanitization, JW
          -T HMAC-SHA256, XSS-Safe DOM Methods                           
       76 +**🔒 Auth Methods:** Cloudflare Access OTP, Magic Links, httpO
          +nly Cookies                                                   
       77  **♿ Accessibility:** WCAG 2.4.3 Modal Focus Trap
       78  **📚 Standard Vocabularies:** Darwin Core, ICOS, Copernicus al
           igned
       79  **🧪 Test Coverage:** 653 tests across 36 test files
       80  **📍 Stations:** 9 SITES member stations (7 original + ALN, HY
           L)
       81  
       82 +### What's New in v15.0.0                                     
       83 +                                                              
       84 +**Subdomain-Based Portal Architecture** - Migration from singl
          +e-domain to subdomain-based architecture with Cloudflare Acces
          +s authentication:                                             
       85 +                                                              
       86 +| Portal | Domain | Authentication |                          
       87 +|--------|--------|----------------|                          
       88 +| Public | `sitesspectral.work` | None (public dashboard) |   
       89 +| Admin | `admin.sitesspectral.work` | CF Access OTP |        
       90 +| Station | `{station}.sitesspectral.work` | CF Access / Magic
          + Link |                                                       
       91 +                                                              
       92 +**New Authentication Methods:**                               
       93 +- **Cloudflare Access JWT**: Passwordless email OTP           
       94 +- **Magic Links**: Time-limited tokens for internal users     
       95 +- **Dual-Auth**: CF Access priority, falls back to legacy cook
          +ies                                                           
       96 +                                                              
       97 +**New Roles:**                                                
       98 +- `uav-pilot` - UAV operators with mission/flight logging     
       99 +- `station-internal` - Internal read-only via magic link      
      100 +                                                              
      101 +**UAV Management System:**                                    
      102 +- Pilot registry with certifications                          
      103 +- Mission planning and execution                              
      104 +- Flight logging with telemetry                               
      105 +- Battery inventory tracking                                  
      106 +                                                              
      107  ### What's New in v14.1.0
      108  
      109  **Alnarp & Hyltemossa Stations with Management Tracking** - Ad
           ded two new SITES stations with enhanced platform management t
           racking:

● Implementation complete. Here's a summary of all changes made:

  Summary - SITES Spectral v15.0.0 Subdomain Architecture

  New Files Created
  File: migrations/0045_subdomain_auth_uav_missions.sql
  Purpose: Database schema for auth, magic links, UAV system
  ────────────────────────────────────────
  File: src/infrastructure/auth/CloudflareAccessAdapter.js
  Purpose: CF Access JWT verification adapter
  ────────────────────────────────────────
  File: src/infrastructure/auth/index.js
  Purpose: Module exports
  ────────────────────────────────────────
  File: src/handlers/magic-links.js
  Purpose: Magic link CRUD endpoints
  ────────────────────────────────────────
  File: src/handlers/public.js
  Purpose: Public API endpoints (no auth)
  ────────────────────────────────────────
  File: src/domain/uav/Pilot.js
  Purpose: UAV pilot entity
  ────────────────────────────────────────
  File: src/domain/uav/Mission.js
  Purpose: UAV mission entity
  ────────────────────────────────────────
  File: src/domain/uav/FlightLog.js
  Purpose: UAV flight log entity
  ────────────────────────────────────────
  File: src/domain/uav/index.js
  Purpose: UAV module exports
  ────────────────────────────────────────
  File: docs/architecture/SUBDOMAIN_ARCHITECTURE.md
  Purpose: Architecture overview
  ────────────────────────────────────────
  File: docs/security/CLOUDFLARE_ACCESS_INTEGRATION.md
  Purpose: CF Access setup guide
  ────────────────────────────────────────
  File: docs/MAGIC_LINK_SYSTEM.md
  Purpose: Magic link documentation
  ────────────────────────────────────────
  File: docs/UAV_PILOT_SYSTEM.md
  Purpose: UAV system documentation
  Modified Files
  File: src/worker.js
  Changes: Added subdomain detection, portal routing, CF Access integration
  ────────────────────────────────────────
  File: src/auth/authentication.js
  Changes: Dual-auth support (CF Access priority, legacy fallback)
  ────────────────────────────────────────
  File: src/domain/authorization/Role.js
  Changes: Added uav-pilot, station-internal roles
  ────────────────────────────────────────
  File: src/config/allowed-origins.js
  Changes: Dynamic subdomain CORS support
  ────────────────────────────────────────
  File: wrangler.toml
  Changes: Wildcard subdomain routes, updated version
  ────────────────────────────────────────
  File: package.json
  Changes: Updated to v15.0.0
  ────────────────────────────────────────
  File: CHANGELOG.md
  Changes: Added v15.0.0 entry
  ────────────────────────────────────────
  File: CLAUDE.md
  Changes: Updated current version section
  Key Features

  1. Three Portal Types:
    - Public: sitesspectral.work - No auth, public dashboard
    - Admin: admin.sitesspectral.work - CF Access for global admins
    - Station: {station}.sitesspectral.work - CF Access or magic links
  2. Authentication Priority:
    - Cloudflare Access JWT (primary)
    - Request context (from worker routing)
    - httpOnly cookie (legacy)
    - Bearer token (API access)
  3. UAV Management: Complete system for pilot registration, mission planning,
  flight logging, and battery tracking
  4. Magic Links: Secure, time-limited tokens for internal station access

  Next Steps (Manual Configuration)

  1. DNS Setup: Add wildcard CNAME records in Cloudflare
  2. CF Access Apps: Create admin and station wildcard applications
  3. Database Migration: Run npm run db:migrate to apply migration 0045
  4. User Setup: Register users with cf_access_email for passwordless auth

✻ Worked for 15m 58s

❯ please show me briefly how to set those manually 

● Manual Configuration Steps

  1. DNS Setup (Cloudflare Dashboard)

  Dashboard → DNS → Records → Add Record

  Type: CNAME | Name: admin | Target:
  sites-spectral-instruments.jose-beltran.workers.dev | Proxied: Yes
  Type: CNAME | Name: *     | Target:
  sites-spectral-instruments.jose-beltran.workers.dev | Proxied: Yes

  Note: Wildcard CNAME requires Cloudflare Pro for SSL. Alternative: create 
  individual CNAMEs for each station (svartberget, abisko, lonnstorp, etc.)

  2. Cloudflare Access Applications

  Zero Trust Dashboard → Access → Applications → Add Application → Self-hosted

  # App 1: Admin Portal
  Name: SITES Spectral Admin Portal
  Domain: admin.sitesspectral.work
  Session Duration: 24 hours

  Policy: Allow Global Admins
    - Include → Emails: jose.beltran@mgeo.lu.se
    - Include → Emails: lars.eklundh@nateko.lu.se

  # App 2: Station Portals
  Name: SITES Spectral Station Portals
  Domain: *.sitesspectral.work
  Session Duration: 24 hours

  Policy: Allow Station Users
    - Include → Emails ending in: @slu.se
    - Include → Emails ending in: @nateko.lu.se
    - Include → Emails ending in: @mgeo.lu.se

  Bypass Rule (for public assets):
    - Path starts with: /api/public/
    - Path starts with: /css/
    - Path starts with: /js/

  3. Database Migration

  cd /lunarc/nobackup/projects/sitesspec/SITES/Spectral/apps/sites-spectral-mana
  ger/apps/webapp-instruments

  # Apply migration to remote D1
  npm run db:migrate

  4. Register CF Access Users

  # Via wrangler d1 execute
  npx wrangler d1 execute spectral_stations_db --remote --command="
  INSERT INTO users (username, email, role, station_id, auth_provider, 
  cf_access_email, active)
  VALUES 
    ('svb-admin', 'user@slu.se', 'station-admin', 7, 'cloudflare_access', 
  'user@slu.se', 1);
  "

  5. Set CF Access AUD (Optional but recommended)

  # Get AUD from CF Access Application details, then:
  npx wrangler secret put CF_ACCESS_AUD
  # Paste the Application Audience value

  6. Deploy

  npm run deploy

  Verification

  # Test public portal (should work without auth)
  curl https://sitesspectral.work/api/public/health

  # Test admin portal (should require CF Access)
  curl https://admin.sitesspectral.work/api/health
  # Expected: 401 or redirect to CF Access login

  # Test station portal
  curl https://svartberget.sitesspectral.work/api/health
  # Expected: 401 or redirect to CF Access login

❯ can I use as target the domain and not the worker? 

● No, you can't CNAME a subdomain to the apex domain within the same zone. But
  since you're using Cloudflare Workers with routes, you can use a placeholder A
   record instead:

  Dashboard → DNS → Records → Add Record

  Type: A | Name: admin | Content: 192.0.2.1 | Proxied: Yes (orange cloud)
  Type: A | Name: *     | Content: 192.0.2.1 | Proxied: Yes (orange cloud)

  The IP 192.0.2.1 is a documentation IP that goes nowhere, but it doesn't
  matter because:

  1. The orange cloud (Proxied) means traffic goes through Cloudflare
  2. Your Worker routes in wrangler.toml catch *.sitesspectral.work/*
  3. Cloudflare routes the request to your Worker, not the IP

  This is actually the standard pattern when using Workers with custom domains -
   the DNS target is just a placeholder to enable the proxy.

  Alternative: Individual A Records

  If wildcard doesn't work on your plan:

  Type: A | Name: admin       | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: svartberget | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: abisko      | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: lonnstorp   | Content: 192.0.2.1 | Proxied: Yes
  ... (one per station)

❯ give me all the normalized names of the stations for the Type A records   
  to be produced                                                            

● Here are all station subdomains for the A records:

  # Primary station names (recommended)
  Type: A | Name: admin       | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: abisko      | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: asa         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: bolmen      | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: erken       | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: grimso      | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: lonnstorp   | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: robacksdalen| Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: skogaryd    | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: svartberget | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: alnarp      | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: hyltemossa  | Content: 192.0.2.1 | Proxied: Yes

  # Short acronyms (optional aliases)
  Type: A | Name: ans         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: gri         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: lon         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: rob         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: sko         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: svb         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: aln         | Content: 192.0.2.1 | Proxied: Yes
  Type: A | Name: hyl         | Content: 192.0.2.1 | Proxied: Yes

  Summary: 21 total records (1 admin + 12 primary stations + 8 acronym aliases)

  Or if you just want the essentials (admin + primary names only): 13 records
