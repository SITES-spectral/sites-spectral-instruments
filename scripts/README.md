# SITES Spectral - Production Data Sync Scripts

This directory contains scripts to synchronize production data from the Cloudflare D1 database to generate updated `stations.yaml` files.

## Overview

The production database hosted on Cloudflare contains the live, user-updated data for all SITES Spectral stations, platforms, instruments, ROIs, and maintenance logs. These scripts allow you to fetch this data and generate properly formatted YAML files that match the original `stations.yaml` schema.

## Files

### 1. `fetch_production_data_api.py`
Python script that:
- Connects to Cloudflare D1 database via REST API
- Fetches all stations, platforms, instruments, ROIs, and maintenance data
- Maps database schema to `stations.yaml` structure
- Generates timestamped YAML files with all production updates
- **Includes maintenance parameters** for all instruments

### 2. `sync_production_yaml.sh`
Bash script that automates the entire sync process:
- Checks for Cloudflare API credentials
- Installs Python dependencies if needed
- Runs the fetch script
- Creates timestamped output files
- Reports success/failure status

## Setup

### Prerequisites

1. **Cloudflare API Token** with D1 read permissions
2. **Python 3.6+** with `requests` and `pyyaml` packages
3. **Bash shell** (Linux/macOS)

### Installation

1. Install Python dependencies:
   ```bash
   pip install requests pyyaml
   ```

2. Set up Cloudflare API token (choose one method):

   **Method A: Environment Variable**
   ```bash
   export CLOUDFLARE_API_TOKEN="your-token-here"
   ```

   **Method B: .env File**
   Create `.env` in project root:
   ```bash
   CLOUDFLARE_API_TOKEN=your-token-here
   ```

   **Method C: .secure/.env File**
   Create `.secure/.env` in project:
   ```bash
   CLOUDFLARE_API_TOKEN=your-token-here
   ```

## Usage

### Quick Sync (Recommended)

Simply run the sync script:

```bash
./scripts/sync_production_yaml.sh
```

This will:
- Fetch all production data from Cloudflare D1
- Generate timestamped YAML file: `yamls/stations_production_YYYYMMDD_HHMMSS.yaml`
- Update latest symlink: `yamls/stations_latest_production.yaml`
- Display summary and recent files

### Manual Python Script

Alternatively, run the Python script directly:

```bash
export CLOUDFLARE_API_TOKEN="your-token-here"
python3 scripts/fetch_production_data_api.py
```

## Output Files

### Generated Files

All files are saved to the `yamls/` directory:

```
yamls/
├── stations_production_20251002_143522.yaml  # Timestamped production data
├── stations_production_20251001_094433.yaml  # Previous sync
├── stations_latest_production.yaml           # Always latest version
└── ... (historical syncs)
```

### File Format

The generated YAML files follow the exact structure of the original `stations.yaml`:

```yaml
# YAML 1.1
# Last updated: 2025-10-02
# Generated by SITES Spectral @ Lunds University
# Version: 2025.10.2.1 - Synced from production Cloudflare D1 database

stations:
  abisko:
    id: ANS
    normalized_name: abisko
    display_name: Abisko
    platforms:
      ANS_FOR_BL01:
        instruments:
          phenocams:
            ANS_FOR_BL01_PHE01:
              maintenance:  # NEW: Production maintenance data
                calibration_date: "2025-05-15"
                power_source: "Solar+Battery"
                data_transmission: "LoRaWAN"
                ...
```

## What's New in Production Data

The synced YAML files include **additional fields** not present in the original `stations.yaml`:

### Station Updates
- Real-time status changes made by station managers
- Updated coordinates and elevation data
- Current station descriptions

### Platform Updates
- Operation programs (research affiliations)
- Deployment dates
- Platform status updates
- Refined geolocation data

### Instrument Updates
- **Maintenance parameters** (new):
  - `calibration_date` - Last calibration date
  - `calibration_notes` - Calibration details
  - `warranty_expires` - Warranty expiration date
  - `power_source` - Power supply type
  - `data_transmission` - Transmission method
  - `last_image_timestamp` - Latest image capture
  - `image_quality_score` - Image quality metrics
  - `image_processing_enabled` - Processing status
  - `image_archive_path` - Archive location
- Updated camera specifications
- Current measurement status
- Refined viewing angles and coordinates

### ROI Updates
- User-modified ROI polygons
- Processing status and timestamps
- Vegetation masks
- Updated descriptions and comments

## Database Schema Mapping

The scripts use the comprehensive mapping documented in `YAML_to_Database_Mapping.md`:

| YAML Structure | Database Tables |
|----------------|-----------------|
| `stations` | `stations` table |
| `platforms` | `platforms` table |
| `instruments` | `instruments` table |
| `rois` | `instrument_rois` table |
| `maintenance` | `instruments` table (new fields) |

## Automation

### Cron Job Setup

To automatically sync production data daily:

1. Edit crontab:
   ```bash
   crontab -e
   ```

2. Add daily sync at 2 AM:
   ```cron
   0 2 * * * cd /path/to/sites-spectral-instruments && ./scripts/sync_production_yaml.sh >> logs/sync.log 2>&1
   ```

3. Or weekly on Sunday at 3 AM:
   ```cron
   0 3 * * 0 cd /path/to/sites-spectral-instruments && ./scripts/sync_production_yaml.sh >> logs/sync.log 2>&1
   ```

### Git Integration

To automatically commit synced YAML files:

```bash
#!/bin/bash
cd /path/to/sites-spectral-instruments
./scripts/sync_production_yaml.sh

if [ $? -eq 0 ]; then
    git add yamls/stations_latest_production.yaml
    git commit -m "chore: sync production YAML $(date +%Y-%m-%d)"
    git push
fi
```

## Troubleshooting

### API Token Issues

**Error: "CLOUDFLARE_API_TOKEN environment variable not set!"**

Solution: Set your API token using one of the methods in Setup section.

**Error: "API Error: 401"**

Solution: Your API token is invalid or expired. Generate a new token from Cloudflare dashboard.

### Python Dependencies

**Error: "No module named 'requests'"**

Solution: Install dependencies:
```bash
pip install requests pyyaml
```

Or use the script which auto-installs:
```bash
./scripts/sync_production_yaml.sh
```

### Empty Output

**Issue: "No stations found in database!"**

Possible causes:
1. Database ID is incorrect (check `ACCOUNT_ID` and `DATABASE_ID` in script)
2. API token lacks D1 read permissions
3. Network connectivity issues

Solution: Verify credentials and database access.

## Security Notes

- **Never commit API tokens** to version control
- Store tokens in `.env` files (excluded by `.gitignore`)
- Use environment variables for production deployments
- Limit API token permissions to D1 read-only access

## Support

For issues or questions:
1. Check `YAML_to_Database_Mapping.md` for schema details
2. Review database migrations in `migrations/` directory
3. Contact SITES Spectral team

## Version History

- **v1.0.0** (2025-10-02): Initial release
  - Cloudflare D1 API integration
  - Complete database schema mapping
  - Maintenance parameters support
  - Automated sync script
  - Timestamped output files
